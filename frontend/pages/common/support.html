<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title-head">Support Page - Sahatak</title>
    
   <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='%230d47a1' d='m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523.942-.661 2.27.067 3.71L8 15.5l6.533-8.737c.728-1.44.59-2.768.067-3.71C13.486.878 10.4.28 8.717 2.01L8 2.748z'/></svg>">
    
    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <!-- Bootstrap Icons CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Arabic Font - Noto Sans Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Main CSS -->
    <link rel="stylesheet" href="../../assets/css/main.css">
    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="../../assets/css/components/dashboard.css">
    <!-- Appointments CSS -->
    <link rel="stylesheet" href="../../assets/css/components/appointments.css">
    <!-- Video Consultation Dashboard CSS -->
    <link rel="stylesheet" href="../../assets/css/components/video-consultation-dashboard.css">
    <style>
        /* Unverified doctor states */
        .unverified-disabled {
            opacity: 0.5;
            cursor: not-allowed !important;
            pointer-events: none;
        }
        
        .verification-overlay {
            position: relative;
        }
        
        .verification-overlay::after {
            content: "ðŸ”’ Verification Required";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #dc3545;
            border: 1px solid #dc3545;
            z-index: 10;
            display: none;
        }
        
        .unverified-disabled.verification-overlay::after {
            display: block;
        }
        
        .verification-notice {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .verification-notice .notice-icon {
            color: #856404;
            font-size: 24px;
        }
        
        /* Video consultation button styling */
        .btn-complete-consultation {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-complete-consultation:hover {
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .btn-consultation-ended {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        /* Animation for removing appointments */
        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.95);
            }
        }
        
        /* Pagination Styles */
        .pagination-controls {
            font-size: 14px;
        }
        
        .pagination-controls .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.25rem;
            transition: all 0.15s ease-in-out;
        }
        
        .pagination-controls .btn-outline-secondary:hover:not(:disabled) {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        
        .pagination-controls .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-controls .d-flex.gap-1 > .btn {
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pagination-controls .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        
        .pagination-controls .btn-primary:hover {
            background-color: #0056b3;
            border-color: #004085;
        }
        
        /* Page info styling */
        #activity-page-info, #appointments-page-info {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* Responsive pagination */
        @media (max-width: 768px) {
            .pagination-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .pagination-controls .d-flex:first-child,
            .pagination-controls .d-flex:last-child {
                justify-content: center;
            }
            
            #activity-page-info, #appointments-page-info {
                text-align: center;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body data-protect="patient">
    <div class="dashboard-container">
        <div class="container-fluid" style="padding-bottom: 120px;">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="row align-items-center">
                    <!-- Profile Section - Left (Right in RTL) -->
                    <div class="col-lg-4">
                        <div class="profile-section">
                            <div class="user-avatar">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            <div class="user-details">
                                <h5 class="mb-1" id="user-name">Loading...</h5>
                            </div>
                            <!-- Vertical Action Buttons -->
                            <div class="action-buttons">
                                <button class="btn btn-action" onclick="goBackToDashboard()" title="Back to Dashboard">
                                    <i class="bi bi-arrow-left"></i>
                                    <span id="btn-back">Back to Dashboard</span>
                                </button>
                                <button class="btn btn-action btn-logout" onclick="AuthGuard.logout()" title="Logout">
                                    <i class="bi bi-box-arrow-right"></i>
                                    <span id="btn-logout">Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Page Title - Center -->
                    <div class="col-lg-4 text-center">
                        <h1 class="dashboard-title" id="page-title">Support Sahatak</h1>
                        <p class="dashboard-subtitle" id="page-subtitle">Technical Support</p>
                    </div>
                    
                    <!-- Controls - Right (Left in RTL) -->
                     <style>
                    /* light blue background for the services area, cards stay visually on top */
                    #services-section {
                        background-color: #e6f7ff; /* light blue */
                        padding: 1.5rem;
                        border-radius: 0.6rem;
                    }

                    /* ensure cards render above the background (so background never covers them) */
                    #services-section .card {
                        position: relative;
                        z-index: 1;
                        background-color: #fff; /* reinforce white card background */
                    }

                    /* give some extra spacing so the background doesn't touch viewport edges */
                    @media (min-width: 992px) {
                        #services-section { padding-left: 2rem; padding-right: 2rem; }
                    }
                </style>
            <!-- Support & Supervisor Messaging -->
            <section id="support-section" class="mt-4">
                <div class="row gy-4">
                    <!-- Report a Problem Card -->
                        <style>
                        /* make all cards in the support section have a light-blue background,
                            and ensure form fields inside those cards are white */
                        #support-section .card {
                          background-color: #e6f7ff;
                          border: 1px solid rgba(13,47,93,0.06);
                          box-shadow: 0 1px 2px rgba(13,47,93,0.04);
                        }

                        #support-section .card .card-body {
                          background: transparent;
                        }

                        /* form controls inside cards should be white for contrast */
                        #support-section .card .form-control,
                        #support-section .card .form-select,
                        #support-section .card textarea,
                        #support-section .card input[type="text"],
                        #support-section .card input[type="tel"],
                        #support-section .card input[type="file"] {
                          background-color: #ffffff;
                          border: 1px solid #dfe7ef;
                          box-shadow: none;
                        }

                        /* keep placeholder/text color readable */
                        #support-section .card .form-control::placeholder,
                        #support-section .card textarea::placeholder {
                          color: #6c757d;
                        }
                        </style>
                    <div class="col-lg-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-bug-fill me-2"></i>Report a Problem</h5>
                                <p class="text-muted small">Tell us about any issues you face while using the app. Our support team will review and respond.</p>

                                <div id="report-alert" class="alert d-none" role="alert"></div>

                                <form id="report-form" novalidate>
                                    <div class="mb-3">
                                        <label for="problem-subject" class="form-label">Subject</label>
                                        <input type="text" id="problem-subject" name="subject" class="form-control" required maxlength="120" placeholder="Short summary of the issue">
                                    </div>

                                    <div class="mb-3">
                                        <label for="problem-description" class="form-label">Description</label>
                                        <textarea id="problem-description" name="description" class="form-control" rows="6" required placeholder="Describe the steps to reproduce the issue, expected vs actual behavior, and any error messages."></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label for="problem-screenshot" class="form-label">Attachment (optional)</label>
                                        <input id="problem-screenshot" name="attachment" type="file" class="form-control" accept="image/*,.log,.txt,.pdf">
                                        <div class="form-text">Attach screenshots, logs, or a short recording (max 10MB).</div>
                                    </div>

                                    <div class="d-flex justify-content-end">
                                        <button type="submit" class="btn btn-medical">
                                            <i class="bi bi-send-fill me-1"></i> Send Report
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Message Supervisors Card -->
                    <div class="col-lg-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title"><i class="bi bi-envelope-fill me-2"></i>Message To Technical Support</h5>
                                <p class="text-muted small">Send a direct message to program supervisors for feedback, escalations or private concerns.</p>

                                <div id="supervisor-alert" class="alert d-none" role="alert"></div>
                                <form id="supervisor-form" novalidate>
                                    <div class="mb-3">
                                        <label for="supervisor-to" class="form-label">To (Supervisor)</label>
                                        <select id="supervisor-to" name="to" class="form-select" required>
                                            <option value="">Select a recipient</option>
                                            <option value="lead">Lead Supervisor</option>
                                            <option value="ops">Operations Manager</option>
                                            <option value="tech">Technical Supervisor</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label for="supervisor-subject" class="form-label">Subject</label>
                                        <input id="supervisor-subject" name="subject" type="text" class="form-control" required maxlength="120" placeholder="Brief subject">
                                    </div>

                                    <div class="mb-3">
                                        <label for="supervisor-message" class="form-label">Message</label>
                                        <textarea id="supervisor-message" name="message" class="form-control" rows="6" required placeholder="Write your message to the supervisors..."></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label for="supervisor-phone" class="form-label">Contact (optional)</label>
                                        <input id="supervisor-phone" name="contact" type="tel" class="form-control" placeholder="Phone or email for a reply">
                                    </div>

                                    <div class="d-flex justify-content-end">
                                        <button type="submit" class="btn btn-outline-medical">
                                            <i class="bi bi-chat-dots me-1"></i> Send Message
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Footer -->

        <footer class="footer mt-auto py-3">
        <div class="container">
            <div class="row g-3">
                <!-- Brand & Description -->
                <div class="col-lg-4 col-md-6">
                    <h5 class="mb-3">
                        <i class="bi bi-heart-pulse me-2 text-primary"></i>
                        <span id="footer-brand">Sahatak</span>
                    </h5>
                    <div class="d-flex gap-3 social-links">
                        <a href="https://facebook.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-facebook fs-5"></i></a>
                        <a href="https://twitter.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-twitter fs-5"></i></a>
                        <a href="https://instagram.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-instagram fs-5"></i></a>
                        <a href="https://linkedin.com/company/sahatak" target="_blank" rel="noopener"><i class="bi bi-linkedin fs-5"></i></a>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="col-lg-2 col-md-6">
                    <h6 class="mb-3" id="footer-links-title">Quick Links</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../common/about.html" class="text-muted text-decoration-none" id="footer-about">About Platform</a>
                        </li>
                        <li class="mb-2">
                            <a href="../common/services.html" class="text-muted text-decoration-none" id="footer-services">Services</a>
                        </li>
                    </ul>
                </div>

                <!-- Support -->
                <div class="col-lg-3 col-md-6">
                    <h6 class="mb-3" id="footer-support-title">Support & Help</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../common/support.html" class="text-muted text-decoration-none" id="footer-help">Help Center</a>
                        </li>
                        <li class="mb-2">
                            <a href="../common/contact-us.html" class="text-muted text-decoration-none" id="footer-contact">Contact Us</a>
                        </li>
                    </ul>
                </div>

                <!-- Emergency Contact -->
                <div class="col-lg-3 col-md-6 emergency-section">
                    <p class="mb-2 text-danger fw-bold" id="footer-emergency-text">
                        For medical emergencies
                    </p>
                    <p class="mb-3 text-danger fw-bold fs-6" id="footer-emergency-action">
                        <i class="bi bi-hospital me-2"></i>
                        Go to nearest ER hospital
                    </p>
                    <p class="mb-0 text-muted small" id="footer-emergency-note">
                        For non-urgent consultations use the platform
                    </p>
                </div>
            </div>

            <!-- Bottom Bar -->
            <hr class="my-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0 fw-bold" id="footer-copyright">
                        Â© 2025 Sahatak. All rights reserved.
                    </p>
                    <p class="mb-0 text-muted small mt-1" id="footer-medical-disclaimer">
                        This platform does not replace visiting a doctor in emergency cases
                    </p>
                </div>
            </div>
        </div>
    </footer>

            <!-- Client-side handlers (no external submission) -->
            <script>
                (function () {
                    function showAlert(container, type, text) {
                        container.className = 'alert alert-' + type;
                        container.textContent = text;
                        container.classList.remove('d-none');
                        setTimeout(() => container.classList.add('d-none'), 5000);
                    }

                    // Report form
                    const reportForm = document.getElementById('report-form');
                    const reportAlert = document.getElementById('report-alert');
                    reportForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        if (!reportForm.checkValidity()) {
                            showAlert(reportAlert, 'warning', 'Please complete the required fields.');
                            return;
                        }
                        // Collect data (replace with real submission)
                        const data = new FormData(reportForm);
                        // TODO: send 'data' via fetch to your backend endpoint
                        showAlert(reportAlert, 'success', 'Problem report sent. Our support team will contact you shortly.');
                        reportForm.reset();
                    });

                    // Supervisor form
                    const supervisorForm = document.getElementById('supervisor-form');
                    const supervisorAlert = document.getElementById('supervisor-alert');
                    supervisorForm.addEventListener('submit', function (e) {
                        e.preventDefault();
                        if (!supervisorForm.checkValidity()) {
                            showAlert(supervisorAlert, 'warning', 'Please complete the required fields.');
                            return;
                        }
                        const data = new FormData(supervisorForm);
                        // TODO: send 'data' via fetch to your backend endpoint
                        showAlert(supervisorAlert, 'success', 'Your message was sent to the supervisors.');
                        supervisorForm.reset();
                    });
                })();
            </script>

            <script>
            (function () {
                function resolveRole() {
                    const stored = localStorage.getItem('role');
                    if (stored) return stored;
                    if (document.body && document.body.dataset && document.body.dataset.protect) return document.body.dataset.protect;
                    return 'patient';
                }

                const role = resolveRole();
                const patientLink = document.getElementById('patient-dashboard-link');
                const doctorLink = document.getElementById('doctor-dashboard-link');

                if (patientLink) patientLink.classList.toggle('d-none', role !== 'patient');
                if (doctorLink) doctorLink.classList.toggle('d-none', role !== 'doctor');

                window.goBackToDashboard = function (evt) {
                    if (evt && evt.preventDefault) evt.preventDefault();
                    const r = resolveRole();
                    if (r === 'doctor') {
                        window.location.href = '../doctor/dashboard.html';
                    } else {
                        window.location.href = '../patient/dashboard.html';
                    }
                };

                window.bookNewAppointment = function () {
                    const r = resolveRole();
                    if (r === 'doctor') {
                        window.location.href = '../doctor/schedule.html';
                    } else {
                        window.location.href = '../patient/appointments/new.html';
                    }
                };

                window.showLanguageSelector = function () {
                    const current = document.getElementById('current-lang');
                    if (!current) return;
                    const next = current.textContent.trim() === 'English' ? 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'English';
                    current.textContent = next;
                    document.documentElement.dir = next === 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' ? 'rtl' : 'ltr';
                };

                if (!window.AuthGuard) {
                    window.AuthGuard = {
                        logout: function () {
                            localStorage.removeItem('token');
                            localStorage.removeItem('role');
                            window.location.href = '../auth/login.html';
                        }
                    };
                }
            })();
            </script>
            <script>
            (function () {
                const STORAGE_KEY = 'program_messages';
                const UPDATE_KEY = 'program_messages_last_update';

                // Utility to read file as DataURL if small
                function readAttachment(file) {
                    return new Promise((resolve) => {
                        if (!file) return resolve(null);
                        const maxEmbedSize = 300 * 1024; // 300 KB
                        const info = { name: file.name, size: file.size, type: file.type, dataUrl: null };
                        if (file.size > maxEmbedSize) return resolve(info);
                        const fr = new FileReader();
                        fr.onload = () => {
                            info.dataUrl = fr.result;
                            resolve(info);
                        };
                        fr.onerror = () => resolve(info);
                        fr.readAsDataURL(file);
                    });
                }

                function nowIso() { return (new Date()).toISOString(); }
                function newId() { return 'msg_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9); }

                function loadMessages() {
                    try {
                        const raw = localStorage.getItem(STORAGE_KEY);
                        return raw ? JSON.parse(raw) : [];
                    } catch (e) {
                        console.error('Failed to parse program messages', e);
                        return [];
                    }
                }

                function saveMessages(list) {
                    try {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
                        // Touch extra key so other tabs receive storage event
                        localStorage.setItem(UPDATE_KEY, Date.now().toString());
                    } catch (e) {
                        console.error('Failed to save program messages', e);
                    }
                }

                async function sendMessage(payload) {
                    // payload should contain: type, subject, body, to, contact, attachment (File or null), meta...
                    const attachment = payload.attachment instanceof File ? await readAttachment(payload.attachment) : payload.attachment || null;
                    const msg = {
                        id: newId(),
                        type: payload.type || 'program',
                        to: payload.to || null,
                        subject: payload.subject || '',
                        body: payload.body || '',
                        contact: payload.contact || '',
                        attachment,
                        senderRole: (function () {
                            try {
                                return localStorage.getItem('role') || document.body.dataset.protect || 'patient';
                            } catch (e) {
                                return 'patient';
                            }
                        })(),
                        createdAt: nowIso(),
                        read: false,
                        meta: payload.meta || {}
                    };

                    const list = loadMessages();
                    list.unshift(msg); // newest first
                    saveMessages(list);

                    // notify same-window listeners
                    window.dispatchEvent(new CustomEvent('programMessagesUpdated', { detail: msg }));
                    return msg;
                }

                // Public API surface for admin page or other code to use
                window.ProgramMessages = {
                    sendMessage,
                    getAll: () => loadMessages(),
                    markRead: function (id) {
                        const list = loadMessages();
                        const idx = list.findIndex(m => m.id === id);
                        if (idx >= 0) {
                            list[idx].read = true;
                            saveMessages(list);
                            window.dispatchEvent(new CustomEvent('programMessagesUpdated', { detail: { id, action: 'markedRead' } }));
                        }
                    },
                    clearAll: function () {
                        saveMessages([]);
                        window.dispatchEvent(new CustomEvent('programMessagesUpdated', { detail: { action: 'cleared' } }));
                    },
                    onUpdate: function (cb) {
                        if (typeof cb !== 'function') return;
                        const handler = (e) => cb(e.detail);
                        window.addEventListener('programMessagesUpdated', handler);
                        // also return unsubscribe
                        return () => window.removeEventListener('programMessagesUpdated', handler);
                    }
                };

                // Listen for storage events so admin page in another tab can react
                window.addEventListener('storage', (ev) => {
                    if (ev.key === UPDATE_KEY) {
                        // dispatch a generic update so listeners can refresh their view
                        window.dispatchEvent(new CustomEvent('programMessagesUpdated', { detail: { action: 'storageSync' } }));
                    }
                });

                // Attach capture-phase submit handlers so we record messages before existing handlers reset forms
                const reportForm = document.getElementById('report-form');
                if (reportForm) {
                    reportForm.addEventListener('submit', async function (e) {
                        // run in capture so it fires before previously attached listeners that reset the form
                    }, true);

                    // separate actual handler to allow async/await (can't make capture async handler reliably in some browsers)
                    reportForm.addEventListener('submit', function (e) {
                        // if form invalid, do nothing (existing handler will show warning)
                        if (!reportForm.checkValidity()) return;
                        // gather fields
                        const subject = document.getElementById('problem-subject')?.value || '';
                        const description = document.getElementById('problem-description')?.value || '';
                        const fileEl = document.getElementById('problem-screenshot');
                        const file = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;

                        // send but don't block UI
                        sendMessage({
                            type: 'report',
                            subject: subject,
                            body: description,
                            to: 'support',
                            attachment: file,
                            meta: { source: 'support-page', formId: 'report-form' }
                        }).catch(err => console.error('Failed to save report message', err));
                    }, true); // keep capture=true to run before earlier handlers
                }

                const supervisorForm = document.getElementById('supervisor-form');
                if (supervisorForm) {
                    supervisorForm.addEventListener('submit', function (e) {
                        if (!supervisorForm.checkValidity()) return;
                        const to = document.getElementById('supervisor-to')?.value || '';
                        const subject = document.getElementById('supervisor-subject')?.value || '';
                        const message = document.getElementById('supervisor-message')?.value || '';
                        const contact = document.getElementById('supervisor-phone')?.value || '';

                        sendMessage({
                            type: 'supervisor',
                            to: to || 'supervisor',
                            subject: subject,
                            body: message,
                            contact: contact,
                            meta: { source: 'support-page', formId: 'supervisor-form' }
                        }).catch(err => console.error('Failed to save supervisor message', err));
                    }, true);
                }

                // Convenience UI helper: if an "Admin page" is open on same domain, it can call ProgramMessages.getAll()
                // Example admin listener (for documentation / quick test):
                // window.ProgramMessages.onUpdate((detail) => { console.log('Messages updated', detail, ProgramMessages.getAll()); });

            })();
            </script>