<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title-head">My Appointments - Sahatak</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='%230d47a1' d='m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523.942-.661 2.27.067 3.71L8 15.5l6.533-8.737c.728-1.44.59-2.768.067-3.71C13.486.878 10.4.28 8.717 2.01L8 2.748z'/></svg>">
    
    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <!-- Bootstrap Icons CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Arabic Font - Noto Sans Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Main CSS -->
    <link rel="stylesheet" href="../../assets/css/main.css">
    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="../../assets/css/components/dashboard.css">
    <!-- Appointments CSS -->
    <link rel="stylesheet" href="../../assets/css/components/appointments.css">
    <!-- Video Consultation Dashboard CSS -->
    <link rel="stylesheet" href="../../assets/css/components/video-consultation-dashboard.css">
</head>
<body data-protect="patient">
    <div class="dashboard-container">
        <div class="container-fluid" style="padding-bottom: 120px;">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="row align-items-center">
                    <!-- Profile Section - Left (Right in RTL) -->
                    <div class="col-lg-4">
                        <div class="profile-section">
                            <div class="user-avatar">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            <div class="user-details">
                                <h5 class="mb-1" id="user-name">Loading...</h5>
                            </div>
                            <!-- Vertical Action Buttons -->
                            <div class="action-buttons">
                                <button class="btn btn-action" onclick="goBackToDashboard()" title="Back to Dashboard">
                                    <i class="bi bi-arrow-left"></i>
                                    <span id="btn-back">Back to Dashboard</span>
                                </button>
                                <button class="btn btn-action btn-logout" onclick="AuthGuard.logout()" title="Logout">
                                    <i class="bi bi-box-arrow-right"></i>
                                    <span id="btn-logout">Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Page Title - Center -->
                    <div class="col-lg-4 text-center">
                        <h1 class="dashboard-title" id="page-title">My Appointments</h1>
                        <p class="dashboard-subtitle" id="page-subtitle">Manage and view your medical appointments</p>
                    </div>
                    
                    <!-- Controls - Right (Left in RTL) -->
                    <div class="col-lg-4 text-end">
                        <div class="dashboard-controls">
                            <button class="btn btn-medical btn-sm me-2" onclick="bookNewAppointment()">
                                <i class="bi bi-plus me-1"></i>
                                <span id="btn-new-appointment">Book New</span>
                            </button>
                            <button class="btn btn-outline-medical btn-sm" onclick="showLanguageSelector()">
                                <i class="bi bi-globe me-1"></i>
                                <span id="current-lang">English</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="row">
                <div class="col-12">
                    <!-- Filter Buttons -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">
                                    <i class="bi bi-funnel me-2 text-primary"></i>
                                    <span id="filter-title">Filter Appointments</span>
                                </h5>
                                <small class="text-muted">
                                    <i class="bi bi-filter me-1"></i>
                                    <span id="filter-count">0 appointments</span>
                                </small>
                            </div>
                            <div class="btn-group w-100" role="group" id="appointment-tabs">
                                <button type="button" class="btn btn-outline-primary active" data-filter="all" id="tab-all">All</button>
                                <button type="button" class="btn btn-outline-primary" data-filter="upcoming" id="tab-upcoming">Upcoming</button>
                                <button type="button" class="btn btn-outline-primary" data-filter="completed" id="tab-completed">Completed</button>
                                <button type="button" class="btn btn-outline-primary" data-filter="cancelled" id="tab-cancelled">Cancelled</button>
                            </div>
                        </div>
                    </div>

                    <!-- Appointments List -->
                    <div class="dashboard-card mb-5">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="bi bi-calendar-event me-2 text-primary"></i>
                                <span id="appointments-title">Your Appointments</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="appointments-container" style="min-height: 400px; max-height: 500px; overflow-y: auto;">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden" id="loading-text">Loading...</span>
                                    </div>
                                    <p class="mt-3 text-muted" id="loading-appointments">Loading your appointments...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Appointment Details Modal -->
    <div class="modal fade" id="appointment-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar-event me-2"></i>
                        <span id="modal-appointment-details">Appointment Details</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="appointment-details">
                    <!-- Appointment details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning d-none me-2" id="reschedule-btn">
                        <i class="bi bi-calendar-event me-1"></i>
                        <span id="btn-reschedule">Reschedule</span>
                    </button>
                    <button type="button" class="btn btn-danger d-none me-2" id="cancel-btn">
                        <i class="bi bi-x-circle me-1"></i>
                        <span id="btn-cancel">Cancel</span>
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btn-close">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel Confirmation Modal -->
    <div class="modal fade" id="cancel-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span id="cancel-modal-title">Confirm Cancellation</span>
                    </h5>
                </div>
                <div class="modal-body">
                    <p id="cancel-modal-message">Are you sure you want to cancel this appointment?</p>
                    <div class="mb-3">
                        <label for="cancellation-reason" class="form-label" id="cancellation-reason-label">Reason for cancellation (optional)</label>
                        <textarea class="form-control" id="cancellation-reason" rows="3" 
                                placeholder="" data-placeholder-key="cancellation-reason-placeholder"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="confirmCancellation()">
                        <i class="bi bi-check me-1"></i>
                        <span id="confirm-cancel-btn">Yes, Cancel Appointment</span>
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="keep-appointment-btn">Keep Appointment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reschedule Modal -->
    <div class="modal fade" id="reschedule-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar-event text-primary me-2"></i>
                        <span id="reschedule-modal-title">Reschedule Appointment</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="reschedule-modal-subtitle">Select new date and time</p>
                    
                    <!-- Current appointment info -->
                    <div class="alert alert-info mb-4">
                        <h6 class="mb-2" id="current-appointment-label">Current Appointment:</h6>
                        <div id="current-appointment-info">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- New date selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="new-appointment-date" class="form-label" id="new-date-label">New Date</label>
                            <input type="date" class="form-control" id="new-appointment-date">
                        </div>
                    </div>
                    
                    <!-- Available time slots -->
                    <div id="reschedule-time-slots-container" class="mb-4">
                        <h6 class="mb-3" id="new-time-label">Available Times</h6>
                        <div id="reschedule-time-slots" class="d-flex flex-wrap gap-2">
                            <!-- Time slots will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Reschedule reason -->
                    <div class="mb-3">
                        <label for="reschedule-reason" class="form-label" id="reschedule-reason-label">Reason for rescheduling (optional)</label>
                        <textarea class="form-control" id="reschedule-reason" rows="3" 
                                placeholder="" data-placeholder-key="reschedule-reason-placeholder"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="confirmReschedule()" id="confirm-reschedule" disabled>
                        <i class="bi bi-calendar-check me-1"></i>
                        <span id="confirm-reschedule-btn">Confirm Reschedule</span>
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer mt-auto py-3">
        <div class="container">
            <div class="row g-3">
                <!-- Brand & Description -->
                <div class="col-lg-4 col-md-6">
                    <h5 class="mb-3">
                        <i class="bi bi-heart-pulse me-2 text-primary"></i>
                        <span id="footer-brand">Sahatak</span>
                    </h5>
                    <div class="d-flex gap-3 social-links">
                        <a href="https://facebook.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-facebook fs-5"></i></a>
                        <a href="https://twitter.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-twitter fs-5"></i></a>
                        <a href="https://instagram.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-instagram fs-5"></i></a>
                        <a href="https://linkedin.com/company/sahatak" target="_blank" rel="noopener"><i class="bi bi-linkedin fs-5"></i></a>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="col-lg-2 col-md-6">
                    <h6 class="mb-3" id="footer-links-title">Quick Links</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../common/about.html" class="text-muted text-decoration-none" id="footer-about">About Platform</a>
                        </li>
                        <li class="mb-2">
                            <a href="../common/services.html" class="text-muted text-decoration-none" id="footer-services">Services</a>
                        </li>
                    </ul>
                </div>

                <!-- Support -->
                <div class="col-lg-3 col-md-6">
                    <h6 class="mb-3" id="footer-support-title">Support & Help</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../common/support.html" class="text-muted text-decoration-none" id="footer-help">Help Center</a>
                        </li>
                        <li class="mb-2">
                            <a href="mailto:Sahatak.sudan@gmail.com" class="text-muted text-decoration-none" id="footer-contact">Contact Us</a>
                        </li>
                    </ul>
                </div>

                <!-- Emergency Contact -->
                <div class="col-lg-3 col-md-6 emergency-section">
                    <p class="mb-2 text-danger fw-bold" id="footer-emergency-text">
                        For medical emergencies
                    </p>
                    <p class="mb-3 text-danger fw-bold fs-6" id="footer-emergency-action">
                        <i class="bi bi-hospital me-2"></i>
                        Go to nearest ER hospital
                    </p>
                    <p class="mb-0 text-muted small" id="footer-emergency-note">
                        For non-urgent consultations use the platform
                    </p>
                </div>
            </div>

            <!-- Bottom Bar -->
            <hr class="my-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0 fw-bold" id="footer-copyright">
                        © 2025 Sahatak. All rights reserved.
                    </p>
                    <p class="mb-0 text-muted small mt-1" id="footer-medical-disclaimer">
                        This platform does not replace visiting a doctor in emergency cases
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5 JavaScript CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    
    <!-- Authentication Guard (must load first) -->
    <script src="../../assets/js/components/auth-guard.js"></script>
    <script src="../../assets/js/components/auth-storage.js"></script>
    
    <!-- Main JavaScript -->
    <script src="../../assets/js/main.js"></script>
    
    <!-- Dashboard Translations -->
    <script src="../../assets/js/components/dashboard-translations.js"></script>
    
    <!-- Video Consultation Dashboard JavaScript -->
    <script src="../../assets/js/components/video-consultation-dashboard.js"></script>
    
    <script>
        // Appointment List Management - following main.js patterns
        const AppointmentList = {
            currentAppointmentId: null,
            currentAppointment: null,
            currentFilter: 'all',
            appointments: [],
            selectedNewDateTime: null,

            // Initialize when page loads - following main.js patterns
            async init() {
                console.log('AppointmentList initializing...');
                
                // Load user name if available
                this.loadUserName();
                
                // Initialize language and translations
                await this.initializeLanguageSystem();
                
                // Load appointments and setup
                await this.loadAppointments();
                this.setupEventListeners();
                
                console.log('AppointmentList initialized successfully');
            },

            // Load user name following patient.html pattern
            loadUserName() {
                console.log('Loading user data...');
                
                // First try AuthGuard for real-time data
                const authUser = AuthGuard.getCurrentUser();
                console.log('AuthGuard user:', authUser);
                
                if (authUser && (authUser.full_name || authUser.fullName)) {
                    const name = authUser.full_name || authUser.fullName;
                    console.log('Using AuthGuard full_name/fullName:', name);
                    document.getElementById('user-name').textContent = name;
                } else if (authUser && authUser.name) {
                    console.log('Using AuthGuard name:', authUser.name);
                    document.getElementById('user-name').textContent = authUser.name;
                } else {
                    console.log('No AuthGuard data available, checking localStorage directly');
                    
                    // Check current user type to avoid cross-contamination
                    const userType = localStorage.getItem('sahatak_user_type');
                    console.log('Current user type:', userType);
                    
                    let userName = null;
                    
                    // Only check patient-specific data for patient users
                    if (userType === 'patient') {
                        try {
                            const patientData = JSON.parse(localStorage.getItem('sahatak_patient_data') || '{}');
                            if (patientData.full_name) {
                                userName = patientData.full_name;
                                console.log('Found patient full_name:', userName);
                            }
                        } catch (e) {
                            console.log('Error parsing patient data:', e);
                        }
                        
                        // Fallback to user name from localStorage
                        if (!userName) {
                            userName = localStorage.getItem('sahatak_user_name');
                            console.log('Using sahatak_user_name:', userName);
                        }
                    }
                    
                    if (userName) {
                        document.getElementById('user-name').textContent = userName;
                    } else {
                        console.log('No user data found, using default');
                        document.getElementById('user-name').textContent = 'Patient';
                    }
                }
            },

            // Initialize language system following main.js patterns
            async initializeLanguageSystem() {
                try {
                    // Load LanguageManager translations first
                    if (typeof LanguageManager !== 'undefined') {
                        await LanguageManager.loadTranslations();
                    }
                    
                    // Initialize language system
                    const currentLang = LanguageManager?.getLanguage() || localStorage.getItem('sahatak_language') || 'en';
                    
                    // Apply language settings using LanguageManager
                    if (typeof LanguageManager !== 'undefined') {
                        LanguageManager.applyLanguage(currentLang);
                    }
                    
                    // Apply appointment-specific translations
                    this.updateAppointmentTranslations(currentLang);
                    
                    // Set initial language button text
                    const langBtn = document.getElementById('current-lang');
                    if (langBtn) {
                        langBtn.textContent = currentLang === 'ar' ? 'العربية' : 'English';
                    }
                } catch (error) {
                    console.error('Error initializing language system:', error);
                }
            },

            // Update UI with translations - following established patterns
            updateAppointmentTranslations(lang = 'en') {
                const translations = LanguageManager.translations;
                if (!translations || !translations[lang]) {
                    console.warn(`No translations found for language: ${lang}`);
                    return;
                }
                
                const t = translations[lang];
                
                // Update page title
                document.title = `${t.appointments?.my_appointments || 'My Appointments'} - ${t.app_name}`;
                
                // Update header elements
                this.updateElement('page-title', t.appointments?.my_appointments || 'My Appointments');
                this.updateElement('page-subtitle', t.appointments?.manage_subtitle || 'Manage and view your medical appointments');
                
                // Update navigation buttons
                this.updateElement('btn-back', t.dashboard?.patient?.nav?.home || 'Back to Dashboard');
                this.updateElement('btn-logout', t.dashboard?.patient?.logout || 'Logout');
                this.updateElement('btn-new-appointment', t.appointments?.book_new || 'Book New');
                
                // Update filter tabs
                this.updateElement('filter-title', t.appointments?.filter_title || 'Filter Appointments');
                this.updateElement('tab-all', t.appointments?.tab_all || 'All Appointments');
                this.updateElement('tab-upcoming', t.appointments?.tab_upcoming || 'Upcoming');
                this.updateElement('tab-completed', t.appointments?.tab_completed || 'Completed');
                this.updateElement('tab-cancelled', t.appointments?.tab_cancelled || 'Cancelled');
                
                // Update main content
                this.updateElement('appointments-title', t.appointments?.your_appointments || 'Your Appointments');
                this.updateElement('loading-text', t.common?.loading || 'Loading...');
                this.updateElement('loading-appointments', t.appointments?.loading_appointments || 'Loading your appointments...');
                
                // Update modals
                this.updateElement('modal-appointment-details', t.appointments?.appointment_details || 'Appointment Details');
                this.updateElement('btn-reschedule', t.appointments?.reschedule || 'Reschedule');
                this.updateElement('btn-cancel', t.appointments?.cancel || 'Cancel');
                this.updateElement('btn-close', t.common?.close || 'Close');
                
                // Update cancel modal
                this.updateElement('cancel-modal-title', t.appointments?.cancel_confirm_title || 'Confirm Cancellation');
                this.updateElement('cancel-modal-message', t.appointments?.cancel_confirm_message || 'Are you sure you want to cancel this appointment?');
                this.updateElement('cancellation-reason-label', t.appointments?.cancellation_reason || 'Reason for cancellation (optional)');
                this.updateElement('confirm-cancel-btn', t.appointments?.confirm_cancel || 'Yes, Cancel Appointment');
                this.updateElement('keep-appointment-btn', t.appointments?.keep_appointment || 'Keep Appointment');
                
                // Update reschedule modal
                this.updateElement('reschedule-modal-title', t.appointments?.reschedule_title || 'Reschedule Appointment');
                this.updateElement('reschedule-modal-subtitle', t.appointments?.select_new_time || 'Select new date and time');
                this.updateElement('current-appointment-label', t.appointments?.current_appointment || 'Current Appointment:');
                this.updateElement('new-date-label', t.appointments?.new_date || 'New Date');
                this.updateElement('new-time-label', t.appointments?.new_time || 'Available Times');
                this.updateElement('reschedule-reason-label', t.appointments?.reschedule_reason || 'Reason for rescheduling (optional)');
                this.updateElement('confirm-reschedule-btn', t.appointments?.confirm_reschedule || 'Confirm Reschedule');
                
                // Update placeholders
                const cancellationTextarea = document.getElementById('cancellation-reason');
                if (cancellationTextarea) {
                    cancellationTextarea.placeholder = t.appointments?.cancellation_reason_placeholder || 'Enter reason for cancellation...';
                }
                
                const rescheduleTextarea = document.getElementById('reschedule-reason');
                if (rescheduleTextarea) {
                    rescheduleTextarea.placeholder = t.appointments?.reschedule_reason_placeholder || 'Enter reason for rescheduling...';
                }
                
                // Update footer
                this.updateElement('footer-brand', t.app_name);
                this.updateElement('footer-links-title', t.footer?.links_title || 'Quick Links');
                this.updateElement('footer-about', t.footer?.about || 'About Platform');
                this.updateElement('footer-services', t.footer?.services || 'Services');
                this.updateElement('footer-support-title', t.footer?.support_title || 'Support & Help');
                this.updateElement('footer-help', t.footer?.help || 'Help Center');
                this.updateElement('footer-contact', t.footer?.contact || 'Contact Us');
                this.updateElement('footer-emergency-text', t.footer?.emergency_text || 'For medical emergencies');
                this.updateElement('footer-emergency-action', t.footer?.emergency_action || 'Go to nearest ER hospital');
                this.updateElement('footer-emergency-note', t.footer?.emergency_note || 'For non-urgent consultations use the platform');
                this.updateElement('footer-copyright', t.footer?.copyright || '© 2025 Sahatak. All rights reserved.');
                this.updateElement('footer-medical-disclaimer', t.footer?.medical_disclaimer || 'This platform does not replace visiting a doctor in emergency cases');
            },
            
            updateElement(elementId, text) {
                const element = document.getElementById(elementId);
                if (element && text) {
                    element.textContent = text;
                }
            },

            // Setup event listeners
            setupEventListeners() {
                // Tab filters
                document.querySelectorAll('#appointment-tabs button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        
                        // Update active tab
                        document.querySelectorAll('#appointment-tabs button').forEach(b => b.classList.remove('active'));
                        button.classList.add('active');
                        
                        // Filter appointments
                        this.currentFilter = button.getAttribute('data-filter');
                        this.renderAppointments();
                    });
                });

                // Date change for reschedule
                const newDateInput = document.getElementById('new-appointment-date');
                if (newDateInput) {
                    newDateInput.addEventListener('change', () => this.loadRescheduleTimeSlots());
                    
                    // Set minimum date to today for reschedule
                    const today = new Date().toISOString().split('T')[0];
                    newDateInput.min = today;
                }
            },

            // Load appointments from API
            async loadAppointments() {
                try {
                    const response = await ApiHelper.makeRequest('/appointments/');
                    
                    if (response.success) {
                        this.appointments = response.data.appointments;
                        this.renderAppointments();
                    } else {
                        const currentLang = LanguageManager.getLanguage() || 'en';
                        const errorMsg = currentLang === 'ar' ? 'فشل في تحميل المواعيد' : 'Failed to load appointments';
                        this.showError(errorMsg);
                    }
                } catch (error) {
                    console.error('Error loading appointments:', error);
                    const currentLang = LanguageManager.getLanguage() || 'en';
                    const errorMsg = currentLang === 'ar' ? 'خطأ في الاتصال بالخادم' : 'Error connecting to server';
                    this.showError(errorMsg);
                }
            },

            // Render appointments based on current filter
            renderAppointments() {
                const container = document.getElementById('appointments-container');
                
                // Filter appointments
                let filteredAppointments = this.appointments;
                
                switch (this.currentFilter) {
                    case 'upcoming':
                        filteredAppointments = this.appointments.filter(apt => 
                            ['scheduled', 'confirmed'].includes(apt.status) && 
                            new Date(apt.appointment_date) > new Date()
                        );
                        break;
                    case 'completed':
                        filteredAppointments = this.appointments.filter(apt => apt.status === 'completed');
                        break;
                    case 'cancelled':
                        filteredAppointments = this.appointments.filter(apt => apt.status === 'cancelled');
                        break;
                }

                if (filteredAppointments.length === 0) {
                    const currentLang = LanguageManager.getLanguage() || 'en';
                    const noAppointmentsText = currentLang === 'ar' ? 'لا توجد مواعيد' : 'No appointments found';
                    const noAppointmentsDesc = currentLang === 'ar' ? 'لم يتم العثور على مواعيد في هذه الفئة' : 'No appointments found in this category';
                    const bookFirstText = currentLang === 'ar' ? 'احجز موعدك الأول' : 'Book your first appointment';
                    
                    container.innerHTML = `
                        <div class="text-center py-5">
                            <i class="bi bi-calendar-x display-4 text-muted mb-3"></i>
                            <h5 class="text-muted mb-3">${noAppointmentsText}</h5>
                            <p class="text-muted mb-4">${noAppointmentsDesc}</p>
                            <button class="btn btn-medical" onclick="AppointmentList.bookNewAppointment()">
                                <i class="bi bi-plus me-1"></i>
                                ${bookFirstText}
                            </button>
                        </div>
                    `;
                    return;
                }

                const appointmentsHtml = filteredAppointments.map(appointment => {
                    const date = new Date(appointment.appointment_date);
                    const statusClass = this.getStatusClass(appointment.status);
                    const statusText = this.getStatusText(appointment.status);
                    const typeText = this.getAppointmentTypeText(appointment.appointment_type);
                    const canModify = ['scheduled', 'confirmed'].includes(appointment.status) && 
                                     appointment.status !== 'cancelled' &&
                                     appointment.status !== 'completed' &&
                                     new Date(appointment.appointment_date) > new Date(Date.now() + 60*60*1000); // 1 hour from now
                    
                    const currentLang = LanguageManager.getLanguage() || 'en';
                    const detailsText = currentLang === 'ar' ? 'التفاصيل' : 'Details';
                    const rescheduleText = currentLang === 'ar' ? 'إعادة جدولة' : 'Reschedule';
                    const cancelText = currentLang === 'ar' ? 'إلغاء' : 'Cancel';
                    
                    // Add video consultation classes and button if applicable
                    const cardClasses = appointment.appointment_type === 'video' ? 
                        'card mb-3 appointment-card video-appointment' : 
                        'card mb-3 appointment-card';
                    const videoButton = VideoConsultationDashboard.generateVideoConsultationButton(appointment);
                    
                    return `
                        <div class="${cardClasses}" data-appointment-id="${appointment.id}">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="bi bi-person-badge text-primary me-2 fs-5"></i>
                                            <h6 class="mb-0">${appointment.doctor_name || 'Unknown Doctor'}</h6>
                                        </div>
                                        
                                        <div class="row text-muted small">
                                            <div class="col-sm-6 mb-2">
                                                <i class="bi bi-calendar me-1"></i>
                                                ${date.toLocaleDateString()} - ${date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}
                                            </div>
                                            <div class="col-sm-6 mb-2">
                                                <i class="bi ${appointment.appointment_type === 'video' ? 'bi-camera-video' : 'bi-calendar-check'} me-1"></i>
                                                ${typeText}
                                            </div>
                                            ${appointment.reason_for_visit ? `
                                                <div class="col-12">
                                                    <i class="bi bi-chat-dots me-1"></i>
                                                    ${appointment.reason_for_visit}
                                                </div>
                                            ` : ''}
                                        </div>
                                        
                                        ${videoButton ? `
                                            <div class="video-consultation-actions mt-3">
                                                ${videoButton}
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="col-md-4 text-end">
                                        <div class="mb-3">
                                            <span class="badge ${statusClass} fs-6">${statusText}</span>
                                        </div>
                                        
                                        <div class="btn-group-vertical btn-group-sm">
                                            <button class="btn btn-outline-primary btn-sm" onclick="AppointmentList.viewAppointment(${appointment.id})">
                                                <i class="bi bi-eye me-1"></i>
                                                ${detailsText}
                                            </button>
                                            ${canModify ? `
                                                <button class="btn btn-outline-warning btn-sm" onclick="AppointmentList.rescheduleAppointment(${appointment.id})">
                                                    <i class="bi bi-calendar-event me-1"></i>
                                                    ${rescheduleText}
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm" onclick="AppointmentList.cancelAppointment(${appointment.id})">
                                                    <i class="bi bi-x-circle me-1"></i>
                                                    ${cancelText}
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = appointmentsHtml;
            },

            // View appointment details
            async viewAppointment(appointmentId) {
                try {
                    const response = await ApiHelper.makeRequest(`/appointments/${appointmentId}`);
                    
                    if (response.success) {
                        this.currentAppointment = response.data.appointment;
                        const appointment = this.currentAppointment;
                        const date = new Date(appointment.appointment_date);
                        
                        const currentLang = LanguageManager.getLanguage() || 'en';
                        const doctorLabel = currentLang === 'ar' ? 'الطبيب:' : 'Doctor:';
                        const dateTimeLabel = currentLang === 'ar' ? 'التاريخ والوقت:' : 'Date & Time:';
                        const typeLabel = currentLang === 'ar' ? 'نوع الاستشارة:' : 'Consultation Type:';
                        const statusLabel = currentLang === 'ar' ? 'حالة الموعد:' : 'Status:';
                        const reasonLabel = currentLang === 'ar' ? 'سبب الزيارة:' : 'Reason for Visit:';
                        const symptomsLabel = currentLang === 'ar' ? 'الأعراض:' : 'Symptoms:';
                        const diagnosisLabel = currentLang === 'ar' ? 'التشخيص:' : 'Diagnosis:';
                        const prescriptionLabel = currentLang === 'ar' ? 'الوصفة الطبية:' : 'Prescription:';
                        const notesLabel = currentLang === 'ar' ? 'ملاحظات:' : 'Notes:';
                        
                        const detailsHtml = `
                            <div class="row" style="color: #212529;">
                                <div class="col-sm-6 mb-3">
                                    <strong style="color: #212529;">${doctorLabel}</strong><br>
                                    <span style="color: #212529;">${appointment.doctor_name || 'Unknown Doctor'}</span>
                                </div>
                                <div class="col-sm-6 mb-3">
                                    <strong style="color: #212529;">${dateTimeLabel}</strong><br>
                                    <span style="color: #212529;">${date.toLocaleDateString()} - ${date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</span>
                                </div>
                                <div class="col-sm-6 mb-3">
                                    <strong style="color: #212529;">${typeLabel}</strong><br>
                                    <span style="color: #212529;">${this.getAppointmentTypeText(appointment.appointment_type)}</span>
                                </div>
                                <div class="col-sm-6 mb-3">
                                    <strong style="color: #212529;">${statusLabel}</strong><br>
                                    <span class="badge ${this.getStatusClass(appointment.status)}">${this.getStatusText(appointment.status)}</span>
                                </div>
                                ${appointment.reason_for_visit ? `
                                    <div class="col-12 mb-3">
                                        <strong style="color: #212529;">${reasonLabel}</strong><br>
                                        <span style="color: #212529;">${appointment.reason_for_visit}</span>
                                    </div>
                                ` : ''}
                                ${appointment.symptoms ? `
                                    <div class="col-12 mb-3">
                                        <strong style="color: #212529;">${symptomsLabel}</strong><br>
                                        <span style="color: #212529;">${appointment.symptoms}</span>
                                    </div>
                                ` : ''}
                                ${appointment.diagnosis ? `
                                    <div class="col-12 mb-3">
                                        <strong style="color: #212529;">${diagnosisLabel}</strong><br>
                                        <span style="color: #212529;">${appointment.diagnosis}</span>
                                    </div>
                                ` : ''}
                                ${appointment.prescription ? `
                                    <div class="col-12 mb-3">
                                        <strong style="color: #212529;">${prescriptionLabel}</strong><br>
                                        <span style="color: #212529;">${appointment.prescription}</span>
                                    </div>
                                ` : ''}
                                ${appointment.notes ? `
                                    <div class="col-12 mb-3">
                                        <strong style="color: #212529;">${notesLabel}</strong><br>
                                        <span style="color: #212529;">${appointment.notes}</span>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        
                        document.getElementById('appointment-details').innerHTML = detailsHtml;
                        
                        // Show/hide action buttons based on status
                        const canModify = ['scheduled', 'confirmed'].includes(appointment.status) && 
                                         appointment.status !== 'cancelled' &&
                                         appointment.status !== 'completed' &&
                                         new Date(appointment.appointment_date) > new Date(Date.now() + 60*60*1000);
                        
                        const cancelBtn = document.getElementById('cancel-btn');
                        const rescheduleBtn = document.getElementById('reschedule-btn');
                        
                        if (canModify) {
                            cancelBtn.classList.remove('d-none');
                            rescheduleBtn.classList.remove('d-none');
                            cancelBtn.onclick = () => this.cancelAppointment(appointment.id);
                            rescheduleBtn.onclick = () => this.rescheduleAppointment(appointment.id);
                        } else {
                            cancelBtn.classList.add('d-none');
                            rescheduleBtn.classList.add('d-none');
                        }
                        
                        const modal = new bootstrap.Modal(document.getElementById('appointment-modal'));
                        modal.show();
                    } else {
                        const currentLang = LanguageManager.getLanguage() || 'en';
                        const errorMsg = currentLang === 'ar' ? 'فشل في تحميل تفاصيل الموعد' : 'Failed to load appointment details';
                        this.showError(errorMsg);
                    }
                } catch (error) {
                    console.error('Error loading appointment details:', error);
                    const currentLang = LanguageManager.getLanguage() || 'en';
                    const errorMsg = currentLang === 'ar' ? 'خطأ في تحميل تفاصيل الموعد' : 'Error loading appointment details';
                    this.showError(errorMsg);
                }
            },

            // Cancel appointment
            cancelAppointment(appointmentId) {
                this.currentAppointmentId = appointmentId;
                document.getElementById('cancellation-reason').value = '';
                const cancelModal = new bootstrap.Modal(document.getElementById('cancel-modal'));
                cancelModal.show();
            },

            // Reschedule appointment
            rescheduleAppointment(appointmentId) {
                this.currentAppointmentId = appointmentId;
                this.currentAppointment = this.appointments.find(apt => apt.id === appointmentId);
                
                if (this.currentAppointment) {
                    // Show current appointment info
                    const date = new Date(this.currentAppointment.appointment_date);
                    const currentLang = LanguageManager.getLanguage() || 'en';
                    const dateLabel = currentLang === 'ar' ? 'التاريخ:' : 'Date:';
                    const timeLabel = currentLang === 'ar' ? 'الوقت:' : 'Time:';
                    const doctorLabel = currentLang === 'ar' ? 'الطبيب:' : 'Doctor:';
                    
                    document.getElementById('current-appointment-info').innerHTML = `
                        <strong>${dateLabel}</strong> ${date.toLocaleDateString()}<br>
                        <strong>${timeLabel}</strong> ${date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}<br>
                        <strong>${doctorLabel}</strong> ${this.currentAppointment.doctor_name || 'Unknown Doctor'}
                    `;
                    
                    // Reset form
                    document.getElementById('new-appointment-date').value = '';
                    document.getElementById('reschedule-reason').value = '';
                    document.getElementById('reschedule-time-slots').innerHTML = '';
                    document.getElementById('confirm-reschedule').disabled = true;
                    this.selectedNewDateTime = null;
                    
                    const rescheduleModal = new bootstrap.Modal(document.getElementById('reschedule-modal'));
                    rescheduleModal.show();
                }
            },

            // Load available time slots for reschedule
            async loadRescheduleTimeSlots() {
                if (!this.currentAppointment) return;
                
                const date = document.getElementById('new-appointment-date').value;
                if (!date) return;

                try {
                    const response = await ApiHelper.makeRequest(
                        `/appointments/doctors/${this.currentAppointment.doctor_id}/availability?date=${date}`
                    );
                    
                    if (response.success) {
                        this.renderRescheduleTimeSlots(response.data.available_slots);
                    } else {
                        const currentLang = LanguageManager.getLanguage() || 'en';
                        const errorMsg = currentLang === 'ar' ? 'فشل في تحميل الأوقات المتاحة' : 'Failed to load available times';
                        this.showError(errorMsg);
                    }
                } catch (error) {
                    console.error('Error loading time slots:', error);
                    const currentLang = LanguageManager.getLanguage() || 'en';
                    const errorMsg = currentLang === 'ar' ? 'خطأ في تحميل الأوقات المتاحة' : 'Error loading available times';
                    this.showError(errorMsg);
                }
            },

            // Render time slots for reschedule
            renderRescheduleTimeSlots(slots) {
                const container = document.getElementById('reschedule-time-slots');
                
                if (slots.length === 0) {
                    const currentLang = LanguageManager.getLanguage() || 'en';
                    const noSlotsMessage = currentLang === 'ar' ? 
                        'لا توجد أوقات متاحة في هذا اليوم' : 
                        'No time slots available for this day';
                    container.innerHTML = `<p class="text-muted">${noSlotsMessage}</p>`;
                    return;
                }

                const slotsHtml = slots.map(slot => `
                    <button type="button" 
                            class="btn btn-outline-primary time-slot ${!slot.available ? 'disabled' : ''}"
                            data-time="${slot.datetime}"
                            onclick="AppointmentList.selectRescheduleTimeSlot('${slot.datetime}', '${slot.start}')"
                            ${!slot.available ? 'disabled' : ''}>
                        ${slot.start}
                    </button>
                `).join('');

                container.innerHTML = slotsHtml;
            },

            // Select time slot for reschedule
            selectRescheduleTimeSlot(datetime, displayTime) {
                // Remove previous selection
                document.querySelectorAll('#reschedule-time-slots .time-slot').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add selection to clicked button
                event.target.classList.add('active');
                
                // Store selected time
                this.selectedNewDateTime = datetime;
                
                // Enable confirm button
                document.getElementById('confirm-reschedule').disabled = false;
            },

            // Confirm cancellation
            async confirmCancellation() {
                if (!this.currentAppointmentId) return;

                try {
                    const reason = document.getElementById('cancellation-reason').value;
                    const response = await ApiHelper.makeRequest(`/appointments/${this.currentAppointmentId}/cancel`, {
                        method: 'PUT',
                        body: JSON.stringify({ cancellation_reason: reason })
                    });

                    if (response.success) {
                        // Close modals
                        bootstrap.Modal.getInstance(document.getElementById('cancel-modal')).hide();
                        const appointmentModal = bootstrap.Modal.getInstance(document.getElementById('appointment-modal'));
                        if (appointmentModal) appointmentModal.hide();
                        
                        // Reload appointments
                        await this.loadAppointments();
                        
                        const currentLang = LanguageManager.getLanguage() || 'en';
                        const successMsg = currentLang === 'ar' ? 'تم إلغاء الموعد بنجاح' : 'Appointment cancelled successfully';
                        this.showSuccess(successMsg);
                    } else {
                        this.showError(response.message || 'Failed to cancel appointment');
                    }
                } catch (error) {
                    console.error('Error cancelling appointment:', error);
                    const currentLang = LanguageManager.getLanguage() || 'en';
                    const errorMsg = currentLang === 'ar' ? 'خطأ في إلغاء الموعد' : 'Error cancelling appointment';
                    this.showError(errorMsg);
                }
            },

            // Confirm reschedule
            async confirmReschedule() {
                if (!this.currentAppointmentId || !this.selectedNewDateTime) return;

                try {
                    const reason = document.getElementById('reschedule-reason').value;
                    const response = await ApiHelper.makeRequest(`/appointments/${this.currentAppointmentId}/reschedule`, {
                        method: 'PUT',
                        body: JSON.stringify({ 
                            new_appointment_date: this.selectedNewDateTime,
                            reschedule_reason: reason 
                        })
                    });

                    if (response.success) {
                        // Close modals
                        bootstrap.Modal.getInstance(document.getElementById('reschedule-modal')).hide();
                        const appointmentModal = bootstrap.Modal.getInstance(document.getElementById('appointment-modal'));
                        if (appointmentModal) appointmentModal.hide();
                        
                        // Reload appointments
                        await this.loadAppointments();
                        
                        const currentLang = LanguageManager.getLanguage() || 'en';
                        const successMsg = currentLang === 'ar' ? 'تم إعادة جدولة الموعد بنجاح' : 'Appointment rescheduled successfully';
                        this.showSuccess(successMsg);
                    } else {
                        this.showError(response.message || 'Failed to reschedule appointment');
                    }
                } catch (error) {
                    console.error('Error rescheduling appointment:', error);
                    const currentLang = LanguageManager.getLanguage() || 'en';
                    const errorMsg = currentLang === 'ar' ? 'خطأ في إعادة جدولة الموعد' : 'Error rescheduling appointment';
                    this.showError(errorMsg);
                }
            },

            // Helper functions
            getStatusClass(status) {
                const classes = {
                    scheduled: 'bg-info',
                    confirmed: 'bg-success',
                    in_progress: 'bg-primary',
                    completed: 'bg-secondary',
                    cancelled: 'bg-danger',
                    no_show: 'bg-warning'
                };
                return classes[status] || 'bg-secondary';
            },

            getStatusText(status) {
                const currentLang = LanguageManager.getLanguage() || 'en';
                if (currentLang === 'ar') {
                    const statusesAr = {
                        scheduled: 'مجدول',
                        confirmed: 'مؤكد',
                        in_progress: 'جاري',
                        completed: 'مكتمل',
                        cancelled: 'مُلغى',
                        no_show: 'لم يحضر'
                    };
                    return statusesAr[status] || status;
                } else {
                    const statusesEn = {
                        scheduled: 'Scheduled',
                        confirmed: 'Confirmed',
                        in_progress: 'In Progress',
                        completed: 'Completed',
                        cancelled: 'Cancelled',
                        no_show: 'No Show'
                    };
                    return statusesEn[status] || status;
                }
            },

            getAppointmentTypeText(type) {
                const currentLang = LanguageManager.getLanguage() || 'en';
                if (currentLang === 'ar') {
                    const typesAr = {
                        video: 'مكالمة فيديو',
                        audio: 'مكالمة صوتية',
                        chat: 'محادثة نصية'
                    };
                    return typesAr[type] || type;
                } else {
                    const typesEn = {
                        video: 'Video Call',
                        audio: 'Audio Call',
                        chat: 'Text Chat'
                    };
                    return typesEn[type] || type;
                }
            },

            showError(message) {
                // Enhanced error display with toast-like notification
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
                errorDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
                errorDiv.innerHTML = `
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(errorDiv);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 5000);
            },

            showSuccess(message) {
                // Enhanced success display with toast-like notification
                const successDiv = document.createElement('div');
                successDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                successDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
                successDiv.innerHTML = `
                    <i class="bi bi-check-circle-fill me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(successDiv);
                
                // Auto-remove after 3 seconds
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.remove();
                    }
                }, 3000);
            },

            bookNewAppointment() {
                window.location.href = 'book-appointment.html';
            }
        };

        // Global functions for navigation
        function goBackToDashboard() {
            window.location.href = '../dashboard/patient.html';
        }

        function bookNewAppointment() {
            AppointmentList.bookNewAppointment();
        }

        function confirmCancellation() {
            AppointmentList.confirmCancellation();
        }

        function confirmReschedule() {
            AppointmentList.confirmReschedule();
        }

        function showLanguageSelector() {
            console.log('Language selector clicked');
            
            // Toggle between Arabic and English
            const currentLang = LanguageManager.getLanguage() || 'en';
            const newLang = currentLang === 'ar' ? 'en' : 'ar';
            
            // Change language
            LanguageManager.setLanguage(newLang);
            LanguageManager.applyLanguage(newLang);
            
            // Update appointment translations
            AppointmentList.updateAppointmentTranslations(newLang);
            
            // Update the language button text
            const langBtn = document.getElementById('current-lang');
            if (langBtn) {
                langBtn.textContent = newLang === 'ar' ? 'العربية' : 'English';
            }
            
            // Re-render appointments with new language
            AppointmentList.renderAppointments();
        }

        // Initialize appointment list when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Appointment list page initializing...');
            
            try {
                await AppointmentList.init();
            } catch (error) {
                console.error('Error during appointment list initialization:', error);
            }
        });
    </script>
</body>
</html>