<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Manage Availability - Sahatak</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='%230d47a1' d='m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523.942-.661 2.27.067 3.71L8 15.5l6.533-8.737c.728-1.44.59-2.768.067-3.71C13.486.878 10.4.28 8.717 2.01L8 2.748z'/></svg>">
    
    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <!-- Bootstrap Icons CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- English Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Main CSS -->
    <link rel="stylesheet" href="../../../assets/css/main.css">
    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="../../../assets/css/components/dashboard.css">
    <!-- Availability CSS -->
    <link rel="stylesheet" href="../../../assets/css/components/availability.css">
</head>
<body data-protect="doctor">
    <div class="dashboard-container">
        <div class="container-fluid">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="row align-items-center">
                    <!-- Profile Section - Left (Right in RTL) -->
                    <div class="col-lg-4">
                        <div class="profile-section">
                            <div class="user-avatar">
                                <i class="bi bi-person-badge"></i>
                            </div>
                            <div class="user-details">
                                <h5 class="mb-1" id="user-name">Loading...</h5>
                                <span class="badge bg-warning text-dark" id="verification-status">Unverified</span>
                            </div>
                            <!-- Vertical Action Buttons -->
                            <div class="action-buttons">
                                <button class="btn btn-action" onclick="showProfile()" title="Profile">
                                    <i class="bi bi-person"></i>
                                    <span id="btn-profile">Profile</span>
                                </button>
                                <button class="btn btn-action" onclick="showSettings()" title="Settings">
                                    <i class="bi bi-gear"></i>
                                    <span id="btn-settings">Settings</span>
                                </button>
                                <button class="btn btn-action btn-logout" onclick="AuthGuard.logout()" title="Logout">
                                    <i class="bi bi-box-arrow-right"></i>
                                    <span id="btn-logout">Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dashboard Title - Center -->
                    <div class="col-lg-4 text-center">
                        <h1 class="dashboard-title" id="dashboard-title">Manage Availability</h1>
                        <p class="dashboard-subtitle" id="dashboard-subtitle">Set your working hours and availability</p>
                    </div>
                    
                    <!-- Controls - Right -->
                    <div class="col-lg-4 text-end">
                        <div class="dashboard-controls">
                            <button class="btn btn-outline-medical btn-sm" onclick="goBack()">
                                <i class="bi bi-arrow-left me-1"></i>
                                <span>Back to Dashboard</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Main Content -->
                <div class="col-12">

                    <!-- Alert container -->
                    <div id="alert-container" class="mb-4"></div>

                    <!-- Schedule Management Tabs -->
                    <div class="dashboard-card">
                        <ul class="nav nav-tabs mb-4" id="scheduleTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="weekly-tab" data-bs-toggle="tab" data-bs-target="#weekly" type="button" role="tab">
                                    <i class="bi bi-calendar-week me-1"></i>
                                    <span id="tab-weekly">Weekly Schedule</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar" type="button" role="tab">
                                    <i class="bi bi-calendar-month me-1"></i>
                                    <span id="tab-calendar">Monthly Calendar</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="blocked-tab" data-bs-toggle="tab" data-bs-target="#blocked" type="button" role="tab">
                                    <i class="bi bi-x-circle me-1"></i>
                                    <span id="tab-blocked">Blocked Times</span>
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="scheduleTabContent">
                            <!-- Weekly Schedule Tab -->
                            <div class="tab-pane fade show active" id="weekly" role="tabpanel">
                                <div class="row">
                                    <div class="col-12">
                                        <h5 class="mb-3">
                                            <i class="bi bi-clock me-2" style="color: #0d47a1;"></i>
                                            <span id="weekly-title">Setup Weekly Schedule</span>
                                        </h5>
                                        
                                        <form id="weekly-schedule-form">
                                            <div id="weekly-schedule-container">
                                                <!-- Weekly schedule will be populated here -->
                                                <div class="text-center py-5">
                                                    <div class="spinner-border" style="color: #0d47a1;" role="status">
                                                        <span class="visually-hidden" id="loading-text">Loading...</span>
                                                    </div>
                                                    <p class="mt-2 text-muted" id="loading-weekly">Loading weekly schedule...</p>
                                                </div>
                                            </div>
                                            
                                            <!-- Quick Schedule Presets -->
                                            <div class="mt-4 mb-3">
                                                <h6 class="mb-3">
                                                    <i class="bi bi-lightning me-1" style="color: #0d47a1;"></i>
                                                    <span id="quick-templates">Quick Templates</span>
                                                </h6>
                                                <div class="row">
                                                    <div class="col-md-4 mb-2">
                                                        <button type="button" class="btn btn-outline-medical btn-sm w-100" 
                                                                onclick="AvailabilityManager.applyQuickSchedule('full-time')">
                                                            <i class="bi bi-clock-fill me-1"></i>
                                                            <span id="template-fulltime">Full Time</span>
                                                        </button>
                                                    </div>
                                                    <div class="col-md-4 mb-2">
                                                        <button type="button" class="btn btn-outline-medical btn-sm w-100" 
                                                                onclick="AvailabilityManager.applyQuickSchedule('weekdays-only')">
                                                            <i class="bi bi-calendar-day me-1"></i>
                                                            <span id="template-weekdays">Weekdays Only</span>
                                                        </button>
                                                    </div>
                                                    <div class="col-md-4 mb-2">
                                                        <button type="button" class="btn btn-outline-medical btn-sm w-100" 
                                                                onclick="AvailabilityManager.applyQuickSchedule('part-time')">
                                                            <i class="bi bi-clock me-1"></i>
                                                            <span id="template-parttime">Part Time</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-4 text-center">
                                                <button type="submit" class="btn btn-medical" id="save-schedule-btn">
                                                    <i class="bi bi-check-circle me-1"></i>
                                                    <span id="btn-save-schedule">Save Schedule</span>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary ms-2" onclick="resetSchedule()">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>
                                                    <span id="btn-reset">Reset</span>
                                                </button>
                                                <button type="button" class="btn btn-outline-medical ms-2" onclick="AvailabilityManager.exportSchedule()">
                                                    <i class="bi bi-download me-1"></i>
                                                    <span id="btn-export">Export</span>
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Calendar View Tab -->
                            <div class="tab-pane fade" id="calendar" role="tabpanel">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="mb-0">
                                                <i class="bi bi-calendar-month me-2" style="color: #0d47a1;"></i>
                                                <span id="calendar-title">Monthly Calendar</span>
                                            </h5>
                                            <div class="calendar-controls">
                                                <button class="btn btn-outline-medical btn-sm me-2" onclick="previousMonth()">
                                                    <i class="bi bi-chevron-right"></i>
                                                </button>
                                                <span id="current-month" class="fw-bold mx-3">January 2025</span>
                                                <button class="btn btn-outline-medical btn-sm" onclick="nextMonth()">
                                                    <i class="bi bi-chevron-left"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div id="availability-calendar">
                                            <!-- Calendar will be populated here -->
                                            <div class="text-center py-5">
                                                <div class="spinner-border" style="color: #0d47a1;" role="status">
                                                    <span class="visually-hidden" id="loading-text-2">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-muted" id="loading-calendar">Loading calendar...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Blocked Times Tab -->
                            <div class="tab-pane fade" id="blocked" role="tabpanel">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="mb-0">
                                                <i class="bi bi-x-circle me-2" style="color: #0d47a1;"></i>
                                                <span id="blocked-title">Blocked Times</span>
                                            </h5>
                                            <button class="btn btn-medical btn-sm" data-bs-toggle="modal" data-bs-target="#blockTimeModal">
                                                <i class="bi bi-plus-circle me-1"></i>
                                                <span id="btn-block-new">Block New Time</span>
                                            </button>
                                        </div>
                                        <div id="blocked-times-list">
                                            <!-- Blocked times will be populated here -->
                                            <div class="text-center py-5">
                                                <div class="spinner-border" style="color: #0d47a1;" role="status">
                                                    <span class="visually-hidden" id="loading-text-3">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-muted" id="loading-blocked">Loading blocked times...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Block Time Modal -->
    <div class="modal fade" id="blockTimeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-x-circle me-2"></i>
                        <span id="modal-block-title">Block Specific Time</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="block-time-form">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="block-date" class="form-label" id="label-date">Date</label>
                            <input type="date" class="form-control" id="block-date" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="block-start-time" class="form-label" id="label-start-time">Start Time</label>
                                <input type="time" class="form-control" id="block-start-time" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="block-end-time" class="form-label" id="label-end-time">End Time</label>
                                <input type="time" class="form-control" id="block-end-time" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="block-reason" class="form-label" id="label-reason">Reason (Optional)</label>
                            <textarea class="form-control" id="block-reason" rows="3" 
                                    placeholder="" data-placeholder-key="placeholder-block-reason"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btn-cancel">Cancel</button>
                        <button type="submit" class="btn btn-danger" id="block-time-btn">
                            <i class="bi bi-x-circle me-1"></i>
                            <span id="btn-block-time">Block Time</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Blocked Time Modal -->
    <div class="modal fade" id="editBlockedTimeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil me-2"></i>
                        <span id="modal-edit-title">Edit Blocked Time</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="edit-blocked-content">
                        <!-- Content will be populated when editing -->
                    </div>
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-medical me-2" onclick="unblockTime()">
                            <i class="bi bi-check-circle me-1"></i>
                            <span id="btn-unblock">Remove Block</span>
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btn-close">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer mt-auto py-3">
        <div class="container">
            <div class="row g-3">
                <!-- Brand & Description -->
                <div class="col-lg-4 col-md-6">
                    <h5 class="mb-3">
                        <i class="bi bi-heart-pulse me-2 text-primary"></i>
                        <span id="footer-brand">Sahatak</span>
                    </h5>
                    <div class="d-flex gap-3 social-links">
                        <a href="https://facebook.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-facebook fs-5"></i></a>
                        <a href="https://twitter.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-twitter fs-5"></i></a>
                        <a href="https://instagram.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-instagram fs-5"></i></a>
                        <a href="https://linkedin.com/company/sahatak" target="_blank" rel="noopener"><i class="bi bi-linkedin fs-5"></i></a>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="col-lg-2 col-md-6">
                    <h6 class="mb-3" id="footer-links-title">Quick Links</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../common/about.html" class="text-muted text-decoration-none" id="footer-about">About Platform</a>
                        </li>
                        <li class="mb-2">
                            <a href="../common/services.html" class="text-muted text-decoration-none" id="footer-services">Services</a>
                        </li>
                    </ul>
                </div>

                <!-- Support -->
                <div class="col-lg-3 col-md-6">
                    <h6 class="mb-3" id="footer-support-title">Support & Help</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../common/support.html" class="text-muted text-decoration-none" id="footer-help">Help Center</a>
                        </li>
                        <li class="mb-2">
                            <a href="../common/contact-us.html" class="text-muted text-decoration-none" id="footer-contact">Contact Us</a>
                        </li>
                    </ul>
                </div>

                <!-- Emergency Contact -->
                <div class="col-lg-3 col-md-6 emergency-section">
                    <p class="mb-2 text-danger fw-bold" id="footer-emergency-text">
                        For medical emergencies
                    </p>
                    <p class="mb-3 text-danger fw-bold fs-6" id="footer-emergency-action">
                        <i class="bi bi-hospital me-2"></i>
                        Go to nearest ER hospital
                    </p>
                    <p class="mb-0 text-muted small" id="footer-emergency-note">
                        For non-urgent consultations use the platform
                    </p>
                </div>
            </div>

            <!-- Bottom Bar -->
            <hr class="my-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0 fw-bold" id="footer-copyright">
                        © 2025 Sahatak. All rights reserved.
                    </p>
                    <p class="mb-0 text-muted small mt-1" id="footer-medical-disclaimer">
                        This platform does not replace visiting a doctor in emergency cases
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5 JavaScript CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    
    <!-- Authentication Guard (must load first) -->
    <script src="../../../assets/js/components/auth-guard.js"></script>
    
    <!-- Main JavaScript -->
    <script src="../../../assets/js/main.js"></script>
    
    <!-- Dashboard Translations -->
    <script src="../../../assets/js/components/dashboard-translations.js"></script>
    
    <!-- Availability Manager -->
    <script src="../../../assets/js/components/availability-manager.js"></script>
    
    <script>
        // Availability page specific functions
        function goBack() {
            window.history.back();
        }
        
        // Profile and settings functions - standardized across all doctor pages
        function showProfile() {
            // Check if we're on the main dashboard page
            if (window.location.pathname.includes('dashboard/doctor.html')) {
                // On dashboard - show profile section directly
                const profileSection = document.getElementById('profile-section');
                const settingsSection = document.getElementById('settings-section');
                
                if (profileSection && settingsSection) {
                    settingsSection.style.display = 'none';
                    profileSection.style.display = profileSection.style.display === 'none' ? 'block' : 'none';
                    
                    if (profileSection.style.display === 'block') {
                        profileSection.scrollIntoView({ behavior: 'smooth' });
                        loadUserProfile();
                    }
                    return;
                }
            }
            
            // On other pages - redirect to dashboard and show profile
            sessionStorage.setItem('sahatak_show_profile_on_load', 'true');
            window.location.href = '../../dashboard/doctor.html';
        }
        
        function showSettings() {
            // Check if we're on the main dashboard page
            if (window.location.pathname.includes('dashboard/doctor.html')) {
                // On dashboard - show settings section directly
                const settingsSection = document.getElementById('settings-section');
                const profileSection = document.getElementById('profile-section');
                
                if (settingsSection && profileSection) {
                    profileSection.style.display = 'none';
                    settingsSection.style.display = settingsSection.style.display === 'none' ? 'block' : 'none';
                    
                    if (settingsSection.style.display === 'block') {
                        settingsSection.scrollIntoView({ behavior: 'smooth' });
                        loadUserSettings();
                    }
                    return;
                }
            }
            
            // On other pages - redirect to dashboard and show settings
            sessionStorage.setItem('sahatak_show_settings_on_load', 'true');
            window.location.href = '../../dashboard/doctor.html';
        }
        
        function showWeeklySchedule() {
            // Switch to weekly tab
            document.getElementById('weekly-tab').click();
        }
        
        function resetSchedule() {
            // Use AvailabilityManager's resetSchedule which has proper translation support
            if (typeof AvailabilityManager !== 'undefined') {
                AvailabilityManager.resetSchedule();
            }
        }
        
        function previousMonth() {
            console.log('Previous month clicked');
            // Implement month navigation
        }
        
        function nextMonth() {
            console.log('Next month clicked');
            // Implement month navigation
        }
        
        function unblockTime() {
            console.log('Unblock time clicked');
            // Implement unblock logic
        }
        
        // Profile and Settings handlers
        function showProfile() {
            alert('Profile functionality will be implemented. Please use the main dashboard for now.');
            window.location.href = '../../dashboard/doctor.html';
        }
        
        function showSettings() {
            alert('Settings functionality will be implemented. Please use the main dashboard for now.');
            window.location.href = '../../dashboard/doctor.html';
        }
        
        // Update verification status from database
        function updateVerificationStatus(user) {
            const statusElement = document.getElementById('verification-status');
            const isVerified = user.verification_status === 'verified';
            
            if (isVerified) {
                statusElement.textContent = 'Verified';
                statusElement.className = 'badge bg-success';
            } else {
                statusElement.textContent = 'Unverified';
                statusElement.className = 'badge bg-warning text-dark';
            }
        }
        
        // Initialize availability management when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Availability management page initializing...');
            
            // Load and update user data including verification status
            // Try to get user data from localStorage first (like doctor.html does)
            const user = JSON.parse(localStorage.getItem('sahatak_doctor_data') || '{}');
            
            if (user.full_name) {
                // Update user name in header with actual name from database
                document.getElementById('user-name').textContent = user.full_name;
                
                // Update verification status from database
                updateVerificationStatus(user);
            } else {
                // Fallback to AuthGuard
                const authUser = AuthGuard.getCurrentUser();
                if (authUser && authUser.full_name) {
                    document.getElementById('user-name').textContent = authUser.full_name;
                    updateVerificationStatus(authUser);
                } else {
                    // Show default values if no user data available
                    document.getElementById('user-name').textContent = 'Doctor';
                    document.getElementById('verification-status').textContent = 'Unverified';
                    document.getElementById('verification-status').className = 'badge bg-warning text-dark';
                }
            }
            
            await DashboardTranslations.initializeDashboard('availability');
            
            // Initialize AvailabilityManager if it exists
            if (typeof AvailabilityManager !== 'undefined') {
                await AvailabilityManager.init();
            }
        });
    </script>
</body>
</html>