<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Communication Hub - Sahatak</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='%230d47a1' d='m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523.942-.661 2.27.067 3.71L8 15.5l6.533-8.737c.728-1.44.59-2.768.067-3.71C13.486.878 10.4.28 8.717 2.01L8 2.748z'/></svg>">
    
    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- English Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Main CSS -->
    <link rel="stylesheet" href="../../../assets/css/main.css">
    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="../../../assets/css/components/dashboard.css">
</head>
<body data-protect="doctor">
    <div class="dashboard-container">
        <div class="container-fluid">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="row align-items-center">
                    <!-- Profile Section - Left -->
                    <div class="col-lg-4">
                        <div class="profile-section">
                            <div class="user-avatar">
                                <i class="bi bi-person-badge"></i>
                            </div>
                            <div class="user-details">
                                <h5 class="mb-1" id="user-name">Dr. Sarah Ahmed</h5>
                                <span class="badge bg-success" id="verification-status">Verified</span>
                            </div>
                            <!-- Vertical Action Buttons -->
                            <div class="action-buttons">
                                <button class="btn btn-action" onclick="showProfile()" title="Profile">
                                    <i class="bi bi-person"></i>
                                    <span id="btn-profile">Profile</span>
                                </button>
                                <button class="btn btn-action" onclick="showSettings()" title="Settings">
                                    <i class="bi bi-gear"></i>
                                    <span id="btn-settings">Settings</span>
                                </button>
                                <button class="btn btn-action btn-logout" onclick="logout()" title="Logout">
                                    <i class="bi bi-box-arrow-right"></i>
                                    <span id="btn-logout">Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dashboard Title - Center -->
                    <div class="col-lg-4 text-center">
                        <h1 class="dashboard-title" id="dashboard-title">Patient Communication Hub</h1>
                        <p class="dashboard-subtitle" id="dashboard-subtitle">Secure messaging and communication with your patients</p>
                    </div>
                    
                    <!-- Controls - Right -->
                    <div class="col-lg-4 text-end">
                        <div class="dashboard-controls">
                            <button class="btn btn-outline-medical btn-sm me-2" onclick="window.location.href='../../dashboard/doctor.html'">
                                <i class="bi bi-arrow-left me-1"></i>
                                <span>Back to Dashboard</span>
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="startNewConversation()">
                                <i class="bi bi-plus-circle me-1"></i>New Message
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Patient List Panel -->
                <div class="col-lg-4">
                    <div class="dashboard-card h-100">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5><i class="bi bi-people me-2"></i>Patients</h5>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary active" onclick="filterPatients('all')">All</button>
                                <button type="button" class="btn btn-outline-primary" onclick="filterPatients('unread')">Unread</button>
                                <button type="button" class="btn btn-outline-primary" onclick="filterPatients('urgent')">Urgent</button>
                            </div>
                        </div>

                        <!-- Search Bar -->
                        <div class="mb-3">
                            <input type="text" class="form-control" id="patientSearch" placeholder="Search patients..." onkeyup="searchPatients()">
                        </div>

                        <!-- Patient List -->
                        <div class="patient-list" id="patientList">
                            <div class="patient-item active" onclick="selectPatient('patient1')" data-patient="patient1">
                                <div class="d-flex align-items-start">
                                    <div class="patient-avatar me-3">
                                        <i class="bi bi-person-circle"></i>
                                    </div>
                                    <div class="patient-info flex-grow-1">
                                        <h6 class="patient-name">Ahmed Mohamed</h6>
                                        <p class="last-message text-muted">Thank you for the prescription...</p>
                                        <small class="text-muted">2 hours ago</small>
                                    </div>
                                    <div class="message-status">
                                        <span class="badge bg-primary">3</span>
                                    </div>
                                </div>
                            </div>

                            <div class="patient-item" onclick="selectPatient('patient2')" data-patient="patient2">
                                <div class="d-flex align-items-start">
                                    <div class="patient-avatar me-3">
                                        <i class="bi bi-person-circle"></i>
                                    </div>
                                    <div class="patient-info flex-grow-1">
                                        <h6 class="patient-name">Fatima Ali</h6>
                                        <p class="last-message text-muted">When should I take the medication?</p>
                                        <small class="text-muted">5 hours ago</small>
                                    </div>
                                    <div class="message-status">
                                        <span class="badge bg-danger urgent">!</span>
                                    </div>
                                </div>
                            </div>

                            <div class="patient-item" onclick="selectPatient('patient3')" data-patient="patient3">
                                <div class="d-flex align-items-start">
                                    <div class="patient-avatar me-3">
                                        <i class="bi bi-person-circle"></i>
                                    </div>
                                    <div class="patient-info flex-grow-1">
                                        <h6 class="patient-name">Omar Hassan</h6>
                                        <p class="last-message text-muted">Appointment rescheduled successfully</p>
                                        <small class="text-muted">1 day ago</small>
                                    </div>
                                </div>
                            </div>

                            <div class="patient-item" onclick="selectPatient('patient4')" data-patient="patient4">
                                <div class="d-flex align-items-start">
                                    <div class="patient-avatar me-3">
                                        <i class="bi bi-person-circle"></i>
                                    </div>
                                    <div class="patient-info flex-grow-1">
                                        <h6 class="patient-name">Layla Ibrahim</h6>
                                        <p class="last-message text-muted">Lab results look good!</p>
                                        <small class="text-muted">2 days ago</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Panel -->
                <div class="col-lg-8">
                    <div class="dashboard-card h-100">
                        <!-- Chat Header -->
                        <div class="chat-header d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                            <div class="d-flex align-items-center">
                                <div class="patient-avatar me-3">
                                    <i class="bi bi-person-circle fs-2"></i>
                                </div>
                                <div>
                                    <h5 class="mb-0" id="selectedPatientName">Ahmed Mohamed</h5>
                                    <small class="text-muted">Patient ID: PAT-2024-001 | Last seen: Today</small>
                                </div>
                            </div>
                            <div class="chat-actions">
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="viewPatientRecord()">
                                    <i class="bi bi-file-medical me-1"></i>View Record
                                </button>
                                <button class="btn btn-outline-success btn-sm me-2" onclick="scheduleFollowUp()">
                                    <i class="bi bi-calendar-plus me-1"></i>Schedule
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="startVideoCall()">
                                    <i class="bi bi-camera-video me-1"></i>Video Call
                                </button>
                            </div>
                        </div>

                        <!-- Chat Messages -->
                        <div class="chat-messages" id="chatMessages">
                            <div class="message patient-message">
                                <div class="message-content">
                                    <p>Hello Dr. Ahmed, I wanted to ask about the prescription you gave me yesterday. When should I take the medication?</p>
                                    <small class="message-time">Today 10:30 AM</small>
                                </div>
                            </div>

                            <div class="message doctor-message">
                                <div class="message-content">
                                    <p>Hello Ahmed! Take the medication twice daily - once in the morning with breakfast and once in the evening with dinner. Make sure to take it at the same times each day.</p>
                                    <small class="message-time">Today 11:45 AM</small>
                                </div>
                            </div>

                            <div class="message patient-message">
                                <div class="message-content">
                                    <p>Thank you for the clarification! Should I continue taking my other medications as usual?</p>
                                    <small class="message-time">Today 12:15 PM</small>
                                </div>
                            </div>

                            <div class="message patient-message">
                                <div class="message-content">
                                    <p>Also, I've been feeling a bit dizzy since starting the new medication. Is this normal?</p>
                                    <small class="message-time">Today 2:30 PM</small>
                                </div>
                            </div>
                        </div>

                        <!-- Message Input -->
                        <div class="message-input-area mt-3 pt-3 border-top">
                            <div class="row g-2 mb-2">
                                <div class="col-auto">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="insertTemplate('greeting')">
                                        <i class="bi bi-chat-quote me-1"></i>Templates
                                    </button>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="attachFile()">
                                        <i class="bi bi-paperclip me-1"></i>Attach
                                    </button>
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="insertPrescription()">
                                        <i class="bi bi-prescription2 me-1"></i>Prescription
                                    </button>
                                </div>
                            </div>
                            <div class="input-group">
                                <textarea class="form-control" id="messageInput" rows="3" placeholder="Type your message to the patient..." onkeypress="handleKeyPress(event)"></textarea>
                                <button class="btn btn-primary" onclick="sendMessage()">
                                    <i class="bi bi-send"></i>
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Panel -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="dashboard-card">
                        <h5 class="mb-3"><i class="bi bi-lightning me-2"></i>Quick Actions</h5>
                        <div class="row">
                            <div class="col-lg-3 col-md-6 mb-3">
                                <button class="btn btn-outline-primary w-100" onclick="broadcastMessage()">
                                    <i class="bi bi-broadcast me-2"></i>Send Broadcast
                                </button>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <button class="btn btn-outline-success w-100" onclick="scheduleReminder()">
                                    <i class="bi bi-alarm me-2"></i>Set Reminder
                                </button>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <button class="btn btn-outline-info w-100" onclick="viewMessageHistory()">
                                    <i class="bi bi-clock-history me-2"></i>Message History
                                </button>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <button class="btn btn-outline-warning w-100" onclick="exportChat()">
                                    <i class="bi bi-download me-2"></i>Export Chat
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer mt-auto py-3">
        <div class="container">
            <div class="row g-3">
                <!-- Brand & Description -->
                <div class="col-lg-4 col-md-6">
                    <h5 class="mb-3">
                        <i class="bi bi-heart-pulse me-2 text-primary"></i>
                        <span id="footer-brand">Sahatak</span>
                    </h5>
                    <div class="d-flex gap-3 social-links">
                        <a href="https://facebook.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-facebook fs-5"></i></a>
                        <a href="https://twitter.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-twitter fs-5"></i></a>
                        <a href="https://instagram.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-instagram fs-5"></i></a>
                        <a href="https://linkedin.com/company/sahatak" target="_blank" rel="noopener"><i class="bi bi-linkedin fs-5"></i></a>
                    </div>
                </div>
                <!-- Quick Links -->
                <div class="col-lg-2 col-md-6">
                    <h6 class="mb-3" id="footer-links-title">Quick Links</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../../common/about.html" class="text-muted text-decoration-none" id="footer-about">About Platform</a>
                        </li>
                        <li class="mb-2">
                            <a href="../../common/services.html" class="text-muted text-decoration-none" id="footer-services">Services</a>
                        </li>
                    </ul>
                </div>
                <!-- Support -->
                <div class="col-lg-3 col-md-6">
                    <h6 class="mb-3" id="footer-support-title">Support & Help</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../../common/support.html" class="text-muted text-decoration-none" id="footer-help">Help Center</a>
                        </li>
                        <li class="mb-2">
                            <a href="../../common/contact-us.html" class="text-muted text-decoration-none" id="footer-contact">Contact Us</a>
                        </li>
                    </ul>
                </div>
                <!-- Emergency Contact -->
                <div class="col-lg-3 col-md-6 emergency-section">
                    <p class="mb-2 text-danger fw-bold" id="footer-emergency-text">
                        For medical emergencies
                    </p>
                    <p class="mb-3 text-danger fw-bold fs-6" id="footer-emergency-action">
                        <i class="bi bi-hospital me-2"></i>
                        Go to nearest ER hospital
                    </p>
                    <p class="mb-0 text-muted small" id="footer-emergency-note">
                        For non-urgent consultations use the platform
                    </p>
                </div>
            </div>
            <!-- Bottom Bar -->
            <hr class="my-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0 fw-bold" id="footer-copyright">
                        © 2025 Sahatak. All rights reserved.
                    </p>
                    <p class="mb-0 text-muted small mt-1" id="footer-medical-disclaimer">
                        This platform does not replace visiting a doctor in emergency cases
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5 JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Core JavaScript Files -->
    <script src="../../../assets/js/main.js"></script>
    <script src="../../../assets/js/components/dashboard-translations.js"></script>
    <script src="../../../assets/js/components/auth-guard.js"></script>
    <script src="../../../assets/js/components/logger.js"></script>
    <script src="../../../assets/js/components/messaging.js"></script>

    <style>
        /* Messaging enhancements */
        .typing-indicator {
            padding: 10px 15px;
            margin: 5px 0;
            background: rgba(0, 123, 255, 0.1);
            border-radius: 10px;
            font-style: italic;
            color: #007bff;
        }
        
        .typing-dots .dots {
            display: inline-block;
            margin-left: 5px;
        }
        
        .typing-dots .dots span {
            display: inline-block;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #007bff;
            margin: 0 1px;
            animation: typing-bounce 1.4s ease-in-out infinite both;
        }
        
        .typing-dots .dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots .dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing-bounce {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .appointment-context {
            background: rgba(25, 135, 84, 0.1);
            border: 1px solid rgba(25, 135, 84, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 8px;
            font-size: 0.85em;
            color: #198754;
        }
        
        .appointment-context i {
            margin-right: 5px;
        }
        
        .appointment-reason {
            font-size: 0.8em;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        .appointment-info {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .appointment-badge {
            display: flex;
            align-items: center;
        }
        
        .appointment-badge i {
            font-size: 1.5em;
            margin-right: 12px;
        }
        
        .appointment-details strong {
            display: block;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .appointment-meta {
            display: flex;
            gap: 10px;
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .message-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
        }
        
        .message-status {
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.1);
        }
        
        .status-sent { color: #6c757d; }
        .status-delivered { color: #007bff; }
        .status-read { color: #28a745; }
        
        .urgent-indicator {
            color: #dc3545;
            margin-left: 5px;
        }
        
        .connection-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
        }
        
        .status-connected {
            background: rgba(25, 135, 84, 0.1);
            color: #198754;
        }
        
        .status-disconnected {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        
        .message-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 15px;
            min-width: 300px;
            max-width: 400px;
            border-left: 4px solid #007bff;
        }
        
        .notification-content {
            display: flex;
            flex-direction: column;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .notification-message {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .notification-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: #6c757d;
        }

        .patient-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .patient-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .patient-item:hover {
            background-color: #f8f9fa;
        }

        .patient-item.active {
            background-color: #e3f2fd;
            border-left: 4px solid #2563eb;
        }

        .patient-avatar i {
            font-size: 2rem;
            color: #6c757d;
        }

        .patient-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .last-message {
            font-size: 0.9rem;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-status .badge {
            font-size: 0.7rem;
        }

        .urgent {
            background-color: #dc3545 !important;
        }

        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px 0;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
        }

        .patient-message {
            justify-content: flex-start;
        }

        .doctor-message {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
        }

        .patient-message .message-content {
            background-color: #e9ecef;
            color: #333;
        }

        .doctor-message .message-content {
            background-color: #2563eb;
            color: white;
        }

        .message-time {
            display: block;
            margin-top: 5px;
            opacity: 0.7;
        }

        .message-input-area textarea {
            resize: none;
            border-radius: 10px 0 0 10px;
        }

        .message-input-area .btn {
            border-radius: 0 10px 10px 0;
        }

        .chat-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            margin: -20px -20px 20px -20px;
            padding: 20px;
            border-radius: 10px 10px 0 0;
        }

        .dashboard-card {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: none;
            border-radius: 12px;
        }

        @media (max-width: 768px) {
            .chat-actions {
                display: none;
            }
            
            .message-content {
                max-width: 85%;
            }
        }
    </style>

    <script>
        // Communication Hub specific functions
        let currentPatient = 'patient1';
        let patients = {
            patient1: {
                name: 'Ahmed Mohamed',
                id: 'PAT-2024-001',
                lastSeen: 'Today',
                status: 'online',
                unreadCount: 3,
                isUrgent: false,
                lastMessage: 'Also, I\'ve been feeling a bit dizzy since starting the new medication. Is this normal?',
                lastMessageTime: 'Today 2:30 PM',
                messages: [
                    {
                        id: 1,
                        sender: 'patient',
                        message: 'Hello Dr. Ahmed, I wanted to ask about the prescription you gave me yesterday. When should I take the medication?',
                        timestamp: 'Today 10:30 AM',
                        read: true
                    },
                    {
                        id: 2,
                        sender: 'doctor',
                        message: 'Hello Ahmed! Take the medication twice daily - once in the morning with breakfast and once in the evening with dinner. Make sure to take it at the same times each day.',
                        timestamp: 'Today 11:45 AM',
                        read: true
                    },
                    {
                        id: 3,
                        sender: 'patient',
                        message: 'Thank you for the clarification! Should I continue taking my other medications as usual?',
                        timestamp: 'Today 12:15 PM',
                        read: true
                    },
                    {
                        id: 4,
                        sender: 'patient',
                        message: 'Also, I\'ve been feeling a bit dizzy since starting the new medication. Is this normal?',
                        timestamp: 'Today 2:30 PM',
                        read: false
                    }
                ]
            },
            patient2: {
                name: 'Fatima Ali', 
                id: 'PAT-2024-002',
                lastSeen: 'Yesterday',
                status: 'offline',
                unreadCount: 1,
                isUrgent: true,
                lastMessage: 'When should I take the medication?',
                lastMessageTime: '5 hours ago',
                messages: [
                    {
                        id: 1,
                        sender: 'patient',
                        message: 'When should I take the medication?',
                        timestamp: '5 hours ago',
                        read: false
                    }
                ]
            },
            patient3: {
                name: 'Omar Hassan',
                id: 'PAT-2024-003', 
                lastSeen: '2 days ago',
                status: 'offline',
                unreadCount: 0,
                isUrgent: false,
                lastMessage: 'Appointment rescheduled successfully',
                lastMessageTime: '1 day ago',
                messages: [
                    {
                        id: 1,
                        sender: 'doctor',
                        message: 'Your appointment has been rescheduled to next week Tuesday at 10 AM.',
                        timestamp: '2 days ago',
                        read: true
                    },
                    {
                        id: 2,
                        sender: 'patient',
                        message: 'Appointment rescheduled successfully',
                        timestamp: '1 day ago',
                        read: true
                    }
                ]
            },
            patient4: {
                name: 'Layla Ibrahim',
                id: 'PAT-2024-004',
                lastSeen: '3 days ago',
                status: 'offline', 
                unreadCount: 0,
                isUrgent: false,
                lastMessage: 'Lab results look good!',
                lastMessageTime: '2 days ago',
                messages: [
                    {
                        id: 1,
                        sender: 'doctor',
                        message: 'Your lab results look good! Continue with your current treatment plan.',
                        timestamp: '3 days ago',
                        read: true
                    },
                    {
                        id: 2,
                        sender: 'patient',
                        message: 'Lab results look good!',
                        timestamp: '2 days ago',
                        read: true
                    }
                ]
            }
        };

        function selectPatient(patientId) {
            currentPatient = patientId;
            
            // Update active patient in list
            document.querySelectorAll('.patient-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-patient="${patientId}"]`).classList.add('active');
            
            // Update chat header
            const patient = patients[patientId];
            document.getElementById('selectedPatientName').textContent = patient.name;
            document.querySelector('.chat-header small').textContent = `Patient ID: ${patient.id} | Last seen: ${patient.lastSeen}`;
            
            // Mark messages as read
            markMessagesAsRead(patientId);
            
            // Load patient messages
            loadPatientMessages(patientId);
        }

        function loadPatientMessages(patientId) {
            const chatMessages = document.getElementById('chatMessages');
            const patient = patients[patientId];
            
            // Clear existing messages
            chatMessages.innerHTML = '';
            
            // Load messages from patient data
            patient.messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.sender}-message`;
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <p>${msg.message}</p>
                        <small class="message-time">${msg.timestamp}</small>
                    </div>
                `;
                chatMessages.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Save messages to localStorage for persistence
            saveMessagesToStorage();
        }

        function sendMessage() {
            if (messagingSystem) {
                messagingSystem.handleSendMessage();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function markMessagesAsRead(patientId) {
            const patient = patients[patientId];
            patient.messages.forEach(msg => {
                if (msg.sender === 'patient') {
                    msg.read = true;
                }
            });
            patient.unreadCount = 0;
            updatePatientListDisplay();
            saveMessagesToStorage();
        }

        function updatePatientListDisplay() {
            const patientList = document.getElementById('patientList');
            patientList.innerHTML = '';
            
            Object.keys(patients).forEach(patientId => {
                const patient = patients[patientId];
                const patientItem = document.createElement('div');
                patientItem.className = `patient-item ${currentPatient === patientId ? 'active' : ''}`;
                patientItem.setAttribute('data-patient', patientId);
                patientItem.onclick = () => selectPatient(patientId);
                
                patientItem.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="patient-avatar me-3">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <div class="patient-info flex-grow-1">
                            <h6 class="patient-name">${patient.name}</h6>
                            <p class="last-message text-muted">${patient.lastMessage}</p>
                            <small class="text-muted">${patient.lastMessageTime}</small>
                        </div>
                        <div class="message-status">
                            ${patient.unreadCount > 0 ? `<span class="badge bg-primary">${patient.unreadCount}</span>` : ''}
                            ${patient.isUrgent ? `<span class="badge bg-danger urgent">!</span>` : ''}
                        </div>
                    </div>
                `;
                
                patientList.appendChild(patientItem);
            });
        }

        function saveMessagesToStorage() {
            localStorage.setItem('sahatak_messages', JSON.stringify(patients));
        }

        function loadMessagesFromStorage() {
            const stored = localStorage.getItem('sahatak_messages');
            if (stored) {
                patients = {...patients, ...JSON.parse(stored)};
            }
        }

        function simulatePatientResponse() {
            const responses = [
                "Thank you, Doctor!",
                "That's very helpful, I appreciate it.",
                "I understand. When should I schedule a follow-up?",
                "Got it, I'll make sure to follow your instructions.",
                "Thank you for the quick response!",
                "Should I be concerned about any side effects?"
            ];
            
            const randomDelay = Math.random() * 7000 + 3000; // 3-10 seconds
            
            setTimeout(() => {
                if (Math.random() > 0.3) { // 70% chance of response
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    const timestamp = new Date().toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                    
                    const newMessage = {
                        id: Date.now(),
                        sender: 'patient',
                        message: randomResponse,
                        timestamp: `Today ${timestamp}`,
                        read: false
                    };
                    
                    patients[currentPatient].messages.push(newMessage);
                    patients[currentPatient].lastMessage = randomResponse;
                    patients[currentPatient].lastMessageTime = 'Just now';
                    patients[currentPatient].unreadCount++;
                    
                    // Add to chat if current patient is selected
                    const chatMessages = document.getElementById('chatMessages');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message patient-message';
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <p>${randomResponse}</p>
                            <small class="message-time">Just now</small>
                        </div>
                    `;
                    chatMessages.appendChild(messageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Update displays
                    updatePatientListDisplay();
                    saveMessagesToStorage();
                    
                    // Mark as read immediately since doctor is viewing
                    markMessagesAsRead(currentPatient);
                }
            }, randomDelay);
        }

        function filterPatients(filter) {
            // Update active button
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filter patients based on criteria
            const patientItems = document.querySelectorAll('.patient-item');
            
            patientItems.forEach(item => {
                const patientId = item.getAttribute('data-patient');
                const patient = patients[patientId];
                let showPatient = true;
                
                switch(filter) {
                    case 'unread':
                        showPatient = patient.unreadCount > 0;
                        break;
                    case 'urgent':
                        showPatient = patient.isUrgent;
                        break;
                    case 'all':
                    default:
                        showPatient = true;
                }
                
                item.style.display = showPatient ? 'block' : 'none';
            });
            
            console.log(`Filtering patients: ${filter}`);
        }

        function searchPatients() {
            const search = document.getElementById('patientSearch').value.toLowerCase();
            const patientItems = document.querySelectorAll('.patient-item');
            
            patientItems.forEach(item => {
                const patientName = item.querySelector('.patient-name').textContent.toLowerCase();
                if (patientName.includes(search)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function startNewConversation() {
            alert('New conversation feature - would open patient selector modal');
        }

        function viewPatientRecord() {
            window.location.href = 'ehr.html';
        }

        function scheduleFollowUp() {
            alert('Schedule follow-up feature - would open scheduling modal');
        }

        function startVideoCall() {
            alert('Video call feature - would initiate video consultation');
        }

        function insertTemplate(template) {
            const templates = {
                greeting: "Hello! Thank you for reaching out. How can I help you today?",
                followup: "Please continue taking your medication as prescribed and let me know if you have any concerns.",
                appointment: "I would like to schedule a follow-up appointment to monitor your progress.",
                medication: "Please take your medication as prescribed: [medication name] [dosage] [frequency]. Contact me if you experience any side effects.",
                labResults: "Your lab results are ready. Overall, the results look [good/concerning]. Please schedule a follow-up appointment to discuss them in detail.",
                sideEffects: "If you experience any side effects from your medication, please contact me immediately. Common side effects include [list symptoms].",
                appointment_reminder: "This is a reminder that you have an appointment scheduled for [date] at [time]. Please arrive 15 minutes early."
            };
            
            // Create template dropdown if not exists
            if (!document.querySelector('.template-dropdown')) {
                const templateDropdown = document.createElement('div');
                templateDropdown.className = 'template-dropdown position-relative d-inline-block';
                templateDropdown.innerHTML = `
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-chat-quote me-1"></i>Templates
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="selectTemplate('greeting')">Greeting</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectTemplate('followup')">Follow-up</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectTemplate('appointment')">Appointment</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectTemplate('medication')">Medication</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectTemplate('labResults')">Lab Results</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectTemplate('sideEffects')">Side Effects</a></li>
                        <li><a class="dropdown-item" href="#" onclick="selectTemplate('appointment_reminder')">Appointment Reminder</a></li>
                    </ul>
                `;
                
                // Replace the existing template button
                const existingBtn = document.querySelector('button[onclick="insertTemplate(\'greeting\')"]');
                existingBtn.parentNode.replaceChild(templateDropdown, existingBtn);
            }
        }

        function selectTemplate(template) {
            const templates = {
                greeting: "Hello! Thank you for reaching out. How can I help you today?",
                followup: "Please continue taking your medication as prescribed and let me know if you have any concerns.",
                appointment: "I would like to schedule a follow-up appointment to monitor your progress.",
                medication: "Please take your medication as prescribed: [medication name] [dosage] [frequency]. Contact me if you experience any side effects.",
                labResults: "Your lab results are ready. Overall, the results look [good/concerning]. Please schedule a follow-up appointment to discuss them in detail.",
                sideEffects: "If you experience any side effects from your medication, please contact me immediately. Common side effects include [list symptoms].",
                appointment_reminder: "This is a reminder that you have an appointment scheduled for [date] at [time]. Please arrive 15 minutes early."
            };
            
            document.getElementById('messageInput').value = templates[template] || '';
        }

        function attachFile() {
            // Simulate file picker
            const fileTypes = ['.pdf', '.jpg', '.png', '.doc', '.docx'];
            const randomFile = `prescription_${Math.floor(Math.random() * 1000)}.pdf`;
            
            const messageInput = document.getElementById('messageInput');
            const currentMessage = messageInput.value;
            messageInput.value = currentMessage + `\n\n📎 Attached: ${randomFile}`;
            
            console.log('File attached:', randomFile);
        }

        function insertPrescription() {
            const prescriptionTemplate = `
📋 PRESCRIPTION

Patient: ${patients[currentPatient].name}
Date: ${new Date().toLocaleDateString()}

Medication: [Medication Name]
Dosage: [Dosage Amount]
Frequency: [Times per day]
Duration: [Treatment duration]

Instructions: [Special instructions]

Please take this prescription to your pharmacy.
Contact me if you have any questions or concerns.

Dr. Sarah Ahmed
            `.trim();
            
            document.getElementById('messageInput').value = prescriptionTemplate;
        }

        function broadcastMessage() {
            const message = prompt('Enter broadcast message to send to all patients:');
            if (message) {
                const timestamp = new Date().toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
                
                // Send to all patients
                Object.keys(patients).forEach(patientId => {
                    const broadcastMsg = {
                        id: Date.now() + Math.random(),
                        sender: 'doctor',
                        message: message,
                        timestamp: `Today ${timestamp}`,
                        read: true
                    };
                    
                    patients[patientId].messages.push(broadcastMsg);
                    patients[patientId].lastMessage = message;
                    patients[patientId].lastMessageTime = 'Just now';
                });
                
                updatePatientListDisplay();
                saveMessagesToStorage();
                
                alert(`Broadcast message sent to ${Object.keys(patients).length} patients`);
            }
        }

        function scheduleReminder() {
            const reminderText = prompt('Enter reminder message:');
            if (reminderText) {
                const reminderTime = prompt('Reminder time (e.g., "2 hours", "tomorrow 9 AM"):');
                if (reminderTime) {
                    alert(`Reminder scheduled: "${reminderText}" for ${reminderTime}`);
                    console.log('Reminder scheduled:', {
                        patient: currentPatient,
                        message: reminderText,
                        time: reminderTime
                    });
                }
            }
        }

        function viewMessageHistory() {
            const patient = patients[currentPatient];
            const historyWindow = window.open('', '_blank', 'width=800,height=600');
            
            historyWindow.document.write(`
                <html>
                <head><title>Message History - ${patient.name}</title></head>
                <body style="font-family: Arial, sans-serif; padding: 20px;">
                    <h2>Message History: ${patient.name}</h2>
                    <p>Patient ID: ${patient.id}</p>
                    <hr>
                    <div>
                        ${patient.messages.map(msg => `
                            <div style="margin: 10px 0; padding: 10px; background: ${msg.sender === 'doctor' ? '#e3f2fd' : '#f5f5f5'}; border-radius: 8px;">
                                <strong>${msg.sender === 'doctor' ? 'Dr. Sarah Ahmed' : patient.name}:</strong><br>
                                ${msg.message}<br>
                                <small style="color: #666;">${msg.timestamp}</small>
                            </div>
                        `).join('')}
                    </div>
                </body>
                </html>
            `);
        }

        function exportChat() {
            const patient = patients[currentPatient];
            const chatData = {
                patient: patient.name,
                patientId: patient.id,
                exportDate: new Date().toISOString(),
                messages: patient.messages
            };
            
            const blob = new Blob([JSON.stringify(chatData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat_${patient.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Profile and settings functions - standardized across all doctor pages
        function showProfile() {
            // Check if we're on the main dashboard page
            if (window.location.pathname.includes('dashboard/doctor.html')) {
                // On dashboard - show profile section directly
                const profileSection = document.getElementById('profile-section');
                const settingsSection = document.getElementById('settings-section');
                
                if (profileSection && settingsSection) {
                    settingsSection.style.display = 'none';
                    profileSection.style.display = profileSection.style.display === 'none' ? 'block' : 'none';
                    
                    if (profileSection.style.display === 'block') {
                        profileSection.scrollIntoView({ behavior: 'smooth' });
                        loadUserProfile();
                    }
                    return;
                }
            }
            
            // On other pages - redirect to dashboard and show profile
            sessionStorage.setItem('sahatak_show_profile_on_load', 'true');
            window.location.href = '../../dashboard/doctor.html';
        }
        
        function showSettings() {
            // Check if we're on the main dashboard page
            if (window.location.pathname.includes('dashboard/doctor.html')) {
                // On dashboard - show settings section directly
                const settingsSection = document.getElementById('settings-section');
                const profileSection = document.getElementById('profile-section');
                
                if (settingsSection && profileSection) {
                    profileSection.style.display = 'none';
                    settingsSection.style.display = settingsSection.style.display === 'none' ? 'block' : 'none';
                    
                    if (settingsSection.style.display === 'block') {
                        settingsSection.scrollIntoView({ behavior: 'smooth' });
                        loadUserSettings();
                    }
                    return;
                }
            }
            
            // On other pages - redirect to dashboard and show settings
            sessionStorage.setItem('sahatak_show_settings_on_load', 'true');
            window.location.href = '../../dashboard/doctor.html';
        }
        
        function logout() {
            AuthGuard.logout();
        }

        // Initialize messaging system
        let messagingSystem;
        let currentPatientId = null;

        // Initialize messaging system for doctor
        async function initializeDoctorMessaging() {
            try {
                messagingSystem = new MessagingSystem();
                await messagingSystem.initialize(); // Initialize without specific patient
                
                // Load all conversations for this doctor
                await loadDoctorConversations();
                
                Logger.info('Doctor messaging initialized');
            } catch (error) {
                Logger.error('Failed to initialize doctor messaging', error);
                showErrorMessage('Failed to load messaging system. Please refresh the page.');
            }
        }

        // Load all conversations for doctor
        async function loadDoctorConversations() {
            try {
                const conversations = await messagingSystem.loadConversations();
                displayConversationsAsPatients(conversations);
            } catch (error) {
                Logger.error('Failed to load conversations', error);
            }
        }

        // Display conversations as patient list
        function displayConversationsAsPatients(conversations) {
            const patientList = document.getElementById('patientList');
            patientList.innerHTML = '';
            
            conversations.forEach((conversation, index) => {
                const patient = conversation.other_participant;
                const patientItem = document.createElement('div');
                patientItem.className = `patient-item ${index === 0 ? 'active' : ''}`;
                patientItem.setAttribute('data-conversation', conversation.id);
                patientItem.onclick = () => selectPatientConversation(conversation.id, patient.id);
                
                patientItem.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="patient-avatar me-3">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <div class="patient-info flex-grow-1">
                            <h6 class="patient-name">${patient.full_name || patient.first_name + ' ' + patient.last_name}</h6>
                            <p class="last-message text-muted">${conversation.last_message_content || 'No messages yet'}</p>
                            <small class="text-muted">${conversation.last_message_at ? messagingSystem.formatTimestamp(conversation.last_message_at) : ''}</small>
                        </div>
                        ${conversation.unread_count > 0 ? 
                            `<div class="message-badge">${conversation.unread_count > 99 ? '99+' : conversation.unread_count}</div>` : ''
                        }
                    </div>
                `;
                
                patientList.appendChild(patientItem);
            });
            
            // Select first conversation if available
            if (conversations.length > 0) {
                selectPatientConversation(conversations[0].id, conversations[0].other_participant.id);
            }
        }

        // Select patient conversation
        async function selectPatientConversation(conversationId, patientId) {
            try {
                currentPatientId = patientId;
                messagingSystem.currentConversationId = conversationId;
                
                // Update UI
                document.querySelectorAll('.patient-item').forEach(item => item.classList.remove('active'));
                document.querySelector(`[data-conversation="${conversationId}"]`).classList.add('active');
                
                // Load messages for this conversation
                await messagingSystem.loadMessages();
                
                // Mark as read
                await messagingSystem.markAsRead(conversationId);
                
                Logger.info('Selected patient conversation', { conversationId, patientId });
            } catch (error) {
                Logger.error('Failed to select patient conversation', error);
                showErrorMessage('Failed to load patient messages');
            }
        }

        function showErrorMessage(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container-fluid');
            if (container) {
                container.insertBefore(alertDiv, container.firstChild);
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            AuthGuard.protectPage('doctor');
            
            // Initialize translations
            const currentLang = localStorage.getItem('sahatak_language') || 'ar';
            if (typeof LanguageManager !== 'undefined' && LanguageManager.translations[currentLang]) {
                const t = LanguageManager.translations[currentLang];
                if (typeof DashboardTranslations !== 'undefined' && DashboardTranslations.updateFooter) {
                    DashboardTranslations.updateFooter(t);
                }
            }
            
            // Initialize real messaging system
            await initializeDoctorMessaging();
            
            // Setup template dropdown
            setTimeout(() => {
                insertTemplate();
            }, 100);
        });
    </script>
</body>
</html>