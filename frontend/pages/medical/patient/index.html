<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Medical Records | Sahatak</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='%230d47a1' d='m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523.942-.661 2.27.067 3.71L8 15.5l6.533-8.737c.728-1.44.59-2.768.067-3.71C13.486.878 10.4.28 8.717 2.01L8 2.748z'/></svg>">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Arabic Font -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../../assets/css/main.css">
    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="../../../assets/css/components/dashboard.css">
    <link rel="stylesheet" href="../../../assets/css/components/medical-records.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="container-fluid">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="row align-items-center">
                    <!-- Profile Section - Left (Right in RTL) -->
                    <div class="col-lg-4">
                        <div class="profile-section">
                            <div class="user-avatar">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            <div class="user-details">
                                <h5 class="mb-1" id="user-name">User Name</h5>
                            </div>
                            <!-- Vertical Action Buttons -->
                            <div class="action-buttons">
                                <button class="btn btn-action" onclick="goToDashboard()" title="Dashboard">
                                    <i class="bi bi-house"></i>
                                    <span id="nav-dashboard">Dashboard</span>
                                </button>
                                <button class="btn btn-action btn-logout" onclick="AuthGuard.logout()" title="Logout">
                                    <i class="bi bi-box-arrow-right"></i>
                                    <span id="btn-logout">Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dashboard Title - Center -->
                    <div class="col-lg-4 text-center">
                        <h1 class="dashboard-title" id="records-title">Medical Records</h1>
                        <p class="dashboard-subtitle" id="records-subtitle">Comprehensive management of medical history and prescriptions</p>
                    </div>
                    
                    <!-- Language Selector - Right (Left in RTL) -->
                    <div class="col-lg-4 text-end">
                        <button class="btn btn-outline-medical btn-sm" onclick="showLanguageSelector()" id="language-toggle">
                            <i class="bi bi-globe me-1"></i>
                            <span id="current-lang">English</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">

        <!-- Quick Stats -->
        <div class="row mb-5">
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <i class="bi bi-file-medical stat-icon text-primary"></i>
                    <div class="stat-value" id="history-completion">--</div>
                    <div class="stat-label" id="stat-history-completion">Medical History Completion</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <i class="bi bi-prescription2 stat-icon text-success"></i>
                    <div class="stat-value" id="active-prescriptions-count">--</div>
                    <div class="stat-label" id="stat-active-prescriptions">Active Prescriptions</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <i class="bi bi-clock-history stat-icon text-info"></i>
                    <div class="stat-value" id="recent-updates-count">--</div>
                    <div class="stat-label" id="stat-recent-updates">Recent Updates</div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <i class="bi bi-calendar-check stat-icon text-warning"></i>
                    <div class="stat-value" id="last-update-days">--</div>
                    <div class="stat-label" id="stat-days-since-update">Days Since Last Update</div>
                </div>
            </div>
        </div>

        <!-- Main Navigation Cards -->
        <div class="row">
            <!-- Medical History Card -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100 border-0 medical-nav-card">
                    <div class="card-header text-white" style="background: #0d47a1 !important;">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-clipboard-medical me-2"></i>
                            <span id="medical-history-card-title">Medical History</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <p class="card-text mb-3" id="medical-history-card-desc">View and manage complete medical history and timeline of updates</p>
                                
                                <div class="medical-summary mb-3" id="medical-summary-preview">
                                    <small class="text-muted" id="medical-loading-text">Loading...</small>
                                </div>
                                
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="goToMedicalHistory()" id="view-complete-history-btn">View Complete History</button>
                                    <button class="btn btn-outline-success btn-sm" onclick="updateMedicalHistory()" id="update-history-btn">Update Data</button>
                                </div>
                            </div>
                            <div class="col-4 text-center">
                                <i class="bi bi-file-medical display-4 text-primary opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prescriptions Card -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100 border-0 medical-nav-card">
                    <div class="card-header text-white" style="background: #0d47a1 !important;">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-prescription2 me-2"></i>
                            <span id="prescriptions-card-title">Prescriptions</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-8">
                                <p class="card-text mb-3" id="prescriptions-card-desc">Manage medical prescriptions and current and completed medications</p>
                                
                                <div class="prescription-summary mb-3" id="prescription-summary-preview">
                                    <small class="text-muted" id="prescription-loading-text">Loading...</small>
                                </div>
                                
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="goToPrescriptions()" id="view-all-prescriptions-btn">View All Prescriptions</button>
                                    <button class="btn btn-outline-success btn-sm" onclick="goToPrescriptions('?status=active')" id="active-prescriptions-btn">Active Prescriptions</button>
                                </div>
                            </div>
                            <div class="col-4 text-center">
                                <i class="bi bi-prescription2 display-4 text-success opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="row">
            <div class="col-12">
                <div class="card recent-activity">
                    <div class="card-header text-white d-flex justify-content-between align-items-center" style="background: #0d47a1 !important;">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-activity me-2"></i>
                            <span id="recent-activity-title">Recent Activity</span>
                        </h5>
                        <small class="text-white-50" id="activity-count">
                            <!-- Activity count will be populated here -->
                        </small>
                    </div>
                    <div class="card-body">
                        <div id="recent-activity">
                            <div class="loading-state">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden" id="spinner-loading-text">Loading...</span>
                                </div>
                                <p class="mt-3" id="loading-activity-text">Loading recent activity...</p>
                            </div>
                        </div>
                        
                        <!-- Pagination Controls -->
                        <div id="activity-pagination" class="d-none">
                            <hr>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="pagination-info">
                                    <small class="text-muted" id="pagination-info-text">
                                        <!-- Pagination info will be populated here -->
                                    </small>
                                </div>
                                <div class="pagination-controls">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" id="prev-page-btn" onclick="previousActivityPage()">
                                            <i class="bi bi-chevron-left"></i>
                                            <span id="prev-text">Previous</span>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" id="next-page-btn" onclick="nextActivityPage()">
                                            <span id="next-text">Next</span>
                                            <i class="bi bi-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="../../../assets/js/main.js"></script>
    <script src="../../../assets/js/components/auth-guard.js"></script>
    <script src="../../../assets/js/components/dashboard-translations.js"></script>
    <script src="../../../assets/js/components/medical-records.js"></script>
    
    <script>
        let userType = null;
        let medicalData = null;
        let prescriptionData = null;
        
        // Pagination state for Recent Activity
        let currentActivityPage = 1;
        const activitiesPerPage = 5;
        let totalActivities = [];
        let filteredActivities = [];
        
        // All translations are handled by dashboard-translations.js

        // Initialize records dashboard on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸ”§ Medical Records: Starting initialization...');
            
            // Load translations first
            await LanguageManager.loadTranslations();
            console.log('ðŸŒ Medical Records: Translations loaded');
            
            // Get saved language
            const savedLanguage = LanguageManager.getLanguage() || 'ar';
            console.log('ðŸ”¤ Medical Records: Using language:', savedLanguage);
            
            // Check if translations exist
            const translations = LanguageManager.translations[savedLanguage];
            console.log('ðŸ“š Medical Records: Available translation sections:', translations ? Object.keys(translations) : 'NONE');
            console.log('ðŸ“‹ Medical Records: Records section exists:', !!translations?.records);
            
            await DashboardTranslations.initializeDashboard('records');
            console.log('âœ… Medical Records: Dashboard initialization completed');
            
            // Set up event listeners
            setupEventListeners();
            
            // Load overview data after initialization
            setTimeout(async () => {
                await loadOverviewData();
            }, 500);
        });



        // Setup event listeners
        function setupEventListeners() {
            // Update history button
            document.getElementById('update-history-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                goToMedicalHistory();
            });

            // Active prescriptions button
            document.getElementById('active-prescriptions-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                goToPrescriptions('?status=active');
            });
        }

        // Load overview data
        async function loadOverviewData() {
            try {
                // Get current user to get patient ID
                const user = await getCurrentUser();
                let patientId = null;
                
                console.log('Current user data:', user);
                
                // Handle different user data structures
                let userData = null;
                if (user && user.user) {
                    userData = user.user;
                } else if (user) {
                    userData = user;
                }
                
                console.log('Processed user data:', userData);
                
                if (userData && userData.user_type === 'patient') {
                    // Extract Patient Profile ID from user.profile.id
                    patientId = userData.profile?.id || userData.patient_profile?.id || userData.id;
                    console.log('Patient ID extracted:', patientId);
                    console.log('User ID vs Patient Profile ID:', userData.id, 'vs', patientId);
                } else {
                    console.error('User is not a patient or user data not available');
                    console.error('User data:', userData);
                    console.error('User type:', userData?.user_type);
                    showError('Unable to load patient data');
                    return;
                }

                // Load medical history data using the correct endpoint
                const medicalResult = await ApiHelper.makeRequest(`/medical-history/patient/${patientId}`);
                if (medicalResult.success) {
                    medicalData = {
                        medicalHistory: medicalResult.data.patient_medical_history,
                        historyUpdates: medicalResult.data.recent_updates || []
                    };
                    updateMedicalSummary();
                } else {
                    console.error('Failed to load medical history:', medicalResult.message);
                    // Show placeholder data if medical history not accessible
                    medicalData = null;
                    updateMedicalSummary();
                }

                // Load prescription data
                const prescriptionResult = await PrescriptionsAPI.getPrescriptions({ perPage: 50 });
                if (prescriptionResult.success) {
                    prescriptionData = prescriptionResult.data;
                    updatePrescriptionSummary();
                }

                // Load prescription stats
                const statsResult = await PrescriptionsAPI.getPrescriptionStats();
                if (statsResult.success) {
                    updateStats(statsResult.data);
                } else {
                    // If stats API fails, calculate basic stats from available data
                    updateStats({
                        active_prescriptions: prescriptionData ? (prescriptionData.prescriptions || []).filter(p => p.status === 'active').length : 0
                    });
                }

                // Load recent activity
                await loadRecentActivity();
                
                // Ensure stats are updated even if some API calls failed
                if (!document.getElementById('history-completion').textContent || document.getElementById('history-completion').textContent === '--') {
                    updateStats();
                }
            } catch (error) {
                console.error('Error loading overview data:', error);
                showError('Error loading overview data');
                
                // Still try to show whatever data we have
                updateStats();
            }
        }

        // Update medical summary
        function updateMedicalSummary() {
            const container = document.getElementById('medical-summary-preview');
            
            if (!medicalData || !medicalData.medicalHistory) {
                container.innerHTML = '<small class="text-warning">Medical history incomplete</small>';
                return;
            }

            const history = medicalData.medicalHistory;
            const bmi = MedicalRecordsUtils.calculateBMI(history.height, history.weight);
            const bmiStatus = MedicalRecordsUtils.getBMIStatus(bmi);

            const summaryHtml = `
                <div class="row text-center">
                    <div class="col-4">
                        <div class="bg-light rounded p-2 mb-1">
                            <small class="text-muted d-block">Blood Type</small>
                            <strong>${history.blood_type || '--'}</strong>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="bg-light rounded p-2 mb-1">
                            <small class="text-muted d-block">Weight</small>
                            <strong>${history.weight ? history.weight + ' kg' : '--'}</strong>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="bg-light rounded p-2 mb-1" style="background-color: ${bmiStatus.color}15 !important">
                            <small class="text-muted d-block">BMI</small>
                            <strong style="color: ${bmiStatus.color}">${bmi || '--'}</strong>
                        </div>
                    </div>
                </div>
                <small class="text-muted">
                    Last updated: ${history.medical_history_last_updated ? 
                        new Date(history.medical_history_last_updated).toLocaleDateString() : 
                        'Not updated'}
                </small>
            `;

            container.innerHTML = summaryHtml;
        }

        // Update prescription summary
        function updatePrescriptionSummary() {
            const container = document.getElementById('prescription-summary-preview');
            
            if (!prescriptionData || !prescriptionData.prescriptions) {
                container.innerHTML = '<small class="text-muted">No prescriptions found</small>';
                return;
            }

            const prescriptions = prescriptionData.prescriptions;
            const activePrescriptions = prescriptions.filter(p => p.status === 'active');
            const expiringSoon = activePrescriptions.filter(p => {
                if (!p.end_date) return false;
                const endDate = new Date(p.end_date);
                return endDate <= new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
            });

            const summaryHtml = `
                <div class="row text-center">
                    <div class="col-4">
                        <div class="bg-light rounded p-2 mb-1">
                            <small class="text-muted d-block">Total</small>
                            <strong>${prescriptions.length}</strong>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="bg-light rounded p-2 mb-1">
                            <small class="text-muted d-block">Active</small>
                            <strong class="text-success">${activePrescriptions.length}</strong>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="bg-light rounded p-2 mb-1">
                            <small class="text-muted d-block">Expiring Soon</small>
                            <strong class="text-warning">${expiringSoon.length}</strong>
                        </div>
                    </div>
                </div>
                ${expiringSoon.length > 0 ? 
                    '<small class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Prescriptions expiring soon</small>' : 
                    '<small class="text-muted">All prescriptions current</small>'}
            `;

            container.innerHTML = summaryHtml;
        }

        // Update stats - Enhanced with proper calculations
        function updateStats(stats = {}) {
            console.log('Updating stats with:', stats);
            console.log('Medical data available:', !!medicalData);
            console.log('Prescription data available:', !!prescriptionData);

            // 1. Calculate completion percentage
            let completionPercentage = 0;
            if (medicalData && medicalData.medicalHistory) {
                const requiredFields = ['medical_history', 'allergies', 'current_medications', 'blood_type', 'height', 'weight'];
                const completedRequired = requiredFields.filter(field => {
                    const value = medicalData.medicalHistory[field];
                    return value && value.toString().trim() !== '';
                }).length;
                completionPercentage = Math.round((completedRequired / requiredFields.length) * 100);
            }

            // 2. Calculate active prescriptions count
            let activePrescriptionsCount = 0;
            if (stats.active_prescriptions !== undefined) {
                activePrescriptionsCount = stats.active_prescriptions;
            } else if (prescriptionData && prescriptionData.prescriptions) {
                activePrescriptionsCount = prescriptionData.prescriptions.filter(p => p.status === 'active').length;
            }

            // 3. Calculate recent updates count (medical + prescription updates in last 30 days)
            let recentUpdatesCount = 0;
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            // Count medical history updates
            if (medicalData && medicalData.historyUpdates) {
                recentUpdatesCount += medicalData.historyUpdates.filter(update => 
                    new Date(update.created_at) >= thirtyDaysAgo
                ).length;
            }

            // Count recent prescriptions
            if (prescriptionData && prescriptionData.prescriptions) {
                recentUpdatesCount += prescriptionData.prescriptions.filter(prescription => 
                    new Date(prescription.created_at) >= thirtyDaysAgo
                ).length;
            }

            // 4. Calculate days since last update
            let daysSinceUpdate = 'Never';
            let mostRecentDate = null;

            // Check medical history last updated
            if (medicalData && medicalData.medicalHistory && medicalData.medicalHistory.medical_history_last_updated) {
                mostRecentDate = new Date(medicalData.medicalHistory.medical_history_last_updated);
            }

            // Check most recent prescription
            if (prescriptionData && prescriptionData.prescriptions && prescriptionData.prescriptions.length > 0) {
                const mostRecentPrescription = prescriptionData.prescriptions
                    .map(p => new Date(p.created_at))
                    .sort((a, b) => b - a)[0];
                
                if (!mostRecentDate || mostRecentPrescription > mostRecentDate) {
                    mostRecentDate = mostRecentPrescription;
                }
            }

            if (mostRecentDate) {
                const today = new Date();
                const diffTime = today - mostRecentDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    daysSinceUpdate = 'Today';
                } else if (diffDays === 1) {
                    daysSinceUpdate = '1 day ago';
                } else {
                    daysSinceUpdate = `${diffDays} days ago`;
                }
            }

            // Update display elements
            const elements = {
                'history-completion': `${completionPercentage}%`,
                'active-prescriptions-count': activePrescriptionsCount.toString(),
                'recent-updates-count': recentUpdatesCount.toString(),
                'last-update-days': daysSinceUpdate
            };

            Object.keys(elements).forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = elements[id];
                    console.log(`Updated ${id}: ${elements[id]}`);
                } else {
                    console.warn(`Element not found: ${id}`);
                }
            });
        }

        // Load recent activity
        async function loadRecentActivity() {
            const container = document.getElementById('recent-activity');
            
            try {
                totalActivities = []; // Reset the global activities array

                // Add appointment activities - Enhanced with all statuses and proper timestamps
                try {
                    const appointmentsResponse = await ApiHelper.makeRequest('/appointments/');
                    if (appointmentsResponse.success) {
                        const appointments = appointmentsResponse.data.appointments || [];
                        console.log(`Processing ${appointments.length} appointments for recent activity`);
                        
                        // Process each appointment to extract status changes and events
                        appointments.forEach(apt => {
                            const appointmentDate = new Date(apt.appointment_date);
                            const createdDate = new Date(apt.created_at || apt.appointment_date);
                            const updatedDate = new Date(apt.updated_at || apt.created_at || apt.appointment_date);
                            const now = new Date();
                            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                            
                            // 1. Appointment Scheduled/Created (if within last 30 days)
                            if (createdDate >= thirtyDaysAgo) {
                                totalActivities.push({
                                    type: 'appointment_scheduled',
                                    date: createdDate,
                                    title: 'New Appointment Scheduled',
                                    description: `Appointment with ${apt.doctor_name || 'Doctor'} scheduled for ${appointmentDate.toLocaleDateString('en-US', { 
                                        weekday: 'short', 
                                        month: 'short', 
                                        day: 'numeric'
                                    })} at ${appointmentDate.toLocaleTimeString('en-US', {
                                        hour: 'numeric',
                                        minute: '2-digit',
                                        hour12: true
                                    })}`,
                                    icon: 'bi-calendar-plus',
                                    color: 'bg-primary'
                                });
                            }

                            // 2. Status-based activities (if status changed within last 30 days)
                            if (updatedDate >= thirtyDaysAgo) {
                                switch (apt.status) {
                                    case 'confirmed':
                                        if (updatedDate > createdDate) { // Only if confirmed after creation
                                            totalActivities.push({
                                                type: 'appointment_confirmed',
                                                date: updatedDate,
                                                title: 'Appointment Confirmed',
                                                description: `Appointment with ${apt.doctor_name || 'Doctor'} has been confirmed`,
                                                icon: 'bi-check-circle',
                                                color: 'bg-info'
                                            });
                                        }
                                        break;
                                    
                                    case 'completed':
                                        totalActivities.push({
                                            type: 'appointment_completed',
                                            date: updatedDate,
                                            title: 'Consultation Completed',
                                            description: `Medical consultation completed with ${apt.doctor_name || 'Doctor'}${apt.diagnosis ? '. Diagnosis recorded.' : ''}`,
                                            icon: 'bi-check-circle-fill',
                                            color: 'bg-success'
                                        });
                                        break;
                                    
                                    case 'cancelled':
                                        totalActivities.push({
                                            type: 'appointment_cancelled',
                                            date: updatedDate,
                                            title: 'Appointment Cancelled',
                                            description: `Appointment with ${apt.doctor_name || 'Doctor'} was cancelled${apt.cancellation_reason ? '. Reason: ' + apt.cancellation_reason : ''}`,
                                            icon: 'bi-x-circle-fill',
                                            color: 'bg-warning'
                                        });
                                        break;
                                    
                                    case 'no-show':
                                        totalActivities.push({
                                            type: 'appointment_missed',
                                            date: updatedDate,
                                            title: 'Appointment Missed',
                                            description: `Missed appointment with ${apt.doctor_name || 'Doctor'}`,
                                            icon: 'bi-exclamation-triangle-fill',
                                            color: 'bg-danger'
                                        });
                                        break;
                                    
                                    case 'in_progress':
                                        totalActivities.push({
                                            type: 'appointment_started',
                                            date: updatedDate,
                                            title: 'Consultation Started',
                                            description: `Consultation with ${apt.doctor_name || 'Doctor'} is now in progress`,
                                            icon: 'bi-play-circle-fill',
                                            color: 'bg-info'
                                        });
                                        break;

                                    case 'rescheduled':
                                        totalActivities.push({
                                            type: 'appointment_rescheduled',
                                            date: updatedDate,
                                            title: 'Appointment Rescheduled',
                                            description: `Appointment with ${apt.doctor_name || 'Doctor'} has been rescheduled`,
                                            icon: 'bi-calendar-event',
                                            color: 'bg-secondary'
                                        });
                                        break;
                                }
                            }

                            // 3. Add special activities for video appointments
                            if (apt.appointment_type === 'video' && apt.status === 'confirmed') {
                                totalActivities.push({
                                    type: 'video_appointment_ready',
                                    date: createdDate,
                                    title: 'Video Consultation Ready',
                                    description: `Video consultation with ${apt.doctor_name || 'Doctor'} is ready to join`,
                                    icon: 'bi-camera-video-fill',
                                    color: 'bg-info'
                                });
                            }
                        });

                        console.log(`Generated ${totalActivities.filter(a => a.type.startsWith('appointment')).length} appointment activities`);
                    }
                } catch (error) {
                    console.error('Error loading appointments for activity:', error);
                }

                // Add medical history updates and EHR changes made by doctors
                if (medicalData && medicalData.historyUpdates) {
                    medicalData.historyUpdates.forEach(update => {
                        totalActivities.push({
                            type: 'medical_update',
                            date: new Date(update.created_at),
                            title: MedicalRecordsUtils.getUpdateTypeInfo(update.update_type).title,
                            description: update.notes || 'Medical history update',
                            icon: MedicalRecordsUtils.getUpdateTypeInfo(update.update_type).icon,
                            color: MedicalRecordsUtils.getUpdateTypeInfo(update.update_type).class
                        });
                    });
                }

                // Add EHR changes made by doctors from EHR endpoint
                try {
                    const user = await getCurrentUser();
                    // Handle different user data structures
                    let userData = null;
                    if (user && user.user) {
                        userData = user.user;
                    } else if (user) {
                        userData = user;
                    }
                    
                    if (userData && userData.user_type === 'patient') {
                        // Use user ID - backend will resolve to patient profile
                        const ehrResponse = await ApiHelper.makeRequest(`/ehr/patient/${userData.id}`);
                        if (ehrResponse.success && ehrResponse.data.ehr) {
                            const ehrData = ehrResponse.data.ehr;
                            
                            // Add vital signs updates by doctors
                            if (ehrData.vital_signs) {
                                ehrData.vital_signs.forEach(vital => {
                                    if (vital.recorded_by_doctor_id) {
                                        totalActivities.push({
                                            type: 'vital_signs_update',
                                            date: new Date(vital.measured_at || vital.created_at),
                                            title: 'Vital Signs Updated by Doctor',
                                            description: `Doctor recorded: ${[
                                                vital.blood_pressure && `BP ${vital.blood_pressure}`,
                                                vital.heart_rate && `HR ${vital.heart_rate}`,
                                                vital.temperature && `Temp ${vital.temperature}Â°C`,
                                                vital.respiratory_rate && `RR ${vital.respiratory_rate}`,
                                                vital.oxygen_saturation && `O2 ${vital.oxygen_saturation}%`,
                                                vital.bmi && `BMI ${vital.bmi}`
                                            ].filter(Boolean).join(', ')}`,
                                            icon: 'bi-activity',
                                            color: 'bg-info'
                                        });
                                    }
                                });
                            }
                            
                            // Add diagnosis updates by doctors
                            if (ehrData.diagnoses) {
                                ehrData.diagnoses.forEach(diagnosis => {
                                    totalActivities.push({
                                        type: 'diagnosis_update',
                                        date: new Date(diagnosis.diagnosis_date || diagnosis.created_at),
                                        title: 'Diagnosis Added by Doctor',
                                        description: `${diagnosis.primary_diagnosis}${diagnosis.secondary_diagnoses ? ' | ' + diagnosis.secondary_diagnoses : ''}`,
                                        icon: 'bi-clipboard-medical-fill',
                                        color: 'bg-primary'
                                    });
                                });
                            }
                            
                            // Add medical history updates by doctors
                            if (ehrData.medical_history_updates) {
                                ehrData.medical_history_updates.forEach(update => {
                                    totalActivities.push({
                                        type: 'ehr_history_update',
                                        date: new Date(update.created_at),
                                        title: 'Medical Record Updated by Doctor',
                                        description: `${update.doctor_name || 'Doctor'} updated ${update.update_type}: ${update.notes || 'Medical record changes'}`,
                                        icon: 'bi-file-earmark-medical-fill',
                                        color: 'bg-success'
                                    });
                                });
                            }
                            
                            console.log(`Added ${ehrData.vital_signs?.length || 0} vital signs, ${ehrData.diagnoses?.length || 0} diagnoses, ${ehrData.medical_history_updates?.length || 0} EHR updates from doctor activities`);
                        }
                    }
                } catch (error) {
                    console.error('Error loading EHR data for recent activity:', error);
                }

                // Add recent prescriptions
                if (prescriptionData && prescriptionData.prescriptions) {
                    prescriptionData.prescriptions.forEach(prescription => {
                        totalActivities.push({
                            type: 'prescription',
                            date: new Date(prescription.created_at),
                            title: 'New prescription',
                            description: `${prescription.medication_name} - ${prescription.dosage}`,
                            icon: 'bi-prescription2',
                            color: 'bg-success'
                        });
                    });
                }

                // Sort by date (newest first)
                totalActivities.sort((a, b) => b.date - a.date);

                // Reset to first page and render
                currentActivityPage = 1;
                renderActivityPage();
            } catch (error) {
                console.error('Error loading recent activity:', error);
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-exclamation-circle me-2"></i>
                        Error loading recent activity
                    </div>
                `;
            }
        }

        // Navigation functions
        function goToMedicalHistory() {
            window.location.href = 'medicalHistory.html';
        }

        function updateMedicalHistory() {
            window.location.href = 'medicalHistoryForm.html';
        }

        function goToPrescriptions(params = '') {
            window.location.href = 'prescriptions.html' + params;
        }

        // Helper functions
        async function getCurrentUser() {
            try {
                const response = await ApiHelper.makeRequest('/users/profile');
                return response.success ? response.data : null;
            } catch (error) {
                console.error('Error getting current user:', error);
                return null;
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            errorDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
            errorDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        function goBack() {
            window.history.back();
        }

        function goToDashboard() {
            const dashboardUrl = userType === 'doctor' ? '../../dashboard/doctor.html' : '../../dashboard/patient.html';
            window.location.href = dashboardUrl;
        }

        // Pagination Functions for Recent Activity
        function renderActivityPage() {
            const container = document.getElementById('recent-activity');
            const paginationContainer = document.getElementById('activity-pagination');
            const activityCountElement = document.getElementById('activity-count');
            
            if (totalActivities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state text-center py-4">
                        <i class="bi bi-activity display-4 text-muted mb-3"></i>
                        <h6 class="text-muted">No Recent Activity</h6>
                        <p class="text-muted">Activity and updates will appear here</p>
                    </div>
                `;
                paginationContainer.classList.add('d-none');
                activityCountElement.textContent = '';
                return;
            }

            // Calculate pagination
            const startIndex = (currentActivityPage - 1) * activitiesPerPage;
            const endIndex = startIndex + activitiesPerPage;
            const pageActivities = totalActivities.slice(startIndex, endIndex);
            const totalPages = Math.ceil(totalActivities.length / activitiesPerPage);

            // Update activity count
            activityCountElement.textContent = `${totalActivities.length} total activities`;

            // Render activities for current page
            const activitiesHtml = pageActivities.map(activity => `
                <div class="activity-item d-flex align-items-center py-3 border-bottom">
                    <div class="activity-icon me-3">
                        <div class="rounded-circle ${activity.color} d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                            <i class="bi ${activity.icon} text-white"></i>
                        </div>
                    </div>
                    <div class="activity-content flex-grow-1">
                        <h6 class="mb-1" style="color: #000000;">${activity.title}</h6>
                        <p class="text-muted small mb-1" style="color: #374151 !important;">${activity.description}</p>
                        <small class="text-muted" style="color: #374151 !important;">
                            <i class="bi bi-clock me-1"></i>
                            ${activity.date.toLocaleDateString('en-US', { 
                                weekday: 'short',
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric' 
                            })} at ${activity.date.toLocaleTimeString('en-US', {
                                hour: 'numeric', 
                                minute: '2-digit',
                                hour12: true
                            })}
                        </small>
                    </div>
                </div>
            `).join('');

            container.innerHTML = activitiesHtml;

            // Update pagination controls
            if (totalPages > 1) {
                paginationContainer.classList.remove('d-none');
                updatePaginationControls(totalPages);
            } else {
                paginationContainer.classList.add('d-none');
            }
        }

        function updatePaginationControls(totalPages) {
            const paginationInfo = document.getElementById('pagination-info-text');
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');

            // Update pagination info
            const startItem = (currentActivityPage - 1) * activitiesPerPage + 1;
            const endItem = Math.min(currentActivityPage * activitiesPerPage, totalActivities.length);
            paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${totalActivities.length} activities`;

            // Update button states
            prevBtn.disabled = currentActivityPage <= 1;
            nextBtn.disabled = currentActivityPage >= totalPages;
            
            if (currentActivityPage <= 1) {
                prevBtn.classList.add('disabled');
            } else {
                prevBtn.classList.remove('disabled');
            }
            
            if (currentActivityPage >= totalPages) {
                nextBtn.classList.add('disabled');
            } else {
                nextBtn.classList.remove('disabled');
            }
        }

        function previousActivityPage() {
            if (currentActivityPage > 1) {
                currentActivityPage--;
                renderActivityPage();
            }
        }

        function nextActivityPage() {
            const totalPages = Math.ceil(totalActivities.length / activitiesPerPage);
            if (currentActivityPage < totalPages) {
                currentActivityPage++;
                renderActivityPage();
            }
        }
        
        // Use the global language switching function
    </script>


    <!-- Footer -->
    <footer class="footer mt-auto py-3">
        <div class="container">
            <div class="row g-3">
                <!-- Brand & Description -->
                <div class="col-lg-4 col-md-6">
                    <h5 class="mb-3">
                        <i class="bi bi-heart-pulse me-2 text-primary"></i>
                        <span id="footer-brand">Sahatak | ØµØ­ØªÙƒ</span>
                    </h5>
                    <div class="d-flex gap-3 social-links">
                        <a href="https://facebook.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-facebook fs-5"></i></a>
                        <a href="https://twitter.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-twitter fs-5"></i></a>
                        <a href="https://instagram.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-instagram fs-5"></i></a>
                        <a href="https://linkedin.com/company/sahatak" target="_blank" rel="noopener"><i class="bi bi-linkedin fs-5"></i></a>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="col-lg-2 col-md-6">
                    <h6 class="mb-3" id="footer-links-title">Quick Links</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../../common/about.html" class="text-muted text-decoration-none" id="footer-about">About Platform</a>
                        </li>
                        <li class="mb-2">
                            <a href="../../common/services.html" class="text-muted text-decoration-none" id="footer-services">Services</a>
                        </li>
                    </ul>
                </div>

                <!-- Support -->
                <div class="col-lg-3 col-md-6">
                    <h6 class="mb-3" id="footer-support-title">Support & Help</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../../common/support.html" class="text-muted text-decoration-none" id="footer-help">Help Center</a>
                        </li>
                        <li class="mb-2">
                            <a href="../../common/contact-us.html" class="text-muted text-decoration-none" id="footer-contact">Contact Us</a>
                        </li>
                    </ul>
                </div>

                <!-- Emergency Contact -->
                <div class="col-lg-3 col-md-6 emergency-section">
                    <p class="mb-2 text-danger fw-bold" id="footer-emergency-text">
                        For medical emergencies
                    </p>
                    <p class="mb-3 text-danger fw-bold fs-6" id="footer-emergency-action">
                        <i class="bi bi-hospital me-2"></i>
                        Go to nearest ER hospital
                    </p>
                    <p class="mb-0 text-muted small" id="footer-emergency-note">
                        For non-urgent consultations use the platform
                    </p>
                </div>
            </div>

            <!-- Bottom Bar -->
            <hr class="my-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0 fw-bold" id="footer-copyright">
                        Â© 2025 Sahatak. All rights reserved.
                    </p>
                    <p class="mb-0 text-muted small mt-1" id="footer-medical-disclaimer">
                        This platform does not replace visiting a doctor in emergency cases
                    </p>
                </div>
            </div>
        </div>
    </footer>
</body>
</html>