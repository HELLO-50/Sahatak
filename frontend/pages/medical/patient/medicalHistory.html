<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Medical History | Sahatak</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='%230d47a1' d='m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523.942-.661 2.27.067 3.71L8 15.5l6.533-8.737c.728-1.44.59-2.768.067-3.71C13.486.878 10.4.28 8.717 2.01L8 2.748z'/></svg>">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Arabic Font -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../../assets/css/main.css">
    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="../../../assets/css/components/dashboard.css">
    <link rel="stylesheet" href="../../../assets/css/components/medical-records.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="container-fluid">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="row align-items-center">
                    <!-- Profile Section - Left (Right in RTL) -->
                    <div class="col-lg-4">
                        <div class="profile-section">
                            <div class="user-avatar">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            <div class="user-details">
                                <h5 class="mb-1" id="user-name">User Name</h5>
                            </div>
                            <!-- Vertical Action Buttons -->
                            <div class="action-buttons">
                                <button class="btn btn-action" onclick="openEditModal()" title="Edit History" id="edit-history-btn">
                                    <i class="bi bi-pencil"></i>
                                    <span id="edit-history"></span>
                                </button>
                                <button class="btn btn-action" onclick="goToDashboard()" title="Dashboard">
                                    <i class="bi bi-house"></i>
                                    <span id="nav-dashboard"></span>
                                </button>
                                <button class="btn btn-action" onclick="goBack()" title="Back">
                                    <i class="bi bi-arrow-right"></i>
                                    <span id="nav-back"></span>
                                </button>
                                <button class="btn btn-action btn-logout" onclick="AuthGuard.logout()" title="Logout">
                                    <i class="bi bi-box-arrow-right"></i>
                                    <span id="btn-logout">Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dashboard Title - Center -->
                    <div class="col-lg-4 text-center">
                        <h1 class="dashboard-title" id="medical-history-title">Medical History</h1>
                        <p class="dashboard-subtitle" id="medical-history-subtitle">Comprehensive Electronic Health Record</p>
                    </div>
                    
                    <!-- Language Selector - Right (Left in RTL) -->
                    <div class="col-lg-4 text-end">
                        <button class="btn btn-outline-medical btn-sm" onclick="showLanguageSelector()" id="language-toggle">
                            <i class="bi bi-globe me-1"></i>
                            <span id="current-lang">English</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">

        <div class="row medical-history-cards">
            <!-- Medical History Summary -->
            <div class="col-lg-4 mb-4">
                <div class="card h-100 border-0" style="background: white; border: 1px solid #e9ecef !important;">
                    <div class="card-header text-white" style="background: #0d47a1 !important;">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-clipboard-data me-2"></i>
                            <span id="summary-title">Medical Summary</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="history-summary">
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3 text-muted" id="summary-loading">Loading summary...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Medical History Timeline -->
            <div class="col-lg-8 mb-4">
                <div class="card h-100 border-0" style="background: white; border: 1px solid #e9ecef !important;">
                    <div class="card-header text-white d-flex justify-content-between align-items-center" style="background: #0d47a1 !important;">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-clock-history me-2"></i>
                            <span id="timeline-title">Update Timeline</span>
                        </h5>
                        <div class="btn-group btn-group-sm" id="timeline-filter">
                            <input type="radio" class="btn-check" name="timelineFilter" id="all-updates" value="all" checked>
                            <label class="btn btn-outline-light" for="all-updates" id="filter-all">All</label>

                            <input type="radio" class="btn-check" name="timelineFilter" id="appointments-updates" value="appointments">
                            <label class="btn btn-outline-light" for="appointments-updates" id="filter-appointments">Appointments</label>

                            <input type="radio" class="btn-check" name="timelineFilter" id="self-updates" value="self">
                            <label class="btn btn-outline-light" for="self-updates" id="filter-self-updates">Self Updates</label>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="medical-timeline" class="timeline-container">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3 text-muted" id="timeline-loading"></p>
                            </div>
                        </div>
                    </div>
                </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Medical History Modal -->
    <div class="modal fade" id="edit-history-modal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square text-primary me-2"></i>
                        <span id="modal-title"></span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="medical-history-form">
                        <div class="row">
                            <!-- Basic Health Information -->
                            <div class="col-md-6 mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-person me-2"></i>
                                    <span id="basic-info-title"></span>
                                </h6>
                                
                                <div class="mb-3">
                                    <label for="blood-type" class="form-label" id="blood-type-label"></label>
                                    <select class="form-select" id="blood-type">
                                        <option value="" id="select-blood-type"></option>
                                        <option value="A+">A+</option>
                                        <option value="A-">A-</option>
                                        <option value="B+">B+</option>
                                        <option value="B-">B-</option>
                                        <option value="AB+">AB+</option>
                                        <option value="AB-">AB-</option>
                                        <option value="O+">O+</option>
                                        <option value="O-">O-</option>
                                    </select>
                                </div>

                                <div class="row">
                                    <div class="col-6">
                                        <label for="height" class="form-label" id="height-label"></label>
                                        <input type="number" class="form-control" id="height" min="50" max="250">
                                    </div>
                                    <div class="col-6">
                                        <label for="weight" class="form-label" id="weight-label"></label>
                                        <input type="number" class="form-control" id="weight" min="20" max="300">
                                    </div>
                                </div>
                            </div>

                            <!-- Lifestyle Information -->
                            <div class="col-md-6 mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-heart me-2"></i>
                                    <span id="lifestyle-title"></span>
                                </h6>

                                <div class="mb-3">
                                    <label for="smoking-status" class="form-label" id="smoking-label"></label>
                                    <select class="form-select" id="smoking-status">
                                        <option value="" id="select-smoking"></option>
                                        <option value="never" id="never-smoked"></option>
                                        <option value="former" id="former-smoker"></option>
                                        <option value="current" id="current-smoker"></option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="exercise-frequency" class="form-label" id="exercise-label"></label>
                                    <select class="form-select" id="exercise-frequency">
                                        <option value="" id="select-exercise"></option>
                                        <option value="rare" id="rare-exercise"></option>
                                        <option value="weekly" id="weekly-exercise"></option>
                                        <option value="daily" id="daily-exercise"></option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label for="alcohol-consumption" class="form-label" id="alcohol-label"></label>
                                    <select class="form-select" id="alcohol-consumption">
                                        <option value="" id="select-alcohol"></option>
                                        <option value="none" id="no-drink"></option>
                                        <option value="occasional" id="sometimes"></option>
                                        <option value="moderate" id="moderate"></option>
                                        <option value="heavy" id="heavy"></option>
                                    </select>
                                </div>
                            </div>

                            <!-- Medical History -->
                            <div class="col-12 mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="bi bi-clipboard-medical me-2"></i>
                                    <span id="medical-conditions-title"></span>
                                </h6>

                                <div class="mb-3">
                                    <label for="allergies" class="form-label" id="allergies-label"></label>
                                    <textarea class="form-control" id="allergies" rows="2"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="current-medications" class="form-label" id="current-medications-label">Current Medications</label>
                                    <textarea class="form-control" id="current-medications" rows="2"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="chronic-conditions" class="form-label" id="chronic-conditions-label">Chronic Conditions</label>
                                    <textarea class="form-control" id="chronic-conditions" rows="2"></textarea>
                                </div>
                            </div>

                            <!-- Family and Surgical History -->
                            <div class="col-md-6 mb-4">
                                <div class="mb-3">
                                    <label for="family-history" class="form-label" id="family-history-label">Family History</label>
                                    <textarea class="form-control" id="family-history" rows="3"></textarea>
                                </div>
                            </div>

                            <div class="col-md-6 mb-4">
                                <div class="mb-3">
                                    <label for="surgical-history" class="form-label" id="surgical-history-label">Surgical History</label>
                                    <textarea class="form-control" id="surgical-history" rows="3"></textarea>
                                </div>
                            </div>

                            <!-- General Medical History -->
                            <div class="col-12 mb-4">
                                <div class="mb-3">
                                    <label for="medical-history" class="form-label" id="medical-history-label">General Medical History</label>
                                    <textarea class="form-control" id="medical-history" rows="4"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="update-notes" class="form-label" id="update-notes-label">Update Notes</label>
                                    <textarea class="form-control" id="update-notes" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x me-1"></i>
                        <span id="cancel-btn-text">Cancel</span>
                    </button>
                    <button type="button" class="btn btn-primary" id="save-history-btn">
                        <i class="bi bi-check-lg me-1"></i>
                        <span id="save-btn-text">Save Changes</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline Event Details Modal -->
    <div class="modal fade" id="timeline-details-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="timeline-details-title"></h5>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="timeline-details-body">
                    <!-- Details will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="close-details-btn"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer mt-auto py-3">
        <div class="container">
            <div class="row g-3">
                <!-- Brand & Description -->
                <div class="col-lg-4 col-md-6">
                    <h5 class="mb-3">
                        <i class="bi bi-heart-pulse me-2 text-primary"></i>
                        <span id="footer-brand">Sahatak</span>
                    </h5>
                    <div class="d-flex gap-3 social-links">
                        <a href="https://facebook.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-facebook fs-5"></i></a>
                        <a href="https://twitter.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-twitter fs-5"></i></a>
                        <a href="https://instagram.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-instagram fs-5"></i></a>
                        <a href="https://linkedin.com/company/sahatak" target="_blank" rel="noopener"><i class="bi bi-linkedin fs-5"></i></a>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="col-lg-2 col-md-6">
                    <h6 class="mb-3" id="footer-links-title">Quick Links</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../../common/about.html" class="text-muted text-decoration-none" id="footer-about">About Platform</a>
                        </li>
                        <li class="mb-2">
                            <a href="../../common/services.html" class="text-muted text-decoration-none" id="footer-services">Services</a>
                        </li>
                    </ul>
                </div>

                <!-- Support -->
                <div class="col-lg-3 col-md-6">
                    <h6 class="mb-3" id="footer-support-title">Support & Help</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../../common/support.html" class="text-muted text-decoration-none" id="footer-help">Help Center</a>
                        </li>
                        <li class="mb-2">
                            <a href="../../common/contact-us.html" class="text-muted text-decoration-none" id="footer-contact">Contact Us</a>
                        </li>
                    </ul>
                </div>

                <!-- Emergency Contact -->
                <div class="col-lg-3 col-md-6 emergency-section">
                    <p class="mb-2 text-danger fw-bold" id="footer-emergency-text">
                        For medical emergencies
                    </p>
                    <p class="mb-3 text-danger fw-bold fs-6" id="footer-emergency-action">
                        <i class="bi bi-hospital me-2"></i>
                        Go to nearest ER hospital
                    </p>
                    <p class="mb-0 text-muted small" id="footer-emergency-note">
                        For non-urgent consultations use the platform
                    </p>
                </div>
            </div>

            <!-- Bottom Bar -->
            <hr class="my-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0 fw-bold" id="footer-copyright">
                        © 2025 Sahatak. All rights reserved.
                    </p>
                    <p class="mb-0 text-muted small mt-1" id="footer-medical-disclaimer">
                        This platform does not replace visiting a doctor in emergency cases
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="../../../assets/js/main.js"></script>
    <script src="../../../assets/js/components/auth-guard.js"></script>
    <script src="../../../assets/js/components/dashboard-translations.js"></script>
    <script src="../../../assets/js/components/medical-records.js"></script>
    
    <script>
        // All translations are handled by dashboard-translations.js

        let currentPatientId = null;
        let medicalHistory = null;
        let historyUpdates = [];
        let currentFilter = 'all';

        // Temporary helper function for translations (fallback)
        function getTranslation(key) {
            // This is a temporary fallback until proper translations are implemented
            const translations = {
                'labels.date': 'Date',
                'labels.time': 'Time', 
                'labels.doctor': 'Doctor',
                'labels.notes': 'Notes',
                'labels.updated_fields': 'Updated Fields',
                'labels.from': 'From',
                'labels.to': 'To',
                'status.not_specified': 'Not specified',
                'status.no_details': 'No details available',
                'timeline.initial_registration': 'Initial Registration',
                'timeline.self_update': 'Self Update',
                'timeline.appointment_update': 'Appointment Update', 
                'timeline.doctor_update': 'Doctor Update',
                'timeline.update': 'Update',
                'fields.medical_history': 'Medical History',
                'fields.allergies': 'Allergies',
                'fields.current_medications': 'Current Medications',
                'fields.chronic_conditions': 'Chronic Conditions',
                'fields.family_history': 'Family History',
                'fields.surgical_history': 'Surgical History',
                'fields.smoking_status': 'Smoking Status',
                'fields.alcohol_consumption': 'Alcohol Consumption',
                'fields.exercise_frequency': 'Exercise Frequency',
                'fields.height': 'Height',
                'fields.weight': 'Weight',
                'fields.blood_type': 'Blood Type',
                'smoking.never': 'Never smoked',
                'smoking.former': 'Former smoker',
                'smoking.current': 'Current smoker',
                'exercise.rare': 'Rarely',
                'exercise.weekly': 'Weekly',
                'exercise.daily': 'Daily',
                'bmi.underweight': 'Underweight',
                'bmi.normal': 'Normal weight',
                'bmi.overweight': 'Overweight',
                'bmi.obese': 'Obese'
            };
            return translations[key] || key;
        }

        // Initialize medical history page on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🔧 Medical History: Starting initialization...');
            
            // Load translations first
            await LanguageManager.loadTranslations();
            console.log('🌐 Medical History: Translations loaded');
            
            // Get saved language
            const savedLanguage = LanguageManager.getLanguage() || 'ar';
            console.log('🔤 Medical History: Using language:', savedLanguage);
            
            // Check if translations exist
            const translations = LanguageManager.translations[savedLanguage];
            console.log('📚 Medical History: Available translation sections:', translations ? Object.keys(translations) : 'NONE');
            console.log('📋 Medical History: Records section exists:', !!translations?.records);
            console.log('🏥 Medical History: Medical_history section exists:', !!translations?.medical_history);
            
            await DashboardTranslations.initializeDashboard('records');
            console.log('✅ Medical History: Dashboard initialization completed');
            
            // Set up event listeners
            setupEventListeners();
            
            // Load medical history data after initialization
            setTimeout(async () => {
                await loadMedicalHistory();
            }, 500);
        });

        // Setup event listeners
        function setupEventListeners() {
            // Edit history button
            document.getElementById('edit-history-btn').addEventListener('click', openEditModal);
            
            // Save history button
            document.getElementById('save-history-btn').addEventListener('click', saveMedicalHistory);
            
            // Timeline filter buttons
            document.querySelectorAll('input[name="timelineFilter"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    currentFilter = this.value;
                    renderTimeline();
                });
            });
        }

        // Load medical history
        async function loadMedicalHistory() {
            try {
                const response = await ApiHelper.makeRequest('/medical-history/check-completion');
                
                if (response.success) {
                    // Get patient ID from current user or URL parameter
                    const urlParams = new URLSearchParams(window.location.search);
                    currentPatientId = urlParams.get('patient_id') || 'current';
                    
                    // Load full medical history
                    const historyUrl = currentPatientId === 'current' 
                        ? '/medical-history/check-completion'
                        : `/medical-history/patient/${currentPatientId}`;
                    
                    const historyResponse = await ApiHelper.makeRequest(historyUrl);
                    
                    if (historyResponse.success) {
                        medicalHistory = historyResponse.data.patient_medical_history || historyResponse.data;
                        historyUpdates = historyResponse.data.recent_updates || [];
                        
                        renderMedicalSummary();
                        await loadHistoryUpdates();
                        renderTimeline();
                    } else {
                        showError('Failed to load medical history');
                    }
                } else {
                    showError('Failed to access medical history');
                }
            } catch (error) {
                console.error('Error loading medical history:', error);
                showError('Error loading medical history');
            }
        }

        // Load complete history updates
        async function loadHistoryUpdates() {
            try {
                // Skip loading updates if we don't have a valid patient ID
                const userId = getCurrentUserId();
                if (!userId) {
                    console.log('No valid user ID for loading history updates, skipping...');
                    historyUpdates = [];
                    return;
                }
                
                const url = `/medical-history/updates/${userId}`;
                
                console.log('Loading history updates from:', url);
                const response = await ApiHelper.makeRequest(url);
                console.log('History updates response:', response);
                
                if (response.success) {
                    historyUpdates = response.data.updates || [];
                    console.log('Loaded history updates:', historyUpdates);
                } else {
                    console.warn('Failed to load history updates:', response.message);
                    // Don't show error to user, just use empty updates
                    historyUpdates = [];
                }
            } catch (error) {
                console.warn('Could not load history updates (this is normal for new users):', error);
                // Don't show error to user, just use empty updates
                historyUpdates = [];
            }
        }

        // Render medical summary
        function renderMedicalSummary() {
            const container = document.getElementById('history-summary');
            
            if (!medicalHistory) {
                container.innerHTML = `<p class="text-muted text-center">No information available</p>`;
                return;
            }
            
            const completionStatus = medicalHistory.medical_history_completed ? 
                `<span class="badge bg-success">Complete</span>` : 
                `<span class="badge bg-warning">Incomplete</span>`;
            
            const lastUpdated = medicalHistory.medical_history_last_updated ? 
                new Date(medicalHistory.medical_history_last_updated).toLocaleDateString('ar-SA') : 
                'Not updated';
            
            const summaryHtml = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">Completion Status:</span>
                        ${completionStatus}
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">Last Update:</span>
                        <span class="text-muted">${lastUpdated}</span>
                    </div>
                </div>
                
                <hr>
                
                <div class="row text-center">
                    <div class="col-6 mb-2">
                        <div class="bg-light rounded p-2">
                            <i class="bi bi-droplet text-danger fs-4"></i>
                            <div class="small text-muted">Blood Type</div>
                            <div class="fw-bold">${medicalHistory.blood_type || '--'}</div>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <div class="bg-light rounded p-2">
                            <i class="bi bi-activity text-success fs-4"></i>
                            <div class="small text-muted">General Status</div>
                            <div class="fw-bold text-success">Good</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        For comprehensive medical care, ensure all information is complete
                    </small>
                </div>
            `;
            
            container.innerHTML = summaryHtml;
        }


        // Render timeline
        function renderTimeline() {
            const container = document.getElementById('medical-timeline');
            
            console.log('Rendering timeline with historyUpdates:', historyUpdates);
            
            if (!historyUpdates || historyUpdates.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-clock-history display-4 text-muted mb-3"></i>
                        <h6 class="text-muted mb-3">No update history</h6>
                        <p class="text-muted">All medical history updates will appear here</p>
                    </div>
                `;
                return;
            }
            
            // Filter updates based on current filter
            let filteredUpdates = historyUpdates;
            if (currentFilter !== 'all') {
                filteredUpdates = historyUpdates.filter(update => {
                    switch (currentFilter) {
                        case 'appointments':
                            return update.update_type === 'appointment_update';
                        case 'self':
                            return update.update_type === 'patient_self_update' || update.update_type === 'initial_registration';
                        default:
                            return true;
                    }
                });
            }
            
            if (filteredUpdates.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-filter display-4 text-muted mb-3"></i>
                        <h6 class="text-muted">No updates in this category</h6>
                    </div>
                `;
                return;
            }
            
            const timelineHtml = filteredUpdates.map((update, index) => {
                const date = new Date(update.created_at);
                const updateTypeInfo = getUpdateTypeInfo(update.update_type);
                const isLast = index === filteredUpdates.length - 1;
                
                return `
                    <div class="timeline-item ${isLast ? 'last' : ''}" onclick="showTimelineDetails(${update.id})">
                        <div class="timeline-marker ${updateTypeInfo.class}">
                            <i class="bi ${updateTypeInfo.icon}"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-header">
                                <h6 class="timeline-title">${updateTypeInfo.title}</h6>
                                <small class="timeline-date text-muted">
                                    <i class="bi bi-clock me-1"></i>
                                    ${date.toLocaleDateString('ar-SA')} - ${date.toLocaleTimeString('ar-SA', {hour: '2-digit', minute: '2-digit'})}
                                </small>
                            </div>
                            <div class="timeline-body">
                                <p class="mb-2">${update.notes || 'Medical history update'}</p>
                                <div class="timeline-fields">
                                    <small class="text-muted">
                                        <i class="bi bi-pencil me-1"></i>
                                        Updated ${update.updated_fields?.length || 0} fields
                                    </small>
                                </div>
                                ${update.doctor_name ? `
                                    <div class="timeline-doctor">
                                        <small class="text-primary">
                                            <i class="bi bi-person-badge me-1"></i>
                                            بواسطة: د. ${update.doctor_name}
                                        </small>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="timeline">${timelineHtml}</div>`;
        }

        // Open edit modal
        async function openEditModal() {
            // Ensure we have the latest medical history data
            if (!medicalHistory) {
                console.log('Loading medical history for edit form...');
                await loadMedicalHistory();
            }
            
            // Populate form with current data (or leave empty if none exists)
            populateEditForm();
            
            const modal = new bootstrap.Modal(document.getElementById('edit-history-modal'));
            modal.show();
        }

        // Populate edit form with current data
        function populateEditForm() {
            if (!medicalHistory) {
                console.log('No medical history data available to populate form');
                return;
            }

            console.log('Populating form with medical history:', medicalHistory);
            
            // Field mapping: database_field -> form_element_id
            const fieldMappings = {
                'blood_type': 'blood-type',
                'height': 'height', 
                'weight': 'weight',
                'smoking_status': 'smoking-status',
                'exercise_frequency': 'exercise-frequency', 
                'alcohol_consumption': 'alcohol-consumption',
                'allergies': 'allergies',
                'current_medications': 'current-medications',
                'chronic_conditions': 'chronic-conditions', 
                'family_history': 'family-history',
                'surgical_history': 'surgical-history',
                'medical_history': 'medical-history'
            };
            
            // Populate each field
            Object.keys(fieldMappings).forEach(dbField => {
                const elementId = fieldMappings[dbField];
                const element = document.getElementById(elementId);
                
                if (element && medicalHistory[dbField]) {
                    element.value = medicalHistory[dbField];
                    console.log(`Populated ${elementId} with:`, medicalHistory[dbField]);
                } else if (!element) {
                    console.warn(`Form element not found: ${elementId}`);
                } else {
                    console.log(`No data for field: ${dbField}`);
                }
            });
        }

        // Save medical history
        async function saveMedicalHistory() {
            try {
                // Show loading state
                const saveBtn = document.getElementById('save-history-btn');
                const originalContent = saveBtn.innerHTML;
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Saving...';
                
                const formData = {
                    blood_type: document.getElementById('blood-type').value,
                    height: document.getElementById('height').value,
                    weight: document.getElementById('weight').value,
                    smoking_status: document.getElementById('smoking-status').value,
                    exercise_frequency: document.getElementById('exercise-frequency').value,
                    alcohol_consumption: document.getElementById('alcohol-consumption').value,
                    allergies: document.getElementById('allergies').value,
                    current_medications: document.getElementById('current-medications').value,
                    chronic_conditions: document.getElementById('chronic-conditions').value,
                    family_history: document.getElementById('family-history').value,
                    surgical_history: document.getElementById('surgical-history').value,
                    medical_history: document.getElementById('medical-history').value,
                    notes: document.getElementById('update-notes').value
                };
                
                
                const response = await ApiHelper.makeRequest('/medical-history/update', {
                    method: 'PUT',
                    body: JSON.stringify(formData)
                });
                
                if (response.success) {
                    showSuccess('Medical history updated successfully');
                    bootstrap.Modal.getInstance(document.getElementById('edit-history-modal')).hide();
                    
                    // Update local data with response
                    if (response.data && response.data.patient_medical_history) {
                        medicalHistory = response.data.patient_medical_history;
                    }
                    
                    // Reload data to reflect changes
                    console.log('Medical history updated successfully, reloading data...');
                    await loadMedicalHistory();
                } else {
                    const errorMsg = response.message || 'Failed to update medical history';
                    console.error('Update failed:', errorMsg);
                    showError(errorMsg);
                }
            } catch (error) {
                console.error('Error saving medical history:', error);
                showError(error.message || 'Error saving medical history');
            } finally {
                // Restore button state
                const saveBtn = document.getElementById('save-history-btn');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i><span id="save-btn-text">Save Changes</span>';
                }
            }
        }

        // Show timeline details
        function showTimelineDetails(updateId) {
            const update = historyUpdates.find(u => u.id === updateId);
            if (!update) return;
            
            const modal = document.getElementById('timeline-details-modal');
            const title = document.getElementById('timeline-details-title');
            const body = document.getElementById('timeline-details-body');
            
            const updateTypeInfo = getUpdateTypeInfo(update.update_type);
            title.innerHTML = `<i class="bi ${updateTypeInfo.icon} me-2"></i>${updateTypeInfo.title}`;
            
            const date = new Date(update.created_at);
            let detailsHtml = `
                <div class="update-details">
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>${getTranslation('labels.date') || 'Date'}:</strong><br>
                            ${date.toLocaleDateString('ar-SA')}
                        </div>
                        <div class="col-6">
                            <strong>${getTranslation('labels.time') || 'Time'}:</strong><br>
                            ${date.toLocaleTimeString('ar-SA')}
                        </div>
                    </div>
                    
                    ${update.doctor_name ? `
                        <div class="mb-3">
                            <strong>${getTranslation('labels.doctor') || 'Doctor'}:</strong><br>
                            د. ${update.doctor_name}
                        </div>
                    ` : ''}
                    
                    ${update.notes ? `
                        <div class="mb-3">
                            <strong>${getTranslation('labels.notes') || 'Notes'}:</strong><br>
                            ${update.notes}
                        </div>
                    ` : ''}
                    
                    <div class="mb-3">
                        <strong>${getTranslation('labels.updated_fields') || 'Updated Fields'}:</strong><br>
                        <div class="mt-2">
            `;
            
            if (update.updated_fields && update.updated_fields.length > 0) {
                update.updated_fields.forEach(field => {
                    const fieldNameAr = getFieldNameArabic(field);
                    const notSpecified = getTranslation('status.not_specified') || 'Not specified';
                    const oldValue = update.previous_values?.[field] || notSpecified;
                    const newValue = update.new_values?.[field] || notSpecified;
                    
                    detailsHtml += `
                        <div class="field-change mb-2 p-2 border rounded">
                            <strong>${fieldNameAr}:</strong><br>
                            <small class="text-muted">${getTranslation('labels.from') || 'From'}: ${oldValue}</small><br>
                            <small class="text-success">${getTranslation('labels.to') || 'To'}: ${newValue}</small>
                        </div>
                    `;
                });
            } else {
                detailsHtml += `<p class="text-muted">${getTranslation('status.no_details') || 'No details available'}</p>`;
            }
            
            detailsHtml += '</div></div></div>';
            body.innerHTML = detailsHtml;
            
            new bootstrap.Modal(modal).show();
        }

        // Helper functions
        function calculateBMI(height, weight) {
            if (!height || !weight) return null;
            const heightInMeters = height / 100;
            return (weight / (heightInMeters * heightInMeters)).toFixed(1);
        }

        function getBMIStatus(bmi) {
            if (!bmi) return { class: 'bg-secondary', text: getTranslation('status.not_specified') || 'Not specified' };
            
            if (bmi < 18.5) return { class: 'bg-warning', text: getTranslation('bmi.underweight') || 'Underweight' };
            if (bmi < 25) return { class: 'bg-success', text: getTranslation('bmi.normal') || 'Normal weight' };
            if (bmi < 30) return { class: 'bg-warning', text: getTranslation('bmi.overweight') || 'Overweight' };
            return { class: 'bg-danger', text: getTranslation('bmi.obese') || 'Obese' };
        }

        function getUpdateTypeInfo(updateType) {
            const types = {
                'initial_registration': {
                    title: getTranslation('timeline.initial_registration') || 'Initial Registration',
                    icon: 'bi-plus-circle',
                    class: 'bg-success'
                },
                'patient_self_update': {
                    title: getTranslation('timeline.self_update') || 'Self Update',
                    icon: 'bi-person',
                    class: 'bg-primary'
                },
                'appointment_update': {
                    title: getTranslation('timeline.appointment_update') || 'Appointment Update',
                    icon: 'bi-calendar-check',
                    class: 'bg-info'
                },
                'doctor_update': {
                    title: getTranslation('timeline.doctor_update') || 'Doctor Update',
                    icon: 'bi-person-badge',
                    class: 'bg-warning'
                }
            };
            
            return types[updateType] || {
                title: getTranslation('timeline.update') || 'Update',
                icon: 'bi-pencil',
                class: 'bg-secondary'
            };
        }

        function getFieldNameArabic(field) {
            const currentLang = LanguageManager.getLanguage() || 'ar';
            const fieldTranslations = {
                'medical_history': getTranslation('fields.medical_history') || 'Medical History',
                'allergies': getTranslation('fields.allergies') || 'Allergies',
                'current_medications': getTranslation('fields.current_medications') || 'Current Medications',
                'chronic_conditions': getTranslation('fields.chronic_conditions') || 'Chronic Conditions',
                'family_history': getTranslation('fields.family_history') || 'Family History',
                'surgical_history': getTranslation('fields.surgical_history') || 'Surgical History',
                'smoking_status': getTranslation('fields.smoking_status') || 'Smoking Status',
                'alcohol_consumption': getTranslation('fields.alcohol_consumption') || 'Alcohol Consumption',
                'exercise_frequency': getTranslation('fields.exercise_frequency') || 'Exercise Frequency',
                'height': getTranslation('fields.height') || 'Height',
                'weight': getTranslation('fields.weight') || 'Weight',
                'blood_type': getTranslation('fields.blood_type') || 'Blood Type'
            };
            
            return fieldTranslations[field] || field;
        }

        function getSmokingStatusArabic(status) {
            const statuses = {
                'never': getTranslation('smoking.never') || 'Never smoked',
                'former': getTranslation('smoking.former') || 'Former smoker',
                'current': getTranslation('smoking.current') || 'Current smoker'
            };
            return statuses[status] || getTranslation('status.not_specified') || 'Not specified';
        }

        function getExerciseFrequencyArabic(frequency) {
            const frequencies = {
                'rare': getTranslation('exercise.rare') || 'Rarely',
                'weekly': getTranslation('exercise.weekly') || 'Weekly',
                'daily': getTranslation('exercise.daily') || 'Daily'
            };
            return frequencies[frequency] || 'Not specified';
        }

        function getCurrentUserId() {
            // Try to get patient ID from stored user data
            try {
                // First check if we have stored user data
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                if (userData.patient_id) {
                    return userData.patient_id;
                }
                
                // Try to get from token
                const token = localStorage.getItem('token');
                if (token) {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    // For patients, the patient_id should be in the token
                    return payload.patient_id || payload.user_id || payload.id || null;
                }
            } catch (error) {
                console.warn('Could not extract user ID:', error);
            }
            return null;
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            errorDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
            errorDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            successDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
            successDiv.innerHTML = `
                <i class="bi bi-check-circle-fill me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 3000);
        }

        function goBack() {
            window.history.back();
        }

        function goToDashboard() {
            window.location.href = '../../dashboard/patient.html';
        }
        
        // Use the global language switching function
    </script>
</body>
</html>