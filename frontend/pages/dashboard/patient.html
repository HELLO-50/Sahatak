<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Patient Dashboard - Sahatak</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='%230d47a1' d='m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523.942-.661 2.27.067 3.71L8 15.5l6.533-8.737c.728-1.44.59-2.768.067-3.71C13.486.878 10.4.28 8.717 2.01L8 2.748z'/></svg>">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="../../assets/manifest.json">
    
    <!-- Mobile App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="صحتك">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="../../assets/images/icons/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../../assets/images/icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../../assets/images/icons/icon-144.png">
    
    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <!-- Bootstrap Icons CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Arabic Font - Noto Sans Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Main CSS -->
    <link rel="stylesheet" href="../../assets/css/main.css">
    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="../../assets/css/components/dashboard.css">
    <!-- Video Consultation Dashboard CSS -->
    <link rel="stylesheet" href="../../assets/css/components/video-consultation-dashboard.css">
    <!-- Mobile Patient Optimizations -->
    <link rel="stylesheet" href="../../assets/css/components/mobile-patient.css">
</head>
<body data-protect="patient">
    <div class="dashboard-container">
        <div class="container-fluid">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="row align-items-center">
                    <!-- Profile Section - Left (Right in RTL) -->
                    <div class="col-lg-4">
                        <div class="profile-section">
                            <div class="user-avatar">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            <div class="user-details">
                                <h5 class="mb-1" id="user-name">Ahmed Mohamed</h5>
                            </div>
                            <!-- Vertical Action Buttons -->
                            <div class="action-buttons">
                                <button class="btn btn-action" onclick="showProfile()" title="Profile">
                                    <i class="bi bi-person"></i>
                                    <span id="btn-profile">Profile</span>
                                </button>
                                <button class="btn btn-action" onclick="showSettings()" title="Settings">
                                    <i class="bi bi-gear"></i>
                                    <span id="btn-settings">Settings</span>
                                </button>
                                <button class="btn btn-action btn-logout" onclick="AuthGuard.logout()" title="Logout">
                                    <i class="bi bi-box-arrow-right"></i>
                                    <span id="btn-logout">Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dashboard Title - Center -->
                    <div class="col-lg-4 text-center">
                        <h1 class="dashboard-title" id="dashboard-title">Patient Dashboard</h1>
                        <p class="dashboard-subtitle" id="dashboard-subtitle">Welcome to Sahatak Medical Platform</p>
                    </div>
                    
                    <!-- Language Selector - Right (Left in RTL) -->
                    <div class="col-lg-4 text-end">
                        <button class="btn btn-outline-medical btn-sm" onclick="showLanguageSelector()">
                            <i class="bi bi-globe me-1"></i>
                            <span id="current-lang">English</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Main Content -->
                <div class="col-12">
                    <!-- Quick Actions -->
                    <div class="row mb-4">
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="dashboard-card quick-action-card" onclick="bookAppointment()">
                                <div class="quick-action-icon">
                                    <i class="bi bi-plus-circle"></i>
                                </div>
                                <h6 id="action-book">Book New Appointment</h6>
                                <p class="text-muted small" id="action-book-desc">Schedule consultation with doctor</p>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="dashboard-card quick-action-card" onclick="viewRecords()">
                                <div class="quick-action-icon">
                                    <i class="bi bi-clipboard-data"></i>
                                </div>
                                <h6 id="action-records">My Medical Records</h6>
                                <p class="text-muted small" id="action-records-desc">View reports and results</p>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="dashboard-card quick-action-card" onclick="chatWithDoctor()">
                                <div class="quick-action-icon">
                                    <i class="bi bi-chat-dots"></i>
                                </div>
                                <h6 id="action-chat">Chat with Doctor</h6>
                                <p class="text-muted small" id="action-chat-desc">Text messages with doctor</p>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Row -->
                    <div class="row mb-4">
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="dashboard-card stat-card">
                                <div class="stat-number" id="stat-appointments-count">-</div>
                                <div class="stat-label" id="stat-appointments">Scheduled Appointments</div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="dashboard-card stat-card">
                                <div class="stat-number" id="stat-prescriptions-count">-</div>
                                <div class="stat-label" id="stat-prescriptions">Active Prescriptions</div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="dashboard-card stat-card">
                                <div class="stat-number" id="stat-reports-count">-</div>
                                <div class="stat-label" id="stat-reports">Medical Reports</div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Sections -->
                    <div class="row">
                        <!-- Upcoming Appointments -->
                        <div class="col-lg-6 mb-4">
                            <div class="dashboard-card">
                                <div id="appointments-container">
                                    <!-- Appointments will be loaded dynamically -->
                                    <div class="text-center py-4">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2" id="loading-appointments">Loading appointments...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Health Summary -->
                        <div class="col-lg-6 mb-4">
                            <div class="dashboard-card">
                                <div id="health-summary-container">
                                    <!-- Health summary will be loaded dynamically -->
                                    <div class="text-center py-4">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2" id="loading-health-data">Loading health data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                </div>
            </div>

            <!-- Profile Section (Hidden by default) -->
            <div id="profile-section" class="row mt-4" style="display: none;">
                <div class="col-12">
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5><i class="bi bi-person me-2"></i><span id="profile-title">Patient Profile</span></h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="hideProfile()">
                                <i class="bi bi-x-lg me-1"></i><span id="close-profile">Close</span>
                            </button>
                        </div>

                        <div class="row g-4">
                            <!-- Personal Information -->
                            <div class="col-lg-6">
                                <div class="settings-group">
                                    <h6 class="settings-group-title">
                                        <i class="bi bi-person-badge me-2"></i><span id="personal-info">Personal Information</span>
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-patient-id">Patient ID</label>
                                        <p class="form-control-plaintext" id="patientId">PAT-2024-001</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-full-name">Full Name</label>
                                        <p class="form-control-plaintext" id="profileFullName">Ahmed Mohamed</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-email">Email Address</label>
                                        <p class="form-control-plaintext" id="profileEmail">ahmed.mohamed@example.com</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-phone">Phone Number</label>
                                        <input type="tel" class="form-control" id="profilePhone" placeholder="+249 123456789">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-date-of-birth">Date of Birth</label>
                                        <p class="form-control-plaintext" id="profileDOB">15/03/1985</p>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-gender">Gender</label>
                                        <p class="form-control-plaintext" id="profileGender">Male</p>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-blood-type">Blood Type</label>
                                        <p class="form-control-plaintext" id="profileBloodType">O+</p>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-national-id">National ID</label>
                                        <p class="form-control-plaintext" id="profileNationalId">29503151234567</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Medical Information & Emergency Contact -->
                            <div class="col-lg-6">
                                <div class="settings-group">
                                    <h6 class="settings-group-title">
                                        <i class="bi bi-heart-pulse me-2"></i><span id="medical-info">Medical Information</span>
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-allergies">Allergies</label>
                                        <p class="form-control-plaintext" id="profileAllergies">Penicillin, Pollen</p>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-chronic-conditions">Chronic Conditions</label>
                                        <p class="form-control-plaintext" id="profileChronicConditions">Hypertension, Diabetes Type 2</p>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-current-medications">Current Medications</label>
                                        <p class="form-control-plaintext" id="profileMedications">Metformin 500mg, Lisinopril 10mg</p>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-insurance-provider">Insurance Provider</label>
                                        <p class="form-control-plaintext" id="profileInsurance">Blue Cross Blue Shield</p>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-insurance-number">Insurance Number</label>
                                        <p class="form-control-plaintext" id="profileInsuranceNumber">INS-123456789</p>
                                    </div>

                                    <div class="settings-group mt-4">
                                        <h6 class="settings-group-title">
                                            <i class="bi bi-telephone me-2"></i><span id="emergency-contact">Emergency Contact</span>
                                        </h6>
                                        
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Contact Name</label>
                                            <p class="form-control-plaintext" id="emergencyName">Fatima Mohamed</p>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Relationship</label>
                                            <p class="form-control-plaintext" id="emergencyRelation">Wife</p>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Contact Phone</label>
                                            <p class="form-control-plaintext" id="emergencyPhone">+20 123 456 7891</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Account Information -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="settings-group">
                                    <h6 class="settings-group-title">
                                        <i class="bi bi-info-circle me-2"></i><span id="account-info">Account Information</span>
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Registration Date</label>
                                            <p class="form-control-plaintext" id="profileRegDate">01/01/2024</p>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Last Login</label>
                                            <p class="form-control-plaintext" id="profileLastLogin">Today at 10:30 AM</p>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Total Appointments</label>
                                            <p class="form-control-plaintext" id="profileTotalAppointments">24</p>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Account Status</label>
                                            <p class="form-control-plaintext"><span class="badge bg-success">Active</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Edit Profile Button -->
                        <div class="text-end mt-4">
                            <button class="btn btn-primary" onclick="editProfile()">
                                <i class="bi bi-pencil me-1"></i><span id="edit-profile">Edit Profile</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section (Hidden by default) -->
            <div id="settings-section" class="row mt-4" style="display: none;">
                <div class="col-12">
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5><i class="bi bi-gear me-2"></i><span id="settings-title">Settings</span></h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="hideSettings()">
                                <i class="bi bi-x-lg me-1"></i><span id="close-settings">Close</span>
                            </button>
                        </div>

                        <div class="row g-4">
                            <!-- Account Settings -->
                            <div class="col-lg-6">
                                <div class="settings-group">
                                    <h6 class="settings-group-title">
                                        <i class="bi bi-person-gear me-2"></i><span id="account-settings">Profile Information</span>
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <label for="fullName" class="form-label" id="full-name-label">Full Name</label>
                                        <input type="text" class="form-control" id="fullName" placeholder="Enter your full name">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="email" class="form-label" id="email-label">Email Address</label>
                                        <input type="email" class="form-control" id="email" placeholder="Enter your email">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="phone" class="form-label" id="phone-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="phone" placeholder="Enter your phone number">
                                    </div>

                                    <div class="mb-3">
                                        <label for="dateOfBirth" class="form-label" id="dob-label">Date of Birth</label>
                                        <input type="date" class="form-control" id="dateOfBirth">
                                    </div>

                                    <div class="mb-3">
                                        <label for="gender" class="form-label" id="gender-label">Gender</label>
                                        <select class="form-select" id="gender">
                                            <option value="">Select Gender</option>
                                            <option value="male">Male</option>
                                            <option value="female">Female</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Preferences & Notifications -->
                            <div class="col-lg-6">
                                <div class="settings-group">
                                    <h6 class="settings-group-title">
                                        <i class="bi bi-bell me-2"></i><span id="preferences-settings">Preferences & Notifications</span>
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <label for="language" class="form-label" id="language-label">Language</label>
                                        <select class="form-select" id="language">
                                            <option value="en">English</option>
                                            <option value="ar">العربية</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                            <label class="form-check-label" for="emailNotifications" id="email-notifications-label">
                                                Email Notifications
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="smsNotifications" checked>
                                            <label class="form-check-label" for="smsNotifications" id="sms-notifications-label">
                                                SMS Notifications
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="appointmentReminders" checked>
                                            <label class="form-check-label" for="appointmentReminders" id="appointment-reminders-label">
                                                Appointment Reminders
                                            </label>
                                        </div>
                                    </div>

                                    <div class="settings-group mt-4">
                                        <h6 class="settings-group-title">
                                            <i class="bi bi-shield-lock me-2"></i><span id="security-settings">Security</span>
                                        </h6>
                                        
                                        <div class="mb-3">
                                            <button class="btn btn-outline-primary btn-sm me-2" onclick="changePassword()">
                                                <i class="bi bi-key me-1"></i><span id="change-password">Change Password</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Save Settings Button -->
                        <div class="text-end mt-4">
                            <button class="btn btn-secondary me-2" onclick="resetSettings()">
                                <i class="bi bi-arrow-clockwise me-1"></i><span id="reset-settings">Reset</span>
                            </button>
                            <button class="btn btn-primary" onclick="saveSettings()">
                                <i class="bi bi-check-lg me-1"></i><span id="save-settings">Save Settings</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer mt-auto py-3">
        <div class="container">
            <div class="row g-3">
                <!-- Brand & Description -->
                <div class="col-lg-4 col-md-6">
                    <h5 class="mb-3">
                        <i class="bi bi-heart-pulse me-2 text-primary"></i>
                        <span id="footer-brand">Sahatak</span>
                    </h5>
                    <div class="d-flex gap-3 social-links">
                        <a href="https://facebook.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-facebook fs-5"></i></a>
                        <a href="https://twitter.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-twitter fs-5"></i></a>
                        <a href="https://instagram.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-instagram fs-5"></i></a>
                        <a href="https://linkedin.com/company/sahatak" target="_blank" rel="noopener"><i class="bi bi-linkedin fs-5"></i></a>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="col-lg-2 col-md-6">
                    <h6 class="mb-3" id="footer-links-title">Quick Links</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../common/about.html" class="text-muted text-decoration-none" id="footer-about">About Platform</a>
                        </li>
                        <li class="mb-2">
                            <a href="../common/services.html" class="text-muted text-decoration-none" id="footer-services">Services</a>
                        </li>
                    </ul>
                </div>

                <!-- Support -->
                <div class="col-lg-3 col-md-6">
                    <h6 class="mb-3" id="footer-support-title">Support & Help</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../common/support.html" class="text-muted text-decoration-none" id="footer-help">Help Center</a>
                        </li>
                        <li class="mb-2">
                            <a href="mailto:Sahatak.sudan@gmail.com" class="text-muted text-decoration-none" id="footer-contact">Contact Us</a>
                        </li>
                    </ul>
                </div>

                <!-- Emergency Contact -->
                <div class="col-lg-3 col-md-6 emergency-section">
                    <p class="mb-2 text-danger fw-bold" id="footer-emergency-text">
                        For medical emergencies
                    </p>
                    <p class="mb-3 text-danger fw-bold fs-6" id="footer-emergency-action">
                        <i class="bi bi-hospital me-2"></i>
                        Go to nearest ER hospital
                    </p>
                    <p class="mb-0 text-muted small" id="footer-emergency-note">
                        For non-urgent consultations use the platform
                    </p>
                </div>
            </div>

            <!-- Bottom Bar -->
            <hr class="my-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0 fw-bold" id="footer-copyright">
                        © 2025 Sahatak. All rights reserved.
                    </p>
                    <p class="mb-0 text-muted small mt-1" id="footer-medical-disclaimer">
                        This platform does not replace visiting a doctor in emergency cases
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5 JavaScript CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    
    <!-- Authentication Guard (must load first) -->
    <script src="../../assets/js/components/auth-guard.js"></script>
    <script src="../../assets/js/components/session-manager.js"></script>
    
    <!-- Main JavaScript -->
    <script src="../../assets/js/main.js"></script>
    
    <!-- Dashboard Translations -->
    <script src="../../assets/js/components/dashboard-translations.js"></script>
    
    <!-- Dashboard Data Handler -->
    <script src="../../assets/js/components/dashboard.js"></script>
    
    <!-- Video Consultation Dashboard JavaScript -->
    <script src="../../assets/js/components/video-consultation-dashboard.js"></script>
    
    <!-- Dashboard JavaScript -->
    <script>
        // Dashboard specific functions
        function bookAppointment() {
            // Update modal content with current language
            updateTriageModalLanguage();
            
            // Show AI triage modal first
            const triageModal = new bootstrap.Modal(document.getElementById('ai-triage-modal'));
            triageModal.show();
            
            // Initialize triage widget
            window.triageWidgetMode = true;
            setTimeout(() => {
                initTriageWidget({
                    widgetMode: true,
                    onTriageComplete: handleTriageComplete
                });
            }, 500);
        }
        
        function updateTriageModalLanguage() {
            // Update modal elements with current language translations
            document.getElementById('triage-modal-title').textContent = 
                LanguageManager?.translate('dashboard.patient.ai_triage.title') || 'Quick Health Check';
            
            document.getElementById('loading-text').textContent = 
                LanguageManager?.translate('dashboard.patient.ai_triage.loading') || 'Analyzing...';
            
            document.getElementById('messageInput').placeholder = 
                LanguageManager?.translate('dashboard.patient.ai_triage.placeholder') || 'Describe your symptoms here...';
            
            document.getElementById('micBtn').title = 
                LanguageManager?.translate('dashboard.patient.ai_triage.voice_title') || 'Voice input';
            
            document.getElementById('disclaimer-text').textContent = 
                LanguageManager?.translate('dashboard.patient.ai_triage.disclaimer') || 'I am a digital health assistant and not a replacement for professional medical consultation.';
        }
        
        function handleTriageComplete(triageResult, conversationHistory) {
            console.log('Triage completed:', triageResult, conversationHistory);
            
            // Update modal footer based on triage result
            const actionsDiv = document.getElementById('triage-actions');
            const currentLang = LanguageManager?.getLanguage() || 'ar';
            
            if (triageResult === 'telemedicine') {
                // Patient can book on platform
                const bookText = LanguageManager?.translate('dashboard.patient.ai_triage.book_appointment') || 'Book Appointment';
                const closeText = LanguageManager?.translate('dashboard.patient.ai_triage.close') || 'Close';
                
                actionsDiv.innerHTML = `
                    <button type="button" 
                            class="btn btn-success" 
                            onclick="proceedToBooking()">
                        <i class="bi bi-calendar-plus me-2"></i>
                        <span>${bookText}</span>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <span>${closeText}</span>
                    </button>
                `;
            } else if (triageResult === 'in_person') {
                // Recommend in-person visit
                const inPersonText = LanguageManager?.translate('dashboard.patient.ai_triage.results.in_person') || 'In-person doctor visit recommended';
                const understoodText = LanguageManager?.translate('dashboard.patient.ai_triage.understood') || 'Understood';
                
                actionsDiv.innerHTML = `
                    <div class="alert alert-warning w-100 mb-3">
                        <i class="bi bi-hospital me-2"></i>
                        <strong>${inPersonText}</strong>
                    </div>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <span>${understoodText}</span>
                    </button>
                `;
            } else if (triageResult === 'emergency') {
                // Emergency case
                const emergencyText = LanguageManager?.translate('dashboard.patient.ai_triage.results.emergency') || 'Please go to emergency room immediately!';
                const callText = LanguageManager?.translate('dashboard.patient.ai_triage.emergency_call') || 'Call Emergency';
                const understoodText = LanguageManager?.translate('dashboard.patient.ai_triage.understood') || 'Understood';
                
                actionsDiv.innerHTML = `
                    <div class="alert alert-danger w-100 mb-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>${emergencyText}</strong>
                    </div>
                    <a href="tel:999" class="btn btn-danger me-2">
                        <i class="bi bi-telephone me-1"></i>
                        <span>${callText}</span>
                    </a>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <span>${understoodText}</span>
                    </button>
                `;
            }
            
            actionsDiv.classList.remove('d-none');
        }
        
        function proceedToBooking() {
            // Save conversation first
            if (triageWidget) {
                triageWidget.saveConversation().then(() => {
                    console.log('Conversation saved before booking');
                }).catch(error => {
                    console.error('Error saving conversation:', error);
                });
            }
            
            // Close modal and proceed to booking
            bootstrap.Modal.getInstance(document.getElementById('ai-triage-modal')).hide();
            
            // Add a small delay to ensure modal closes smoothly
            setTimeout(() => {
                window.location.href = '../appointments/book-appointment.html';
            }, 300);
        }
        
        function viewPastAppointments() {
            window.location.href = '../appointments/appointment-list.html';
        }
        
        function viewRecords() {
            window.location.href = '../medical/patient/index.html';
        }
        
        function chatWithDoctor() {
            window.location.href = '../medical/patient/comm-hub.html';
        }
        
        function showLanguageSelector() {
            // Toggle between Arabic and English
            const currentLang = LanguageManager.getLanguage() || 'ar';
            const newLang = currentLang === 'ar' ? 'en' : 'ar';
            
            // Change language
            LanguageManager.setLanguage(newLang);
            LanguageManager.applyLanguage(newLang);
            
            // Update dashboard translations (call after applyLanguage to ensure footer is properly updated)
            if (DashboardTranslations && DashboardTranslations.updatePatientDashboard) {
                DashboardTranslations.updatePatientDashboard(newLang);
            }
            
            // Update the language button text
            const langBtn = document.getElementById('current-lang');
            if (langBtn) {
                langBtn.textContent = newLang === 'ar' ? 'العربية' : 'English';
            }
        }
        
        function showProfile() {
            const profileSection = document.getElementById('profile-section');
            const settingsSection = document.getElementById('settings-section');
            
            // Hide settings if open
            settingsSection.style.display = 'none';
            
            // Toggle profile
            profileSection.style.display = profileSection.style.display === 'none' ? 'block' : 'none';
            
            // Smooth scroll to profile section
            if (profileSection.style.display === 'block') {
                profileSection.scrollIntoView({ behavior: 'smooth' });
                loadUserProfile();
                
                // Update translations for profile section
                const currentLang = LanguageManager.getLanguage() || 'ar';
                const translations = LanguageManager.translations[currentLang];
                if (translations && translations.dashboard && translations.dashboard.patient && translations.dashboard.patient.profile) {
                    DashboardTranslations.updateProfileAndSettings(translations.dashboard.patient.profile, null);
                }
            }
        }

        function hideProfile() {
            document.getElementById('profile-section').style.display = 'none';
        }

        function loadUserProfile() {
            // Load user profile from localStorage or API
            const user = JSON.parse(localStorage.getItem('sahatak_user_data') || '{}');
            
            // Personal Information
            document.getElementById('profileFullName').textContent = user.full_name || 'Ahmed Mohamed';
            document.getElementById('profileEmail').textContent = user.email || 'ahmed.mohamed@example.com';
            document.getElementById('profilePhone').textContent = user.phone || '+20 123 456 7890';
            document.getElementById('profileDOB').textContent = user.date_of_birth || '15/03/1985';
            document.getElementById('profileGender').textContent = user.gender || 'Male';
            document.getElementById('profileBloodType').textContent = user.blood_type || 'O+';
            document.getElementById('profileNationalId').textContent = user.national_id || '29503151234567';
            document.getElementById('patientId').textContent = user.patient_id || 'PAT-2024-001';
            
            // Medical Information
            document.getElementById('profileAllergies').textContent = user.allergies || 'Penicillin, Pollen';
            document.getElementById('profileChronicConditions').textContent = user.chronic_conditions || 'Hypertension, Diabetes Type 2';
            document.getElementById('profileMedications').textContent = user.current_medications || 'Metformin 500mg, Lisinopril 10mg';
            document.getElementById('profileInsurance').textContent = user.insurance_provider || 'Blue Cross Blue Shield';
            document.getElementById('profileInsuranceNumber').textContent = user.insurance_number || 'INS-123456789';
            
            // Emergency Contact
            document.getElementById('emergencyName').textContent = user.emergency_name || 'Fatima Mohamed';
            document.getElementById('emergencyRelation').textContent = user.emergency_relation || 'Wife';
            document.getElementById('emergencyPhone').textContent = user.emergency_phone || '+20 123 456 7891';
            
            // Account Information
            document.getElementById('profileRegDate').textContent = user.registration_date || '01/01/2024';
            document.getElementById('profileLastLogin').textContent = user.last_login || 'Today at 10:30 AM';
            document.getElementById('profileTotalAppointments').textContent = user.total_appointments || '24';
        }

        function editProfile() {
            // Switch to settings section for editing
            hideProfile();
            showSettings();
            const currentLang = LanguageManager?.getLanguage() || 'ar';
            const alertMsg = LanguageManager?.translate('dashboard.patient.alerts.use_settings_to_edit') || 'Please use the Settings section to edit your profile information.';
            alert(alertMsg);
        }

        function showSettings() {
            const settingsSection = document.getElementById('settings-section');
            const profileSection = document.getElementById('profile-section');
            
            // Hide profile if open
            profileSection.style.display = 'none';
            
            // Toggle settings
            settingsSection.style.display = settingsSection.style.display === 'none' ? 'block' : 'none';
            
            // Smooth scroll to settings section
            if (settingsSection.style.display === 'block') {
                settingsSection.scrollIntoView({ behavior: 'smooth' });
                loadUserSettings();
                
                // Update translations for settings section
                const currentLang = LanguageManager.getLanguage() || 'ar';
                const translations = LanguageManager.translations[currentLang];
                if (translations && translations.dashboard && translations.dashboard.patient && translations.dashboard.patient.settings) {
                    DashboardTranslations.updateProfileAndSettings(null, translations.dashboard.patient.settings);
                }
            }
        }

        function hideSettings() {
            document.getElementById('settings-section').style.display = 'none';
        }

        function loadUserSettings() {
            // Load user settings from localStorage (simulating database)
            const user = JSON.parse(localStorage.getItem('sahatak_user_data') || '{}');
            
            // If no data exists, set default values (simulating initial database load)
            if (!user.full_name) {
                user.full_name = 'Ahmed Mohamed';
                user.email = 'ahmed.mohamed@example.com';
                user.phone = '+20 123 456 7890';
                user.date_of_birth = '1985-03-15';
                user.gender = 'male';
                localStorage.setItem('sahatak_user_data', JSON.stringify(user));
            }
            
            // Populate form fields with current values from database
            document.getElementById('fullName').value = user.full_name || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('dateOfBirth').value = user.date_of_birth || '';
            document.getElementById('gender').value = user.gender || '';
            
            // Load preferences from database
            const preferences = JSON.parse(localStorage.getItem('sahatak_preferences') || '{}');
            document.getElementById('language').value = preferences.language || 'en';
            document.getElementById('emailNotifications').checked = preferences.email_notifications !== false;
            document.getElementById('smsNotifications').checked = preferences.sms_notifications !== false;
            document.getElementById('appointmentReminders').checked = preferences.appointment_reminders !== false;
        }

        function saveSettings() {
            // Get current data from database
            const currentUser = JSON.parse(localStorage.getItem('sahatak_user_data') || '{}');
            const currentPrefs = JSON.parse(localStorage.getItem('sahatak_preferences') || '{}');
            
            // Collect only changed fields
            const updatedUser = {
                ...currentUser,
                full_name: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                date_of_birth: document.getElementById('dateOfBirth').value,
                gender: document.getElementById('gender').value
            };
            
            // Update preferences
            const updatedPrefs = {
                language: document.getElementById('language').value,
                email_notifications: document.getElementById('emailNotifications').checked,
                sms_notifications: document.getElementById('smsNotifications').checked,
                appointment_reminders: document.getElementById('appointmentReminders').checked
            };
            
            // Save to database (localStorage simulating database)
            localStorage.setItem('sahatak_user_data', JSON.stringify(updatedUser));
            localStorage.setItem('sahatak_preferences', JSON.stringify(updatedPrefs));
            
            // Update displayed name in header if changed
            if (updatedUser.full_name !== currentUser.full_name) {
                document.getElementById('user-name').textContent = updatedUser.full_name;
            }
            
            // Show success message with changes
            const changedFields = [];
            if (currentUser.full_name !== updatedUser.full_name) changedFields.push('Name');
            if (currentUser.email !== updatedUser.email) changedFields.push('Email');
            if (currentUser.phone !== updatedUser.phone) changedFields.push('Phone');
            
            const currentLang = LanguageManager?.getLanguage() || 'ar';
            if (changedFields.length > 0) {
                const msg = LanguageManager?.translate('dashboard.patient.alerts.settings_saved_with_changes') || 'Settings saved successfully!\nUpdated: ';
                alert(msg + changedFields.join(', '));
            } else {
                const msg = LanguageManager?.translate('dashboard.patient.alerts.settings_saved') || 'Settings saved successfully!';
                alert(msg);
            }
            
            
            // Refresh profile section if it's open
            if (document.getElementById('profile-section').style.display !== 'none') {
                loadUserProfile();
            }
        }

        function resetSettings() {
            const currentLang = LanguageManager?.getLanguage() || 'ar';
            const confirmMsg = LanguageManager?.translate('dashboard.patient.alerts.confirm_reload_settings') || 'Are you sure you want to reload settings from database?';
            if (confirm(confirmMsg)) {
                // Reload original values from database
                loadUserSettings();
                const alertMsg = LanguageManager?.translate('dashboard.patient.alerts.settings_reloaded') || 'Settings reloaded from database.';
                alert(alertMsg);
            }
        }

        function changePassword() {
            const currentLang = LanguageManager?.getLanguage() || 'ar';
            const alertMsg = LanguageManager?.translate('dashboard.patient.alerts.password_change_redirect') || 'Password change functionality will redirect to secure password update page.';
            alert(alertMsg);
        }

        function enableTwoFactor() {
            const currentLang = LanguageManager?.getLanguage() || 'ar';
            const alertMsg = LanguageManager?.translate('dashboard.patient.alerts.two_factor_setup') || 'Two-factor authentication setup will be implemented.';
            alert(alertMsg);
        }
        
        function viewAllAppointments() {
            window.location.href = '../appointments/appointment-list.html';
        }
        
        // logout function is now defined globally in main.js
        
        // Initialize patient dashboard on page load
        // Load health summary data from EHR API
        async function loadHealthSummary() {
            const container = document.getElementById('health-summary-container');
            if (!container) return;
            
            try {
                const currentLang = LanguageManager.getLanguage() || 'en';
                const currentUser = AuthGuard.getCurrentUser();
                
                // Check if user is authenticated
                if (!AuthGuard.isAuthenticated()) {
                    console.error('User not authenticated, redirecting to login');
                    AuthGuard.redirectToLogin();
                    return;
                }
                
                console.log('Current user from AuthGuard:', currentUser);
                
                // Get patient profile ID first
                let patientId = null;
                try {
                    const profileResponse = await ApiHelper.makeRequest(`/users/profile`);
                    // Backend returns user data in 'user' field, not 'data' field
                    if (profileResponse.success && profileResponse.user) {
                        const userData = profileResponse.user;
                        
                        if (userData.user_type === 'patient') {
                            // Try different ways to get patient ID
                            patientId = userData.profile?.id || userData.patient_profile?.id || userData.id;
                        }
                    }
                } catch (error) {
                    console.error('Error getting patient profile:', error);
                }

                if (!patientId) {
                    // Fallback: try to get patient profile ID from AuthGuard
                    const currentUser = AuthGuard.getCurrentUser();
                    console.log('Fallback: Current user from AuthGuard:', currentUser);
                    
                    // AuthGuard returns camelCase properties (userType) not snake_case (user_type)
                    if (currentUser && (currentUser.user_type === 'patient' || currentUser.userType === 'patient')) {
                        // Try to get patient profile ID from stored user data
                        patientId = currentUser.profile?.id || currentUser.patient_profile?.id;
                        console.log('Fallback patient profile ID:', patientId);
                        
                        if (!patientId) {
                            // Use User ID temporarily - medical history endpoint can resolve it
                            console.log('No Patient Profile ID in AuthGuard data, using User ID for medical history resolution');
                            patientId = currentUser.id;
                            console.log('Using User ID for initial medical history call:', patientId);
                        }
                    } else {
                        throw new Error('User not identified as patient');
                    }
                }

                // Try medical history endpoint first (which has better User ID resolution)
                // Trying medical history endpoint first
                
                try {
                    const medicalResponse = await ApiHelper.makeRequest(`/medical-history/patient/${patientId}`);
                    if (medicalResponse.success) {
                        // Use medical history data if available, then try EHR
                        if (medicalResponse.data.patient_medical_history) {
                            // Extract the actual Patient Profile ID from the response
                            const actualPatientId = medicalResponse.data.patient_medical_history.id;
                            if (actualPatientId && actualPatientId !== patientId) {
                                patientId = actualPatientId;
                            }
                        }
                    }
                } catch (error) {
                    console.log('Medical history endpoint failed:', error.message);
                }
                
                // Fetch EHR data for the patient
                // Fetching EHR data with resolved patient ID
                const ehrResponse = await ApiHelper.makeRequest(`/ehr/patient/${patientId}`);
                
                if (!ehrResponse.success) {
                    throw new Error('Could not load EHR data');
                }

                const ehrData = ehrResponse.data.ehr;
                const patientInfo = ehrData.patient_info;
                const latestVitals = ehrData.vital_signs?.[0]; // Most recent vital signs
                
                // Calculate health metrics from real data
                const healthMetrics = calculateHealthMetrics(patientInfo, latestVitals);
                
                container.innerHTML = `
                    <h5 class="mb-3">
                        <i class="bi bi-heart-pulse me-2"></i>
                        <span>${currentLang === 'ar' ? 'ملخص الحالة الصحية' : 'Health Summary'}</span>
                    </h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="health-metric">
                                <label class="form-label health-metric-label small">
                                    <i class="bi bi-heart-fill me-2 text-danger"></i>
                                    ${currentLang === 'ar' ? 'ضغط الدم' : 'Blood Pressure'}
                                </label>
                                <div class="h6 mb-0 health-metric-value">${healthMetrics.bloodPressure.value}</div>
                                <small class="${healthMetrics.bloodPressure.statusClass}">${healthMetrics.bloodPressure.status}</small>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="health-metric">
                                <label class="form-label health-metric-label small">
                                    <i class="bi bi-heart me-2 text-primary"></i>
                                    ${currentLang === 'ar' ? 'معدل النبض' : 'Heart Rate'}
                                </label>
                                <div class="h6 mb-0 health-metric-value">${healthMetrics.heartRate.value}</div>
                                <small class="${healthMetrics.heartRate.statusClass}">${healthMetrics.heartRate.status}</small>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="health-metric">
                                <label class="form-label health-metric-label small">
                                    <i class="bi bi-person-fill me-2 text-info"></i>
                                    ${currentLang === 'ar' ? 'الوزن' : 'Weight & BMI'}
                                </label>
                                <div class="h6 mb-0 health-metric-value">${healthMetrics.weight.value}</div>
                                <small class="health-metric-note">${healthMetrics.weight.note}</small>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="health-metric">
                                <label class="form-label health-metric-label small">
                                    <i class="bi bi-thermometer-half me-2 text-warning"></i>
                                    ${currentLang === 'ar' ? 'درجة الحرارة' : 'Temperature'}
                                </label>
                                <div class="h6 mb-0 health-metric-value">${healthMetrics.temperature.value}</div>
                                <small class="${healthMetrics.temperature.statusClass}">${healthMetrics.temperature.status}</small>
                            </div>
                        </div>
                    </div>
                    ${latestVitals ? `<p class="text-muted small mt-2"><i class="bi bi-clock me-1"></i>Last updated: ${new Date(latestVitals.measured_at).toLocaleDateString()}</p>` : ''}
                `;
            } catch (error) {
                console.error('Error loading health summary:', error);
                
                // Show error state with more helpful message
                const currentLang = LanguageManager.getLanguage() || 'en';
                const errorMessage = error.message.includes('authentication') ? 
                    (currentLang === 'ar' ? 'يرجى تسجيل الدخول مرة أخرى لعرض ملخصك الصحي' : 'Please log in again to view your health summary.') : 
                    (currentLang === 'ar' ? 'لا يمكن تحميل الملخص الصحي. يرجى المحاولة مرة أخرى لاحقاً' : 'Unable to load health summary. Please try again later.');
                
                container.innerHTML = `
                    <h5 class="mb-3">
                        <i class="bi bi-heart-pulse me-2"></i>
                        <span>${currentLang === 'ar' ? 'ملخص الحالة الصحية' : 'Health Summary'}</span>
                    </h5>
                    <div class="alert alert-warning" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        ${errorMessage}
                        <br><small class="text-muted">Error: ${error.message}</small>
                        <br><button class="btn btn-sm btn-outline-primary mt-2" onclick="loadHealthSummary()">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            ${currentLang === 'ar' ? 'إعادة المحاولة' : 'Retry'}
                        </button>
                    </div>
                `;
            }
        }

        // Calculate health metrics from patient data
        function calculateHealthMetrics(patientInfo, latestVitals) {
            const currentLang = LanguageManager.getLanguage() || 'en';
            
            // Blood Pressure
            let bloodPressure = {
                value: currentLang === 'ar' ? 'لا توجد بيانات' : 'No data',
                status: currentLang === 'ar' ? 'غير متوفر' : 'No data',
                statusClass: 'text-muted'
            };
            
            if (latestVitals?.systolic_bp && latestVitals?.diastolic_bp) {
                bloodPressure.value = `${latestVitals.systolic_bp}/${latestVitals.diastolic_bp} mmHg`;
                if (latestVitals.systolic_bp < 120 && latestVitals.diastolic_bp < 80) {
                    bloodPressure.status = currentLang === 'ar' ? 'طبيعي' : 'Normal';
                    bloodPressure.statusClass = 'text-success';
                } else if (latestVitals.systolic_bp > 140 || latestVitals.diastolic_bp > 90) {
                    bloodPressure.status = currentLang === 'ar' ? 'مرتفع' : 'High';
                    bloodPressure.statusClass = 'text-danger';
                } else {
                    bloodPressure.status = currentLang === 'ar' ? 'مرتفع قليلاً' : 'Elevated';
                    bloodPressure.statusClass = 'text-warning';
                }
            }
            
            // Heart Rate
            let heartRate = {
                value: currentLang === 'ar' ? 'لا توجد بيانات' : 'No data',
                status: currentLang === 'ar' ? 'غير متوفر' : 'No data', 
                statusClass: 'text-muted'
            };
            
            if (latestVitals?.heart_rate) {
                heartRate.value = `${latestVitals.heart_rate} bpm`;
                if (latestVitals.heart_rate >= 60 && latestVitals.heart_rate <= 100) {
                    heartRate.status = currentLang === 'ar' ? 'طبيعي' : 'Normal';
                    heartRate.statusClass = 'text-success';
                } else if (latestVitals.heart_rate < 60) {
                    heartRate.status = currentLang === 'ar' ? 'بطء القلب' : 'Low';
                    heartRate.statusClass = 'text-info';
                } else {
                    heartRate.status = currentLang === 'ar' ? 'سرعة القلب' : 'High';
                    heartRate.statusClass = 'text-warning';
                }
            }
            
            // Weight & BMI
            let weight = {
                value: currentLang === 'ar' ? 'لا توجد بيانات' : 'No data',
                note: currentLang === 'ar' ? 'غير متوفر' : 'No data'
            };
            
            const currentWeight = latestVitals?.weight || patientInfo?.weight;
            const currentHeight = latestVitals?.height || patientInfo?.height;
            
            if (currentWeight) {
                let bmiText = '';
                if (currentHeight && latestVitals?.bmi) {
                    bmiText = ` (BMI: ${latestVitals.bmi})`;
                }
                weight.value = `${currentWeight} kg${bmiText}`;
                weight.note = latestVitals ? 
                    (currentLang === 'ar' ? `آخر قياس: ${new Date(latestVitals.measured_at).toLocaleDateString()}` : `Last measured: ${new Date(latestVitals.measured_at).toLocaleDateString()}`) :
                    (currentLang === 'ar' ? 'من الملف الطبي' : 'From medical profile');
            }
            
            // Temperature
            let temperature = {
                value: currentLang === 'ar' ? 'لا توجد بيانات' : 'No data',
                status: currentLang === 'ar' ? 'غير متوفر' : 'No data',
                statusClass: 'text-muted'
            };
            
            if (latestVitals?.temperature) {
                temperature.value = `${latestVitals.temperature}°C`;
                if (latestVitals.temperature >= 36.0 && latestVitals.temperature <= 37.5) {
                    temperature.status = currentLang === 'ar' ? 'طبيعي' : 'Normal';
                    temperature.statusClass = 'text-success';
                } else if (latestVitals.temperature > 37.5) {
                    temperature.status = currentLang === 'ar' ? 'حمى' : 'Fever';
                    temperature.statusClass = 'text-danger';
                } else {
                    temperature.status = currentLang === 'ar' ? 'منخفض' : 'Low';
                    temperature.statusClass = 'text-info';
                }
            }
            
            return { bloodPressure, heartRate, weight, temperature };
        }


        // Load medical records data
        async function loadMedicalRecords() {
            const container = document.getElementById('medical-records-container');
            if (!container) return;
            
            try {
                const currentLang = LanguageManager.getLanguage() || 'en';
                const currentUser = AuthGuard.getCurrentUser();
                
                // Get patient profile ID from API, not user ID
                let currentPatientId = null;
                try {
                    const profileResponse = await ApiHelper.makeRequest(`/users/profile`);
                    if (profileResponse.success && profileResponse.user && profileResponse.user.profile) {
                        currentPatientId = profileResponse.user.profile.id;
                    }
                } catch (error) {
                }
                
                if (currentPatientId) {
                    const response = await ApiHelper.makeRequest(`/medical-history/patient/${currentPatientId}`);
                    
                    if (response.success && response.data) {
                        const data = response.data;
                        let recordCount = 0;
                        
                        // Count records
                        if (data.appointments) recordCount += data.appointments.length;
                        if (data.vital_signs) recordCount += data.vital_signs.length;
                        if (data.lab_results) recordCount += data.lab_results.length;
                        
                        if (recordCount > 0) {
                            container.innerHTML = `
                                <h5 class="mb-3">
                                    <i class="bi bi-file-medical me-2"></i>
                                    <span>${currentLang === 'ar' ? 'السجل الطبي' : 'Medical Records'}</span>
                                </h5>
                                <div class="record-summary p-3 bg-light rounded">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="h4 text-primary mb-1">${(data.appointments || []).length}</div>
                                            <small class="text-muted">${currentLang === 'ar' ? 'زيارات' : 'Visits'}</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="h4 text-success mb-1">${(data.vital_signs || []).length}</div>
                                            <small class="text-muted">${currentLang === 'ar' ? 'قياسات حيوية' : 'Vitals'}</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="h4 text-info mb-1">${(data.lab_results || []).length}</div>
                                            <small class="text-muted">${currentLang === 'ar' ? 'تحاليل' : 'Lab Results'}</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="text-center mt-3">
                                    <button class="btn btn-outline-primary btn-sm" onclick="viewRecords()">
                                        <i class="bi bi-file-text me-1"></i>
                                        ${currentLang === 'ar' ? 'عرض السجل الكامل' : 'View Full Records'}
                                    </button>
                                </div>
                            `;
                        } else {
                            throw new Error('No medical records');
                        }
                    } else {
                        throw new Error('Failed to load medical records');
                    }
                } else {
                    throw new Error('No current user');
                }
            } catch (error) {
                const fallbackLang = LanguageManager.getLanguage() || 'en';
                container.innerHTML = `
                    <h5 class="mb-3">
                        <i class="bi bi-file-medical me-2"></i>
                        <span>${fallbackLang === 'ar' ? 'السجل الطبي' : 'Medical Records'}</span>
                    </h5>
                    <p class="text-center py-3" style="color: #666;">${fallbackLang === 'ar' ? 'ابدأ رحلتك الصحية بحجز أول موعد' : 'Start your health journey by booking your first appointment'}</p>
                    <div class="text-center mt-3">
                        <button class="btn btn-outline-primary btn-sm" onclick="bookAppointment()">
                            <i class="bi bi-plus-circle me-1"></i>
                            ${fallbackLang === 'ar' ? 'حجز موعد' : 'Book Appointment'}
                        </button>
                    </div>
                `;
            }
        }

        // Load dashboard statistics from API
        async function loadDashboardStats() {
            try {
                // Load appointments to count scheduled ones
                const appointmentsResponse = await ApiHelper.makeRequest('/appointments/');
                
                if (appointmentsResponse.success) {
                    const appointments = appointmentsResponse.data.appointments;
                    
                    // Get upcoming appointments for display (including today's appointments)
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // Start of today
                    
                    
                    const upcomingAppointments = appointments.filter(apt => {
                        const isValidStatus = ['scheduled', 'confirmed', 'in_progress'].includes(apt.status);
                        const aptDate = new Date(apt.appointment_date);
                        const isUpcoming = aptDate >= today; // Include today's appointments
                        
                        return isValidStatus && isUpcoming;
                    }).sort((a, b) => new Date(a.appointment_date) - new Date(b.appointment_date));
                    
                    // Update appointment counter
                    document.getElementById('stat-appointments-count').textContent = upcomingAppointments.length;
                    
                    // Update appointments list with matching color scheme from doctor.html
                    const appointmentsContainer = document.getElementById('appointments-container');
                    if (appointmentsContainer) {
                        if (upcomingAppointments.length > 0) {
                            appointmentsContainer.innerHTML = `
                                <h5 class="mb-3">
                                    <i class="bi bi-calendar-day me-2"></i>
                                    <span>${LanguageManager.getLanguage() === 'ar' ? 'المواعيد القادمة' : 'Upcoming Appointments'}</span>
                                </h5>
                                ${upcomingAppointments.slice(0, 3).map(apt => {
                                    const appointmentDate = new Date(apt.appointment_date);
                                    const dateStr = appointmentDate.toLocaleDateString('en-US', { 
                                        weekday: 'short', 
                                        month: 'short', 
                                        day: 'numeric' 
                                    });
                                    const timeStr = appointmentDate.toLocaleTimeString('en-US', { 
                                        hour: 'numeric', 
                                        minute: '2-digit',
                                        hour12: true 
                                    });
                                    
                                    // Add video consultation class if video appointment
                                    const videoClass = apt.appointment_type === 'video' ? 'appointment-card video-appointment' : 'appointment-card';
                                    
                                    // Generate video consultation button if applicable
                                    const videoButton = (typeof VideoConsultationDashboard !== 'undefined' && VideoConsultationDashboard.generateVideoConsultationButton) 
                                        ? VideoConsultationDashboard.generateVideoConsultationButton(apt) 
                                        : (apt.appointment_type === 'video' ? `<button class="btn btn-secondary btn-sm" disabled>Loading...</button>` : '');
                                    
                                    // Check if appointment can be modified (1 hour before and not cancelled/completed)
                                    const canModify = ['scheduled', 'confirmed'].includes(apt.status) && 
                                                     apt.status !== 'cancelled' &&
                                                     apt.status !== 'completed' &&
                                                     appointmentDate > new Date(Date.now() + 60*60*1000);
                                                     
                                                    
                                    // Get translation texts
                                    const cancelText = LanguageManager?.translate('appointments.cancel') || 'Cancel';
                                    const rescheduleText = LanguageManager?.translate('appointments.reschedule') || 'Reschedule';
                                    
                                    return `
                                        <div class="${videoClass}" data-appointment-id="${apt.id}">
                                            <div class="appointment-item p-3 mb-2 bg-light rounded">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="flex-grow-1">
                                                        <div style="color: black;"><strong>${apt.doctor_name || 'Unknown Doctor'}</strong></div>
                                                        <div class="text-muted small">
                                                            <i class="bi ${apt.appointment_type === 'video' ? 'bi-camera-video' : 'bi-calendar-check'} me-1"></i>${apt.appointment_type}
                                                        </div>
                                                        ${apt.reason_for_visit ? `<div class="text-muted small">${apt.reason_for_visit}</div>` : ''}
                                                        <div class="small" style="color: darkgreen;">
                                                            <i class="bi bi-calendar me-1"></i>${dateStr} ${timeStr}
                                                        </div>
                                                        ${videoButton ? `<div class="mt-2">${videoButton}</div>` : ''}
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="mb-2">
                                                            <span class="badge bg-primary">${apt.status}</span>
                                                        </div>
                                                        ${canModify ? `
                                                            <div class="btn-group-vertical btn-group-sm">
                                                                <button class="btn btn-outline-warning btn-sm" onclick="PatientDashboard.rescheduleAppointment(${apt.id})" title="${rescheduleText}">
                                                                    <i class="bi bi-calendar-event me-1"></i>${rescheduleText}
                                                                </button>
                                                                <button class="btn btn-outline-danger btn-sm" onclick="PatientDashboard.cancelAppointment(${apt.id})" title="${cancelText}">
                                                                    <i class="bi bi-x-circle me-1"></i>${cancelText}
                                                                </button>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                                <div class="text-center mt-3">
                                    <button class="btn btn-outline-primary btn-sm" onclick="viewPastAppointments()">
                                        <i class="bi bi-calendar-check me-1"></i>
                                        <span id="btn-view-past">${LanguageManager?.translate('appointments.view_past_appointments') || 'View Past Appointments'}</span>
                                    </button>
                                </div>
                            `;
                        } else {
                            appointmentsContainer.innerHTML = `
                                <h5 class="mb-3">
                                    <i class="bi bi-calendar-day me-2"></i>
                                    <span>${LanguageManager.getLanguage() === 'ar' ? 'المواعيد القادمة' : 'Upcoming Appointments'}</span>
                                </h5>
                                <p class="text-center py-3" style="color: black;"><span id="no-upcoming-appointments">No upcoming appointments</span></p>
                                <div class="text-center mt-3">
                                    <button class="btn btn-outline-primary btn-sm" onclick="viewPastAppointments()">
                                        <i class="bi bi-calendar-check me-1"></i>
                                        <span id="btn-view-past">${LanguageManager?.translate('appointments.view_past_appointments') || 'View Past Appointments'}</span>
                                    </button>
                                </div>
                            `;
                        }
                    }
                    
                } else {
                    document.getElementById('stat-appointments-count').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                document.getElementById('stat-appointments-count').textContent = '-';
            }
            
            try {
                // Load prescriptions count from API
                const prescriptionsResponse = await ApiHelper.makeRequest('/prescriptions/');
                
                if (prescriptionsResponse.success) {
                    const prescriptions = prescriptionsResponse.data.prescriptions || [];
                    
                    // Count active prescriptions
                    const activeCount = prescriptions.filter(prescription => 
                        prescription.status === 'active'
                    ).length;
                    
                    document.getElementById('stat-prescriptions-count').textContent = activeCount;
                } else {
                    document.getElementById('stat-prescriptions-count').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading prescriptions stats:', error);
                document.getElementById('stat-prescriptions-count').textContent = '-';
            }
            
            try {
                // Load medical history/reports count from API
                const currentUser = AuthGuard.getCurrentUser();
                
                // Get patient profile ID from API, not user ID
                let currentPatientId = null;
                try {
                    const profileResponse = await ApiHelper.makeRequest(`/users/profile`);
                    if (profileResponse.success && profileResponse.user && profileResponse.user.profile) {
                        currentPatientId = profileResponse.user.profile.id;
                    }
                } catch (error) {
                }
                
                if (currentPatientId) {
                    const historyResponse = await ApiHelper.makeRequest(`/medical-history/patient/${currentPatientId}`);
                    
                    if (historyResponse.success) {
                        const historyData = historyResponse.data;
                        
                        // Count medical reports/records (appointments with diagnosis, lab results, etc.)
                        let reportCount = 0;
                        if (historyData.appointments) {
                            reportCount += historyData.appointments.filter(apt => 
                                apt.diagnosis || apt.prescription || apt.notes
                            ).length;
                        }
                        if (historyData.vital_signs) {
                            reportCount += historyData.vital_signs.length;
                        }
                        if (historyData.lab_results) {
                            reportCount += historyData.lab_results.length;
                        }
                        
                        document.getElementById('stat-reports-count').textContent = reportCount;
                    } else {
                        document.getElementById('stat-reports-count').textContent = '0';
                    }
                } else {
                    document.getElementById('stat-reports-count').textContent = '0';
                }
            } catch (error) {
                // For 403 errors (new users), show 0 instead of error
                if (error.statusCode === 403) {
                    document.getElementById('stat-reports-count').textContent = '0';
                } else {
                    console.error('Error loading medical reports stats:', error);
                    document.getElementById('stat-reports-count').textContent = '0';
                }
            }
        }
        
        // Refresh dashboard statistics - can be called from other pages
        window.refreshDashboardStats = function() {
            loadDashboardStats();
            // Also refresh video consultation dashboard if available
            if (typeof VideoConsultationDashboard !== 'undefined' && VideoConsultationDashboard.refreshVideoConsultationData) {
                VideoConsultationDashboard.refreshVideoConsultationData();
            }
        };

        document.addEventListener('DOMContentLoaded', async function() {
            // Ensure title is correct for patient dashboard
            document.title = 'Patient Dashboard - Sahatak';
            
            // Initialize dashboard translations first
            await DashboardTranslations.initializeDashboard('patient');
            
            // Apply current language to the dashboard
            const currentLang = LanguageManager.getLanguage() || 'ar';
            DashboardTranslations.updatePatientDashboard(currentLang);
            
            // Initialize video consultation dashboard with retry
            let retryCount = 0;
            const initVideoConsultationDashboard = () => {
                if (typeof VideoConsultationDashboard !== 'undefined') {
                    VideoConsultationDashboard.init();
                    
                    // Start automatic status monitoring for video appointments
                    startVideoStatusMonitoring();
                    
                    // Refresh dashboard stats to update buttons
                    setTimeout(() => {
                        loadDashboardStats();
                    }, 500);
                } else {
                    retryCount++;
                    if (retryCount < 20) { // Max 2 seconds of retries
                        setTimeout(initVideoConsultationDashboard, 100);
                    } else {
                        console.error('VideoConsultationDashboard failed to load after 20 attempts');
                    }
                }
            };
            initVideoConsultationDashboard();
            
            // Load dashboard statistics after translations are loaded
            setTimeout(() => {
                loadDashboardStats();
                loadHealthSummary();
            }, 1000); // Small delay to ensure API is ready
        });

        // Automatic video status monitoring for patients
        let videoStatusMonitorInterval = null;
        
        function startVideoStatusMonitoring() {
            // Clear any existing interval
            if (videoStatusMonitorInterval) {
                clearInterval(videoStatusMonitorInterval);
            }
            
            // Check every 2 seconds for video appointment status updates (very fast sync for patients)
            videoStatusMonitorInterval = setInterval(async () => {
                try {
                    // Find any video appointments that might need status updates
                    const videoCards = document.querySelectorAll('.appointment-card[data-appointment-id]');
                    
                    for (const card of videoCards) {
                        const appointmentId = card.dataset.appointmentId;
                        const appointmentStatus = card.dataset.appointmentStatus;
                        
                        // Check scheduled, in_progress, and completed appointments for status changes
                        if (appointmentId && (appointmentStatus === 'scheduled' || appointmentStatus === 'in_progress' || appointmentStatus === 'completed')) {
                            if (typeof VideoConsultationDashboard !== 'undefined' && VideoConsultationDashboard.checkVideoSessionStatus) {
                                await VideoConsultationDashboard.checkVideoSessionStatus(appointmentId, true);
                                
                                // Force aggressive dashboard refresh for immediate UI updates
                                if (window.refreshDashboardStats) {
                                    window.refreshDashboardStats();
                                }
                                
                                // Additional refresh for completed appointments to ensure UI reflects changes
                                if (appointmentStatus === 'completed') {
                                    setTimeout(() => {
                                        if (window.refreshDashboardStats) {
                                            window.refreshDashboardStats();
                                        }
                                    }, 500);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error in video status monitoring:', error);
                }
            }, 2000); // Check every 2 seconds for very fast response
        }
        
        function stopVideoStatusMonitoring() {
            if (videoStatusMonitorInterval) {
                clearInterval(videoStatusMonitorInterval);
                videoStatusMonitorInterval = null;
            }
        }

        // PatientDashboard object for appointment management
        const PatientDashboard = {
            currentAppointmentId: null,
            currentAppointment: null,
            selectedNewDateTime: null,

            // Cancel appointment
            cancelAppointment(appointmentId) {
                this.currentAppointmentId = appointmentId;
                document.getElementById('cancellation-reason').value = '';
                const cancelModal = new bootstrap.Modal(document.getElementById('cancel-modal'));
                cancelModal.show();
            },

            // Reschedule appointment
            rescheduleAppointment(appointmentId) {
                // Find appointment in current appointments list
                const appointmentElement = document.querySelector(`[data-appointment-id="${appointmentId}"]`);
                if (!appointmentElement) return;

                this.currentAppointmentId = appointmentId;
                
                // Mock appointment data (in real app, get from API)
                this.currentAppointment = {
                    id: appointmentId,
                    doctor_name: appointmentElement.querySelector('strong').textContent,
                    appointment_date: new Date(), // Would get from API
                    doctor_id: 1 // Would get from API
                };

                // Show current appointment info
                const date = new Date(this.currentAppointment.appointment_date);
                const currentLang = LanguageManager?.getLanguage() || 'en';
                const dateLabel = currentLang === 'ar' ? 'التاريخ:' : 'Date:';
                const timeLabel = currentLang === 'ar' ? 'الوقت:' : 'Time:';
                const doctorLabel = currentLang === 'ar' ? 'الطبيب:' : 'Doctor:';

                document.getElementById('current-appointment-info').innerHTML = `
                    <strong>${dateLabel}</strong> ${date.toLocaleDateString()}<br>
                    <strong>${timeLabel}</strong> ${date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}<br>
                    <strong>${doctorLabel}</strong> ${this.currentAppointment.doctor_name}
                `;

                // Reset form
                document.getElementById('new-appointment-date').value = '';
                document.getElementById('reschedule-reason').value = '';
                document.getElementById('reschedule-time-slots').innerHTML = '';
                document.getElementById('confirm-reschedule').disabled = true;
                this.selectedNewDateTime = null;

                // Set minimum date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('new-appointment-date').min = today;

                // Add event listener for date change
                document.getElementById('new-appointment-date').onchange = () => this.loadRescheduleTimeSlots();

                const rescheduleModal = new bootstrap.Modal(document.getElementById('reschedule-modal'));
                rescheduleModal.show();
            },

            // Load available time slots for reschedule
            async loadRescheduleTimeSlots() {
                if (!this.currentAppointment) return;

                const date = document.getElementById('new-appointment-date').value;
                if (!date) return;

                try {
                    const response = await ApiHelper.makeRequest(
                        `/appointments/doctors/${this.currentAppointment.doctor_id}/availability?date=${date}`
                    );

                    if (response.success) {
                        this.renderRescheduleTimeSlots(response.data.available_slots);
                    } else {
                        const currentLang = LanguageManager?.getLanguage() || 'en';
                        const errorMsg = currentLang === 'ar' ? 'فشل في تحميل الأوقات المتاحة' : 'Failed to load available times';
                        this.showError(errorMsg);
                    }
                } catch (error) {
                    console.error('Error loading time slots:', error);
                    const currentLang = LanguageManager?.getLanguage() || 'en';
                    const errorMsg = currentLang === 'ar' ? 'خطأ في تحميل الأوقات المتاحة' : 'Error loading available times';
                    this.showError(errorMsg);
                }
            },

            // Render time slots for reschedule
            renderRescheduleTimeSlots(slots) {
                const container = document.getElementById('reschedule-time-slots');

                if (slots.length === 0) {
                    const currentLang = LanguageManager?.getLanguage() || 'en';
                    const noSlotsMessage = currentLang === 'ar' ? 
                        'لا توجد أوقات متاحة في هذا اليوم' : 
                        'No time slots available for this day';
                    container.innerHTML = `<p class="text-muted">${noSlotsMessage}</p>`;
                    return;
                }

                const slotsHtml = slots.map(slot => `
                    <button type="button" 
                            class="btn btn-outline-primary time-slot ${!slot.available ? 'disabled' : ''}"
                            data-time="${slot.datetime}"
                            onclick="PatientDashboard.selectRescheduleTimeSlot('${slot.datetime}', '${slot.start}')"
                            ${!slot.available ? 'disabled' : ''}>
                        ${slot.start}
                    </button>
                `).join('');

                container.innerHTML = slotsHtml;
            },

            // Select time slot for reschedule
            selectRescheduleTimeSlot(datetime, displayTime) {
                // Remove previous selection
                document.querySelectorAll('#reschedule-time-slots .time-slot').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Add selection to clicked button
                event.target.classList.add('active');

                // Store selected time
                this.selectedNewDateTime = datetime;

                // Enable confirm button
                document.getElementById('confirm-reschedule').disabled = false;
            },

            // Confirm cancellation
            async confirmCancellation() {
                if (!this.currentAppointmentId) {
                    console.error('No appointment ID selected for cancellation');
                    return;
                }


                try {
                    const reason = document.getElementById('cancellation-reason').value;
                    
                    const response = await ApiHelper.makeRequest(`/appointments/${this.currentAppointmentId}/cancel`, {
                        method: 'PUT',
                        body: JSON.stringify({ cancellation_reason: reason })
                    });


                    if (response.success) {
                        // Close modal
                        bootstrap.Modal.getInstance(document.getElementById('cancel-modal')).hide();

                        // Reload dashboard stats to refresh appointments
                        loadDashboardStats();

                        const currentLang = LanguageManager?.getLanguage() || 'en';
                        const successMsg = currentLang === 'ar' ? 'تم إلغاء الموعد بنجاح' : 'Appointment cancelled successfully';
                        this.showSuccess(successMsg);
                    } else {
                        // Handle specific error cases
                        let errorMessage = response.message || 'Failed to cancel appointment';
                        
                        if (response.message && response.message.includes('already cancelled')) {
                            // Close modal and refresh if already cancelled
                            bootstrap.Modal.getInstance(document.getElementById('cancel-modal')).hide();
                            loadDashboardStats(); // Refresh to show current status
                            
                            const currentLang = LanguageManager?.getLanguage() || 'en';
                            errorMessage = currentLang === 'ar' ? 'هذا الموعد ملغى بالفعل' : 'This appointment is already cancelled';
                        }
                        
                        this.showError(errorMessage);
                    }
                } catch (error) {
                    console.error('Error cancelling appointment:', error);
                    const currentLang = LanguageManager?.getLanguage() || 'en';
                    const errorMsg = currentLang === 'ar' ? 'خطأ في إلغاء الموعد' : 'Error cancelling appointment';
                    this.showError(errorMsg);
                }
            },

            // Confirm reschedule
            async confirmReschedule() {
                if (!this.currentAppointmentId || !this.selectedNewDateTime) return;

                try {
                    const reason = document.getElementById('reschedule-reason').value;
                    const response = await ApiHelper.makeRequest(`/appointments/${this.currentAppointmentId}/reschedule`, {
                        method: 'PUT',
                        body: JSON.stringify({ 
                            new_appointment_date: this.selectedNewDateTime,
                            reschedule_reason: reason 
                        })
                    });

                    if (response.success) {
                        // Close modal
                        bootstrap.Modal.getInstance(document.getElementById('reschedule-modal')).hide();

                        // Reload dashboard stats
                        loadDashboardStats();

                        const currentLang = LanguageManager?.getLanguage() || 'en';
                        const successMsg = currentLang === 'ar' ? 'تم إعادة جدولة الموعد بنجاح' : 'Appointment rescheduled successfully';
                        this.showSuccess(successMsg);
                    } else {
                        this.showError(response.message || 'Failed to reschedule appointment');
                    }
                } catch (error) {
                    console.error('Error rescheduling appointment:', error);
                    const currentLang = LanguageManager?.getLanguage() || 'en';
                    const errorMsg = currentLang === 'ar' ? 'خطأ في إعادة جدولة الموعد' : 'Error rescheduling appointment';
                    this.showError(errorMsg);
                }
            },

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
                errorDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
                errorDiv.innerHTML = `
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(errorDiv);
                
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 5000);
            },

            showSuccess(message) {
                const successDiv = document.createElement('div');
                successDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                successDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
                successDiv.innerHTML = `
                    <i class="bi bi-check-circle-fill me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.remove();
                    }
                }, 3000);
            }
        };
    </script>

    <!-- Cancel Confirmation Modal -->
    <div class="modal fade" id="cancel-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span id="cancel-modal-title">Confirm Cancellation</span>
                    </h5>
                </div>
                <div class="modal-body">
                    <p id="cancel-modal-message" style="color: #212529;">Are you sure you want to cancel this appointment?</p>
                    <div class="mb-3">
                        <label for="cancellation-reason" class="form-label" id="cancellation-reason-label" style="color: #212529;">Reason for cancellation (optional)</label>
                        <textarea class="form-control" id="cancellation-reason" rows="3" 
                                placeholder="Write the reason for cancelling the appointment..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="PatientDashboard.confirmCancellation()">
                        <i class="bi bi-check me-1"></i>
                        <span id="confirm-cancel-btn">Yes, Cancel Appointment</span>
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="keep-appointment-btn">Keep Appointment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reschedule Modal -->
    <div class="modal fade" id="reschedule-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar-event text-primary me-2"></i>
                        <span id="reschedule-modal-title">Reschedule Appointment</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="reschedule-modal-subtitle" style="color: #212529;">Select new date and time</p>
                    
                    <!-- Current appointment info -->
                    <div class="alert alert-info mb-4">
                        <h6 class="mb-2" id="current-appointment-label" style="color: #212529;">Current Appointment:</h6>
                        <div id="current-appointment-info">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- New date selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="new-appointment-date" class="form-label" id="new-date-label" style="color: #212529;">New Date</label>
                            <input type="date" class="form-control" id="new-appointment-date">
                        </div>
                    </div>
                    
                    <!-- Available time slots -->
                    <div id="reschedule-time-slots-container" class="mb-4">
                        <h6 class="mb-3" id="new-time-label" style="color: #212529;">Available Times</h6>
                        <div id="reschedule-time-slots" class="d-flex flex-wrap gap-2">
                            <!-- Time slots will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Reschedule reason -->
                    <div class="mb-3">
                        <label for="reschedule-reason" class="form-label" id="reschedule-reason-label" style="color: #212529;">Reason for rescheduling (optional)</label>
                        <textarea class="form-control" id="reschedule-reason" rows="3" 
                                placeholder="Write the reason for rescheduling the appointment..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="PatientDashboard.confirmReschedule()" id="confirm-reschedule" disabled>
                        <i class="bi bi-calendar-check me-1"></i>
                        <span id="confirm-reschedule-btn">Confirm Reschedule</span>
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Triage Modal -->
    <div class="modal fade" id="ai-triage-modal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-primary">
                        <i class="bi bi-chat-heart me-2"></i>
                        <span id="triage-modal-title">Quick Health Check</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Chat container styled to match dashboard -->
                    <div id="chatMessages" class="triage-chat-container mb-3"></div>
                    
                    <!-- Loading indicator (hidden by default) -->
                    <div id="loadingIndicator" class="triage-loading text-center d-none">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2" id="loading-text">Analyzing...</span>
                    </div>
                    
                    <!-- Input area -->
                    <div class="input-group">
                        <input type="text" 
                               class="form-control" 
                               id="messageInput" 
                               placeholder=""
                               maxlength="1000">
                        <button class="btn btn-primary" 
                                type="button" 
                                id="sendBtn">
                            <i class="bi bi-send"></i>
                        </button>
                        <button class="btn btn-outline-secondary" 
                                type="button" 
                                id="micBtn"
                                title="Voice input"
                                id="voice-button-title">
                            <i class="bi bi-mic"></i>
                        </button>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted" id="disclaimer-text"></small>
                    </div>
                </div>
                <div class="modal-footer border-0 d-none" id="triage-actions">
                    <button type="button" 
                            class="btn btn-success" 
                            onclick="proceedToBooking()" 
                            id="triage-booking-btn">
                        <i class="bi bi-calendar-plus me-2"></i>
                        <span>حجز موعد</span>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <span>إغلاق</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assessment Component -->
    <script src="../../assets/js/components/ai-assessment.js"></script>
    
    <!-- Mobile Patient Optimization Script -->
    <script src="../../assets/js/mobile-patient.js"></script>
</body>
</html>