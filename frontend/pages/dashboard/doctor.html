<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard - Sahatak</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><path fill='%230d47a1' d='m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523.942-.661 2.27.067 3.71L8 15.5l6.533-8.737c.728-1.44.59-2.768.067-3.71C13.486.878 10.4.28 8.717 2.01L8 2.748z'/></svg>">
    
    <!-- Bootstrap 5 CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <!-- Bootstrap Icons CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    
    <!-- Arabic Font - Noto Sans Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Main CSS -->
    <link rel="stylesheet" href="../../assets/css/main.css">
    <!-- Dashboard CSS -->
    <link rel="stylesheet" href="../../assets/css/components/dashboard.css">
    <!-- Video Consultation Dashboard CSS -->
    <link rel="stylesheet" href="../../assets/css/components/video-consultation-dashboard.css">
    <style>
        /* Unverified doctor states */
        .unverified-disabled {
            opacity: 0.5;
            cursor: not-allowed !important;
            pointer-events: none;
        }
        
        .verification-overlay {
            position: relative;
        }
        
        .verification-overlay::after {
            content: "🔒 Verification Required";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #dc3545;
            border: 1px solid #dc3545;
            z-index: 10;
            display: none;
        }
        
        .unverified-disabled.verification-overlay::after {
            display: block;
        }
        
        .verification-notice {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .verification-notice .notice-icon {
            color: #856404;
            font-size: 24px;
        }
        
        /* Video consultation button styling */
        .btn-complete-consultation {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-complete-consultation:hover {
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .btn-consultation-ended {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        /* Animation for removing appointments */
        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.95);
            }
        }
        
        /* Pagination Styles */
        .pagination-controls {
            font-size: 14px;
        }
        
        .pagination-controls .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.25rem;
            transition: all 0.15s ease-in-out;
        }
        
        .pagination-controls .btn-outline-secondary:hover:not(:disabled) {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        
        .pagination-controls .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-controls .d-flex.gap-1 > .btn {
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .pagination-controls .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        
        .pagination-controls .btn-primary:hover {
            background-color: #0056b3;
            border-color: #004085;
        }
        
        /* Page info styling */
        #activity-page-info, #appointments-page-info {
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* Responsive pagination */
        @media (max-width: 768px) {
            .pagination-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .pagination-controls .d-flex:first-child,
            .pagination-controls .d-flex:last-child {
                justify-content: center;
            }
            
            #activity-page-info, #appointments-page-info {
                text-align: center;
                margin-bottom: 0.5rem;
            }
        }
    </style>
</head>
<body data-protect="doctor">
    <div class="dashboard-container">
        <div class="container-fluid">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="row align-items-center">
                    <!-- Profile Section - Left (Right in RTL) -->
                    <div class="col-lg-4">
                        <div class="profile-section">
                            <div class="user-avatar">
                                <i class="bi bi-person-badge"></i>
                            </div>
                            <div class="user-details">
                                <h5 class="mb-1" id="user-name">Loading...</h5>
                                <span class="badge bg-warning text-dark" id="verification-status">Unverified</span>
                            </div>
                            <!-- Vertical Action Buttons -->
                            <div class="action-buttons">
                                <button class="btn btn-action" onclick="showProfile()" title="Profile">
                                    <i class="bi bi-person"></i>
                                    <span id="btn-profile">Profile</span>
                                </button>
                                <button class="btn btn-action" onclick="showSettings()" title="Settings">
                                    <i class="bi bi-gear"></i>
                                    <span id="btn-settings">Settings</span>
                                </button>
                                <button class="btn btn-action btn-logout" onclick="AuthGuard.logout()" title="Logout">
                                    <i class="bi bi-box-arrow-right"></i>
                                    <span id="btn-logout">Logout</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dashboard Title - Center -->
                    <div class="col-lg-4 text-center">
                        <h1 class="dashboard-title" id="dashboard-title">Doctor Dashboard</h1>
                        <p class="dashboard-subtitle" id="dashboard-subtitle">Manage Patients and Medical Consultations</p>
                    </div>
                    
                    <!-- Controls - Right (Left in RTL) -->
                    <div class="col-lg-4 text-end">
                        <div class="dashboard-controls">
                            <button class="btn btn-outline-medical btn-sm" onclick="toggleAvailability()">
                                <i class="bi bi-circle-fill text-success me-1"></i>
                                <span id="availability-status">Available</span>
                            </button>
                            <button class="btn btn-outline-medical btn-sm" onclick="showLanguageSelector()">
                                <i class="bi bi-globe me-1"></i>
                                <span id="current-lang">English</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Verification Notice (Hidden by default, shown for unverified doctors) -->
            <div id="verification-notice" class="row" style="display: none;">
                <div class="col-12">
                    <div class="verification-notice">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-shield-exclamation notice-icon me-3"></i>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 text-warning-emphasis" id="notice-title">Account Verification Required</h6>
                                <p class="mb-0 text-muted" id="notice-message">
                                    Your doctor account needs to be verified before you can access patient consultations and manage appointments. 
                                    Please complete your profile and wait for admin approval.
                                </p>
                            </div>
                            <button class="btn btn-outline-warning btn-sm" onclick="showProfile()">
                                <i class="bi bi-person-check me-1"></i>
                                <span id="complete-profile">Complete Profile</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Main Content -->
                <div class="col-12">
                    <!-- Quick Actions -->
                    <div class="row mb-4">
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div id="communication-card" class="dashboard-card quick-action-card verification-overlay" onclick="handleVerifiedAction('openCommunicationHub')">
                                <div class="quick-action-icon">
                                    <i class="bi bi-chat-dots"></i>
                                </div>
                                <h6 id="action-communication">Patient Communication</h6>
                                <p class="text-muted small" id="action-communication-desc">Message and connect with patients</p>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div id="records-card" class="dashboard-card quick-action-card verification-overlay" onclick="handleVerifiedAction('reviewRecords')">
                                <div class="quick-action-icon">
                                    <i class="bi bi-file-medical"></i>
                                </div>
                                <h6 id="action-records">Review Records</h6>
                                <p class="text-muted small" id="action-records-desc">View patient files</p>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div id="availability-card" class="dashboard-card quick-action-card verification-overlay" onclick="handleVerifiedAction('manageAvailability')">
                                <div class="quick-action-icon">
                                    <i class="bi bi-calendar-week"></i>
                                </div>
                                <h6 id="action-schedule">Manage Availability</h6>
                                <p class="text-muted small" id="action-schedule-desc">Set available hours and block time slots</p>
                            </div>
                        </div>
                    </div>


                    <!-- Content Sections -->
                    <div class="row">
                        <!-- Schedule -->
                        <div class="col-lg-6 mb-4">
                            <div id="schedule-card" class="dashboard-card verification-overlay">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 id="schedule-title" class="mb-0">
                                        <i class="bi bi-calendar-day me-2"></i>
                                        Schedule
                                    </h5>
                                    <small class="text-muted" id="appointments-page-info">Page 1</small>
                                </div>
                                <div id="appointments-container">
                                    <!-- Appointments will be loaded dynamically -->
                                </div>
                                <!-- Pagination Controls for Appointments -->
                                <div id="appointments-pagination" class="pagination-controls d-flex justify-content-between align-items-center mt-3" style="display: none !important;">
                                    <button id="appointments-prev-btn" class="btn btn-sm btn-outline-secondary" onclick="changeAppointmentsPage('prev')" disabled>
                                        <i class="bi bi-chevron-left"></i> Prev
                                    </button>
                                    <div id="appointments-page-numbers" class="d-flex gap-1">
                                        <!-- Page numbers will be generated dynamically -->
                                    </div>
                                    <button id="appointments-next-btn" class="btn btn-sm btn-outline-secondary" onclick="changeAppointmentsPage('next')">
                                        Next <i class="bi bi-chevron-right"></i>
                                    </button>
                                </div>
                                <div class="text-center mt-3">
                                    <button class="btn btn-outline-medical" onclick="handleVerifiedAction('viewFullSchedule')">
                                        <span id="view-full-schedule">View Full Schedule</span>
                                        <i class="bi bi-arrow-right ms-1"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Statistics -->
                        <div class="col-lg-6 mb-4">
                            <div id="stats-card" class="dashboard-card verification-overlay">
                                <h5 id="quick-stats-title">
                                    <i class="bi bi-graph-up me-2"></i>
                                    Quick Statistics
                                </h5>
                                <div id="doctor-stats-container">
                                    <!-- Doctor statistics will be loaded dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Waiting Patients & Recent Activity -->
                    <div class="row">
                        <!-- Waiting Patients -->
                        <div class="col-lg-6 mb-4">
                            <div id="waiting-card" class="dashboard-card verification-overlay">
                                <h5 id="waiting-title">
                                    <i class="bi bi-hourglass-split me-2"></i>
                                    Patients Waiting for Response
                                </h5>
                                <div id="waiting-patients-container">
                                    <!-- Waiting patients will be loaded dynamically -->
                                </div>
                                <div class="text-center mt-3">
                                    <button class="btn btn-outline-medical" onclick="handleVerifiedAction('viewAllMessages')">
                                        <span id="view-all-messages">View All Messages</span>
                                        <i class="bi bi-arrow-right ms-1"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="col-lg-6 mb-4">
                            <div id="activity-card" class="dashboard-card verification-overlay">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 id="activity-title" class="mb-0">
                                        <i class="bi bi-activity me-2"></i>
                                        Recent Activity
                                    </h5>
                                    <small class="text-muted" id="activity-page-info">Page 1</small>
                                </div>
                                <div id="recent-activity-container">
                                    <!-- Recent activity will be loaded dynamically -->
                                </div>
                                <!-- Pagination Controls -->
                                <div id="activity-pagination" class="pagination-controls d-flex justify-content-between align-items-center mt-3" style="display: none !important;">
                                    <button id="activity-prev-btn" class="btn btn-sm btn-outline-secondary" onclick="changeActivityPage('prev')" disabled>
                                        <i class="bi bi-chevron-left"></i> Prev
                                    </button>
                                    <div id="activity-page-numbers" class="d-flex gap-1">
                                        <!-- Page numbers will be generated dynamically -->
                                    </div>
                                    <button id="activity-next-btn" class="btn btn-sm btn-outline-secondary" onclick="changeActivityPage('next')">
                                        Next <i class="bi bi-chevron-right"></i>
                                    </button>
                                </div>
                                <div class="text-center mt-3">
                                    <button class="btn btn-outline-medical" onclick="handleVerifiedAction('viewAllActivity')">
                                        <span id="view-all-activity">View All Activities</span>
                                        <i class="bi bi-arrow-right ms-1"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

            <!-- Profile Section (Hidden by default) -->
            <div id="profile-section" class="row mt-4" style="display: none;">
                <div class="col-12">
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5><i class="bi bi-person me-2"></i><span id="profile-title">Doctor Profile</span></h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="hideProfile()">
                                <i class="bi bi-x-lg me-1"></i><span id="close-profile">Close</span>
                            </button>
                        </div>

                        <div class="row g-4">
                            <!-- Personal Information -->
                            <div class="col-lg-6">
                                <div class="settings-group">
                                    <h6 class="settings-group-title">
                                        <i class="bi bi-person-badge me-2"></i><span id="personal-info">Personal Information</span>
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-doctor-id">Doctor ID</label>
                                        <p class="form-control-plaintext" id="doctorId">DOC-2024-001</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-full-name">Full Name</label>
                                        <p class="form-control-plaintext" id="profileFullName">Dr. Sarah Ahmed</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-email">Email Address</label>
                                        <p class="form-control-plaintext" id="profileEmail">sarah.ahmed@sahatak.com</p>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-phone">Phone Number</label>
                                        <div class="row g-2">
                                            <div class="col-md-4">
                                                <select class="form-select" id="profilePhoneCountry">
                                                    <option value="" id="select-country">Select Country</option>
                                                    <option value="SD" id="country-sudan">🇸🇩 Sudan (+249)</option>
                                                    <option value="EG" id="country-egypt">🇪🇬 Egypt (+20)</option>
                                                    <option value="SA" id="country-saudi">🇸🇦 Saudi Arabia (+966)</option>
                                                    <option value="AE" id="country-uae">🇦🇪 UAE (+971)</option>
                                                    <option value="IE" id="country-ireland">🇮🇪 Ireland (+353)</option>
                                                    <option value="US" id="country-usa">🇺🇸 United States (+1)</option>
                                                    <option value="GB" id="country-uk">🇬🇧 United Kingdom (+44)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-8">
                                                <input type="tel" class="form-control" id="profilePhone" placeholder="123456789">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-medical-license">Medical License Number</label>
                                        <p class="form-control-plaintext" id="profileMedicalLicense">ML-2019-12345</p>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-specialization">Specialization</label>
                                        <p class="form-control-plaintext" id="profileSpecialization">Internal Medicine</p>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-experience">Years of Experience</label>
                                        <input type="number" class="form-control" id="profileExperience" min="0" max="60">
                                    </div>
                                </div>
                            </div>

                            <!-- Professional Information -->
                            <div class="col-lg-6">
                                <div class="settings-group">
                                    <h6 class="settings-group-title">
                                        <i class="bi bi-hospital me-2"></i><span id="professional-info">Professional Information</span>
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-hospital-affiliations">Hospital Affiliations</label>
                                        <input type="text" class="form-control" id="profileHospitals" placeholder="e.g., Cairo Medical Center, Al-Azhar Hospital">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-department">Department</label>
                                        <input type="text" class="form-control" id="profileDepartment" placeholder="e.g., Internal Medicine">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-consultation-fee">Consultation Fee (EGP)</label>
                                        <input type="number" class="form-control" id="profileFee" min="0" placeholder="300">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-education-details">Education Details</label>
                                        <textarea class="form-control" id="profileEducation" rows="3" placeholder="List your medical degrees, universities, and graduation years"></textarea>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-certifications">Certifications</label>
                                        <input type="text" class="form-control" id="profileCertifications" placeholder="e.g., Board Certified Internal Medicine">
                                        <small class="text-muted">Separate multiple certifications with commas</small>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-memberships">Professional Memberships</label>
                                        <input type="text" class="form-control" id="profileMemberships" placeholder="e.g., Sudan Medical Association">
                                        <small class="text-muted">Separate multiple memberships with commas</small>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-languages">Languages Spoken</label>
                                        <input type="text" class="form-control" id="profileLanguages" placeholder="e.g., Arabic, English, French">
                                        <small class="text-muted">List all languages you can consult in</small>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold" id="label-consultation-areas">Consultation Areas</label>
                                        <input type="text" class="form-control" id="profileConsultationAreas" placeholder="e.g., General Medicine, Diabetes Management">
                                        <small class="text-muted">Your areas of expertise</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="row mt-4">
                            <div class="col-lg-6">
                                <div class="settings-group">
                                    <h6 class="settings-group-title">
                                        <i class="bi bi-telephone me-2"></i><span id="contact-info">Contact Information</span>
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Office Phone</label>
                                        <input type="tel" class="form-control" id="profileOfficePhone" placeholder="+249 xx xxx xxxx">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Emergency Contact</label>
                                        <input type="tel" class="form-control" id="profileEmergencyContact" placeholder="+249 xx xxx xxxx">
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Office Address</label>
                                        <textarea class="form-control" id="profileOfficeAddress" rows="2" placeholder="Enter your clinic or hospital address"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-6">
                                <div class="settings-group">
                                    <h6 class="settings-group-title">
                                        <i class="bi bi-file-earmark-medical me-2"></i><span id="documents-info">Documents & Verification</span>
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Medical License Document</label>
                                        <input type="file" class="form-control" id="profileLicenseDoc" accept=".pdf,.jpg,.jpeg,.png">
                                        <small class="text-muted">PDF, JPG, PNG (Max 5MB)</small>
                                        <div class="upload-status mt-1" id="license-upload-status"></div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Medical Degree Document</label>
                                        <input type="file" class="form-control" id="profileDegreeDoc" accept=".pdf,.jpg,.jpeg,.png">
                                        <small class="text-muted">PDF, JPG, PNG (Max 5MB)</small>
                                        <div class="upload-status mt-1" id="degree-upload-status"></div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">National ID/Passport</label>
                                        <input type="file" class="form-control" id="profileIdDoc" accept=".pdf,.jpg,.jpeg,.png">
                                        <small class="text-muted">PDF, JPG, PNG (Max 5MB)</small>
                                        <div class="upload-status mt-1" id="id-upload-status"></div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Other Documents (Optional)</label>
                                        <input type="file" class="form-control" id="profileOtherDocs" accept=".pdf,.jpg,.jpeg,.png" multiple>
                                        <small class="text-muted">Additional certifications or relevant documents</small>
                                        <div class="upload-status mt-1" id="other-upload-status"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="row mt-4">
                            <div class="col-lg-6">
                                <div class="settings-group">
                                    <h6 class="settings-group-title">
                                        <i class="bi bi-clock me-2"></i><span id="schedule-info">Schedule & Availability</span>
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Consultation Hours</label>
                                        <div class="form-control-plaintext" id="profileConsultationHours">
                                            <div>Sunday - Thursday: 9:00 AM - 5:00 PM</div>
                                            <div>Friday: 9:00 AM - 2:00 PM</div>
                                            <div>Saturday: Closed</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-6">
                                <div class="settings-group">
                                    <h6 class="settings-group-title">
                                        <i class="bi bi-graph-up me-2"></i><span id="stats-info">Statistics</span>
                                    </h6>
                                    
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="form-label fw-bold">Total Patients</label>
                                            <p class="form-control-plaintext" id="profileTotalPatients">1,250</p>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label fw-bold">Total Consultations</label>
                                            <p class="form-control-plaintext" id="profileTotalConsultations">3,890</p>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label fw-bold">Rating</label>
                                            <p class="form-control-plaintext" id="profileRating">4.8/5.0</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Account Information -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="settings-group">
                                    <h6 class="settings-group-title">
                                        <i class="bi bi-info-circle me-2"></i><span id="account-info">Account Information</span>
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Registration Date</label>
                                            <p class="form-control-plaintext" id="profileRegDate">15/06/2019</p>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Last Login</label>
                                            <p class="form-control-plaintext" id="profileLastLogin">Today at 9:15 AM</p>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Account Status</label>
                                            <p class="form-control-plaintext"><span class="badge bg-success">Active</span></p>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-bold">Verification Status</label>
                                            <p class="form-control-plaintext"><span class="badge bg-primary">Verified</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Profile Action Buttons -->
                        <div class="text-end mt-4">
                            <button class="btn btn-secondary me-2" onclick="loadUserProfile()">
                                <i class="bi bi-arrow-clockwise me-1"></i><span id="reset-profile">Reset Changes</span>
                            </button>
                            <button class="btn btn-primary" onclick="saveProfile()">
                                <i class="bi bi-check-lg me-1"></i><span id="save-profile">Save Profile</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Section (Hidden by default) -->
            <div id="settings-section" class="row mt-4" style="display: none;">
                <div class="col-12">
                    <div class="dashboard-card">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5><i class="bi bi-gear me-2"></i><span id="settings-title">Settings</span></h5>
                            <button class="btn btn-outline-secondary btn-sm" onclick="hideSettings()">
                                <i class="bi bi-x-lg me-1"></i><span id="close-settings">Close</span>
                            </button>
                        </div>

                        <div class="row g-4">
                            <!-- Account Settings -->
                            <div class="col-lg-6">
                                <div class="settings-group">
                                    <h6 class="settings-group-title">
                                        <i class="bi bi-person-gear me-2"></i><span id="account-settings">Profile Information</span>
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <label for="fullName" class="form-label" id="full-name-label">Full Name</label>
                                        <input type="text" class="form-control" id="fullName" placeholder="Enter your full name">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="email" class="form-label" id="email-label">Email Address</label>
                                        <input type="email" class="form-control" id="email" placeholder="Enter your email">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="phone" class="form-label" id="phone-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="phone" placeholder="Enter your phone number">
                                    </div>

                                    <div class="mb-3">
                                        <label for="medicalLicense" class="form-label" id="medical-license-label">Medical License Number</label>
                                        <input type="text" class="form-control" id="medicalLicense" placeholder="Enter your medical license number">
                                    </div>

                                    <div class="mb-3">
                                        <label for="specialization" class="form-label" id="specialization-label">Specialization</label>
                                        <select class="form-select" id="specialization">
                                            <option value="">Select Specialization</option>
                                            <option value="cardiology">Cardiology</option>
                                            <option value="neurology">Neurology</option>
                                            <option value="orthopedics">Orthopedics</option>
                                            <option value="pediatrics">Pediatrics</option>
                                            <option value="psychiatry">Psychiatry</option>
                                            <option value="surgery">Surgery</option>
                                            <option value="internal-medicine">Internal Medicine</option>
                                            <option value="dermatology">Dermatology</option>
                                            <option value="ophthalmology">Ophthalmology</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Preferences & Notifications -->
                            <div class="col-lg-6">
                                <div class="settings-group">
                                    <h6 class="settings-group-title">
                                        <i class="bi bi-bell me-2"></i><span id="preferences-settings">Preferences & Notifications</span>
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <label for="language" class="form-label" id="language-label">Language</label>
                                        <select class="form-select" id="language">
                                            <option value="en">English</option>
                                            <option value="ar">العربية</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                            <label class="form-check-label" for="emailNotifications" id="email-notifications-label">
                                                Email Notifications
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="smsNotifications" checked>
                                            <label class="form-check-label" for="smsNotifications" id="sms-notifications-label">
                                                SMS Notifications
                                            </label>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="appointmentReminders" checked>
                                            <label class="form-check-label" for="appointmentReminders" id="appointment-reminders-label">
                                                Appointment Reminders
                                            </label>
                                        </div>
                                    </div>

                                    <div class="settings-group mt-4">
                                        <h6 class="settings-group-title">
                                            <i class="bi bi-shield-lock me-2"></i><span id="security-settings">Security</span>
                                        </h6>
                                        
                                        <div class="mb-3">
                                            <button class="btn btn-outline-primary btn-sm me-2" onclick="changePassword()">
                                                <i class="bi bi-key me-1"></i><span id="change-password">Change Password</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Save Settings Button -->
                        <div class="text-end mt-4">
                            <button class="btn btn-secondary me-2" onclick="resetSettings()">
                                <i class="bi bi-arrow-clockwise me-1"></i><span id="reset-settings">Reset</span>
                            </button>
                            <button class="btn btn-primary" onclick="saveSettings()">
                                <i class="bi bi-check-lg me-1"></i><span id="save-settings">Save Settings</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

    <!-- Footer -->
    <footer class="footer mt-auto py-3">
        <div class="container">
            <div class="row g-3">
                <!-- Brand & Description -->
                <div class="col-lg-4 col-md-6">
                    <h5 class="mb-3">
                        <i class="bi bi-heart-pulse me-2 text-primary"></i>
                        <span id="footer-brand">Sahatak</span>
                    </h5>
                    <div class="d-flex gap-3 social-links">
                        <a href="https://facebook.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-facebook fs-5"></i></a>
                        <a href="https://twitter.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-twitter fs-5"></i></a>
                        <a href="https://instagram.com/sahatak" target="_blank" rel="noopener"><i class="bi bi-instagram fs-5"></i></a>
                        <a href="https://linkedin.com/company/sahatak" target="_blank" rel="noopener"><i class="bi bi-linkedin fs-5"></i></a>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="col-lg-2 col-md-6">
                    <h6 class="mb-3" id="footer-links-title">Quick Links</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../common/about.html" class="text-muted text-decoration-none" id="footer-about">About Platform</a>
                        </li>
                        <li class="mb-2">
                            <a href="../common/services.html" class="text-muted text-decoration-none" id="footer-services">Services</a>
                        </li>
                    </ul>
                </div>

                <!-- Support -->
                <div class="col-lg-3 col-md-6">
                    <h6 class="mb-3" id="footer-support-title">Support & Help</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="../common/support.html" class="text-muted text-decoration-none" id="footer-help">Help Center</a>
                        </li>
                        <li class="mb-2">
                            <a href="../common/contact-us.html" class="text-muted text-decoration-none" id="footer-contact">Contact Us</a>
                        </li>
                    </ul>
                </div>

                <!-- Emergency Contact -->
                <div class="col-lg-3 col-md-6 emergency-section">
                    <p class="mb-2 text-danger fw-bold" id="footer-emergency-text">
                        For medical emergencies
                    </p>
                    <p class="mb-3 text-danger fw-bold fs-6" id="footer-emergency-action">
                        <i class="bi bi-hospital me-2"></i>
                        Go to nearest ER hospital
                    </p>
                    <p class="mb-0 text-muted small" id="footer-emergency-note">
                        For non-urgent consultations use the platform
                    </p>
                </div>
            </div>

            <!-- Bottom Bar -->
            <hr class="my-3">
            <div class="row">
                <div class="col-12 text-center">
                    <p class="mb-0 fw-bold" id="footer-copyright">
                        © 2025 Sahatak. All rights reserved.
                    </p>
                    <p class="mb-0 text-muted small mt-1" id="footer-medical-disclaimer">
                        This platform does not replace visiting a doctor in emergency cases
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5 JavaScript CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    
    <!-- Authentication Guard (must load first) -->
    <script src="../../assets/js/components/auth-guard.js"></script>
    <script src="../../assets/js/components/session-manager.js"></script>
    
    <!-- Main JavaScript -->
    <script src="../../assets/js/main.js"></script>
    
    <!-- Dashboard Translations -->
    <script src="../../assets/js/components/dashboard-translations.js"></script>
    
    <!-- Dashboard JavaScript -->
    <script src="../../assets/js/components/dashboard.js"></script>
    
    <!-- Video Consultation Dashboard JavaScript -->
    <script src="../../assets/js/components/video-consultation-dashboard.js"></script>
    
    <!-- Doctor Dashboard JavaScript -->
    <script>
        // Translation helper functions for activities
        function getActivityMessage(activityType, patientName) {
            const currentLang = LanguageManager?.getLanguage() || 'en';
            const t = LanguageManager?.translations?.[currentLang];
            
            if (t?.dashboard?.doctor?.activities?.[activityType]) {
                return t.dashboard.doctor.activities[activityType].replace('{patient_name}', patientName);
            }
            
            // Fallback to English
            const fallbacks = {
                'appointment_scheduled': `New appointment scheduled with ${patientName}`,
                'appointment_completed': `Consultation completed with ${patientName}`,
                'video_session_ended': `Video call ended with ${patientName}`
            };
            return fallbacks[activityType] || `Activity with ${patientName}`;
        }
        
        function getTimeMessage(timeType, count = null) {
            const currentLang = LanguageManager?.getLanguage() || 'en';
            const t = LanguageManager?.translations?.[currentLang];
            
            if (t?.dashboard?.doctor?.activities?.time?.[timeType]) {
                let message = t.dashboard.doctor.activities.time[timeType];
                if (count !== null) {
                    message = message.replace('{count}', count);
                }
                return message;
            }
            
            // Fallback to English
            const fallbacks = {
                'just_now': 'Just now',
                'minutes_ago': `${count} minutes ago`,
                'hours_ago': `${count} hours ago`,
                'days_ago': `${count} days ago`
            };
            return fallbacks[timeType] || '';
        }
        
        // Doctor dashboard specific functions
        function openCommunicationHub() {
            console.log('Communication Hub clicked');
            window.location.href = '../medical/doctor/comm-hub.html';
        }
        
        function reviewRecords() {
            console.log('Review records clicked');
            window.location.href = '../medical/doctor/ehr.html';
        }
        
        function manageAvailability() {
            console.log('Manage availability clicked');
            window.location.href = '../medical/doctor/setAvailability.html';
        }
        
        function showProfile() {
            console.log('Show profile clicked');
            const profileSection = document.getElementById('profile-section');
            const settingsSection = document.getElementById('settings-section');
            
            // Hide settings if open
            settingsSection.style.display = 'none';
            
            // Toggle profile
            profileSection.style.display = profileSection.style.display === 'none' ? 'block' : 'none';
            
            // Smooth scroll to profile section
            if (profileSection.style.display === 'block') {
                profileSection.scrollIntoView({ behavior: 'smooth' });
                loadUserProfile();
                
                // Update translations for profile section
                const currentLang = LanguageManager.getLanguage() || 'ar';
                const translations = LanguageManager.translations[currentLang];
                if (translations && translations.dashboard && translations.dashboard.doctor && translations.dashboard.doctor.profile) {
                    DashboardTranslations.updateProfileAndSettings(translations.dashboard.doctor.profile, null);
                }
            }
        }

        function hideProfile() {
            document.getElementById('profile-section').style.display = 'none';
        }

        function updateVerificationStatus(user) {
            console.log('updateVerificationStatus called with user:', user);
            console.log('user.is_verified:', user.is_verified);
            console.log('user.verification_status:', user.verification_status);
            
            const statusElement = document.getElementById('verification-status');
            const isVerified = user.is_verified === true || user.verification_status === 'verified';
            
            console.log('Calculated isVerified:', isVerified);
            
            if (isVerified) {
                statusElement.textContent = 'Verified';
                statusElement.className = 'badge bg-success';
                console.log('Setting status to Verified');
                // Enable all dashboard functionality
                enableDashboardActions();
            } else {
                statusElement.textContent = 'Unverified';
                statusElement.className = 'badge bg-warning text-dark';
                console.log('Setting status to Unverified');
                // Disable dashboard functionality and show notice
                disableDashboardActions();
            }
        }

        function enableDashboardActions() {
            // Hide verification notice
            document.getElementById('verification-notice').style.display = 'none';
            
            // Enable all action cards
            const actionCards = [
                'communication-card', 'records-card', 'availability-card',
                'schedule-card', 'stats-card', 'waiting-card', 'activity-card'
            ];
            
            actionCards.forEach(cardId => {
                const card = document.getElementById(cardId);
                if (card) {
                    card.classList.remove('unverified-disabled');
                }
            });
        }

        function disableDashboardActions() {
            // Show verification notice
            document.getElementById('verification-notice').style.display = 'block';
            
            // Disable all action cards
            const actionCards = [
                'communication-card', 'records-card', 'availability-card',
                'schedule-card', 'stats-card', 'waiting-card', 'activity-card'
            ];
            
            actionCards.forEach(cardId => {
                const card = document.getElementById(cardId);
                if (card) {
                    card.classList.add('unverified-disabled');
                }
            });
        }

        function handleVerifiedAction(actionFunction) {
            // Get user data from localStorage which contains verification status
            const user = JSON.parse(localStorage.getItem('sahatak_doctor_data') || '{}');
            console.log('handleVerifiedAction - user from localStorage:', user);
            console.log('handleVerifiedAction - user.is_verified:', user.is_verified);
            const isVerified = user && (user.is_verified === true || user.verification_status === 'verified');
            console.log('handleVerifiedAction - isVerified:', isVerified);
            
            if (!isVerified) {
                // Show verification required message
                console.log('handleVerifiedAction - showing verification required modal');
                showVerificationRequiredModal();
                return;
            }
            
            // Execute the action if verified
            console.log('handleVerifiedAction - executing action:', actionFunction);
            if (typeof window[actionFunction] === 'function') {
                window[actionFunction]();
            } else {
                console.warn(`Function ${actionFunction} not found`);
            }
        }

        function showVerificationRequiredModal() {
            // Use translation system for verification required message
            const currentLang = LanguageManager.getLanguage() || 'ar';
            const message = LanguageManager.getTranslation(currentLang, 'dashboard.doctor.verification_notice.verification_required_action') ||
                'Your account must be verified first to access this feature. Please complete your profile and wait for admin approval.';
            
            alert(message);
        }

        function loadUserProfile() {
            // Load user profile from localStorage or API
            const user = JSON.parse(localStorage.getItem('sahatak_doctor_data') || '{}');
            
            // Update verification status in header
            updateVerificationStatus(user);
            
            // Personal Information (display-only fields)
            document.getElementById('profileFullName').textContent = user.full_name || 'Dr. Sarah Ahmed';
            document.getElementById('profileEmail').textContent = user.email || 'sarah.ahmed@sahatak.com';
            document.getElementById('profilePhone').textContent = user.phone || '+20 123 456 7890';
            document.getElementById('profileMedicalLicense').textContent = user.medical_license || 'ML-2019-12345';
            document.getElementById('profileSpecialization').textContent = user.specialization || 'Internal Medicine';
            document.getElementById('doctorId').textContent = user.doctor_id || 'DOC-2024-001';
            
            // Editable Professional Information
            document.getElementById('profileExperience').value = user.experience || '';
            document.getElementById('profileHospitals').value = user.hospital_affiliations || '';
            document.getElementById('profileDepartment').value = user.department || '';
            document.getElementById('profileFee').value = user.consultation_fee || '';
            document.getElementById('profileEducation').value = user.education_details || '';
            document.getElementById('profileCertifications').value = user.certifications || '';
            document.getElementById('profileMemberships').value = user.memberships || '';
            document.getElementById('profileLanguages').value = user.languages || '';
            document.getElementById('profileConsultationAreas').value = user.consultation_areas || '';
            
            // Contact Information
            document.getElementById('profileOfficePhone').value = user.office_phone || '';
            document.getElementById('profileEmergencyContact').value = user.emergency_contact || '';
            document.getElementById('profileOfficeAddress').value = user.office_address || '';
            
            // Schedule
            const scheduleDiv = document.getElementById('profileConsultationHours');
            if (user.consultation_hours) {
                scheduleDiv.innerHTML = user.consultation_hours;
            }
            
            // Statistics
            document.getElementById('profileTotalPatients').textContent = user.total_patients || '1,250';
            document.getElementById('profileTotalConsultations').textContent = user.total_consultations || '3,890';
            document.getElementById('profileRating').textContent = (user.rating || '4.8') + '/5.0';
            
            // Account Information
            document.getElementById('profileRegDate').textContent = user.registration_date || '15/06/2019';
            document.getElementById('profileLastLogin').textContent = user.last_login || 'Today at 9:15 AM';
        }

        function saveProfile() {
            // Get current data from database
            const currentUser = JSON.parse(localStorage.getItem('sahatak_doctor_data') || '{}');
            
            // Collect all profile data from form fields
            const updatedUser = {
                ...currentUser,
                // Professional Information
                experience: document.getElementById('profileExperience').value,
                hospital_affiliations: document.getElementById('profileHospitals').value,
                department: document.getElementById('profileDepartment').value,
                consultation_fee: document.getElementById('profileFee').value,
                education_details: document.getElementById('profileEducation').value,
                certifications: document.getElementById('profileCertifications').value,
                memberships: document.getElementById('profileMemberships').value,
                languages: document.getElementById('profileLanguages').value,
                consultation_areas: document.getElementById('profileConsultationAreas').value,
                // Contact Information
                office_phone: document.getElementById('profileOfficePhone').value,
                emergency_contact: document.getElementById('profileEmergencyContact').value,
                office_address: document.getElementById('profileOfficeAddress').value
            };
            
            // Save to database (localStorage)
            localStorage.setItem('sahatak_doctor_data', JSON.stringify(updatedUser));
            
            // Show success message
            alert('Profile updated successfully!');
            
            // Update verification status if profile is more complete
            updateVerificationStatus(updatedUser);
            
            console.log('Profile saved:', updatedUser);
        }

        function editProfile() {
            // This function is no longer needed since profile is directly editable
            // Just show a message that profile can be edited directly
            alert('You can now edit your profile information directly in the form above. Click "Save Profile" when done.');
        }

        function showSettings() {
            console.log('Show settings clicked');
            const settingsSection = document.getElementById('settings-section');
            const profileSection = document.getElementById('profile-section');
            
            // Hide profile if open
            profileSection.style.display = 'none';
            
            // Toggle settings
            settingsSection.style.display = settingsSection.style.display === 'none' ? 'block' : 'none';
            
            // Smooth scroll to settings section
            if (settingsSection.style.display === 'block') {
                settingsSection.scrollIntoView({ behavior: 'smooth' });
                loadUserSettings();
                
                // Update translations for settings section
                const currentLang = LanguageManager.getLanguage() || 'ar';
                const translations = LanguageManager.translations[currentLang];
                if (translations && translations.dashboard && translations.dashboard.doctor && translations.dashboard.doctor.settings) {
                    DashboardTranslations.updateProfileAndSettings(null, translations.dashboard.doctor.settings);
                }
            }
        }

        function hideSettings() {
            document.getElementById('settings-section').style.display = 'none';
        }

        function loadUserSettings() {
            // Load user settings from localStorage (simulating database)
            const user = JSON.parse(localStorage.getItem('sahatak_doctor_data') || '{}');
            
            // If no data exists, set default doctor values (simulating initial database load)
            if (!user.full_name) {
                user.full_name = 'Dr. Sarah Ahmed';
                user.email = 'sarah.ahmed@sahatak.com';
                user.phone = '+20 123 456 7890';
                user.medical_license = 'ML-2019-12345';
                user.specialization = 'internal-medicine';
                localStorage.setItem('sahatak_doctor_data', JSON.stringify(user));
            }
            
            // Populate form fields with current values from database
            document.getElementById('fullName').value = user.full_name || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('medicalLicense').value = user.medical_license || '';
            document.getElementById('specialization').value = user.specialization || '';
            
            // Load preferences from database
            const preferences = JSON.parse(localStorage.getItem('sahatak_doctor_preferences') || '{}');
            document.getElementById('language').value = preferences.language || 'en';
            document.getElementById('emailNotifications').checked = preferences.email_notifications !== false;
            document.getElementById('smsNotifications').checked = preferences.sms_notifications !== false;
            document.getElementById('appointmentReminders').checked = preferences.appointment_reminders !== false;
        }

        function saveSettings() {
            // Get current data from database
            const currentUser = JSON.parse(localStorage.getItem('sahatak_doctor_data') || '{}');
            const currentPrefs = JSON.parse(localStorage.getItem('sahatak_doctor_preferences') || '{}');
            
            // Collect only changed fields
            const updatedUser = {
                ...currentUser,
                full_name: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                medical_license: document.getElementById('medicalLicense').value,
                specialization: document.getElementById('specialization').value
            };
            
            // Update preferences
            const updatedPrefs = {
                language: document.getElementById('language').value,
                email_notifications: document.getElementById('emailNotifications').checked,
                sms_notifications: document.getElementById('smsNotifications').checked,
                appointment_reminders: document.getElementById('appointmentReminders').checked
            };
            
            // Save to database (localStorage)
            localStorage.setItem('sahatak_doctor_data', JSON.stringify(updatedUser));
            localStorage.setItem('sahatak_doctor_preferences', JSON.stringify(updatedPrefs));
            
            // Update displayed name in header if changed
            if (updatedUser.full_name && updatedUser.full_name !== currentUser.full_name) {
                document.getElementById('user-name').textContent = updatedUser.full_name;
            }
            
            // Show success message with which fields were updated
            const changedFields = [];
            if (currentUser.full_name !== updatedUser.full_name) changedFields.push('Name');
            if (currentUser.email !== updatedUser.email) changedFields.push('Email');
            if (currentUser.phone !== updatedUser.phone) changedFields.push('Phone');
            if (currentUser.medical_license !== updatedUser.medical_license) changedFields.push('Medical License');
            if (currentUser.specialization !== updatedUser.specialization) changedFields.push('Specialization');
            
            if (changedFields.length > 0) {
                alert(`Settings saved successfully!\nUpdated: ${changedFields.join(', ')}`);
            } else {
                alert('Settings saved successfully!');
            }
            
            console.log('Settings saved:', updatedUser, updatedPrefs);
            
            // Refresh profile section if it's open
            if (document.getElementById('profile-section').style.display !== 'none') {
                loadUserProfile();
            }
        }

        function resetSettings() {
            if (confirm('Are you sure you want to reload settings from database?')) {
                // Reload original values from database
                loadUserSettings();
                alert('Settings reloaded from database.');
            }
        }
        
        function changePassword() {
            alert('Password change functionality will redirect to secure password update page.');
        }
        
        function enableTwoFactor() {
            alert('Two-factor authentication setup will be implemented.');
        }
        
        function viewFullSchedule() {
            console.log('View full schedule clicked');
            window.location.href = '../medical/doctor/setAvailability.html';
        }
        
        function viewAllActivity() {
            console.log('View all activity clicked');
            // Implement view all activity
        }
        
        function viewAllMessages() {
            console.log('View all messages clicked');
            window.location.href = '../medical/doctor/comm-hub.html';
        }
        
        function toggleAvailability() {
            console.log('Toggle availability clicked');
            // Implement availability toggle
            const statusBtn = document.getElementById('availability-status');
            const icon = statusBtn.previousElementSibling;
            
            if (statusBtn.textContent === 'Available') {
                statusBtn.textContent = 'Unavailable';
                icon.className = 'bi bi-circle-fill text-danger me-1';
            } else {
                statusBtn.textContent = 'Available';
                icon.className = 'bi bi-circle-fill text-success me-1';
            }
        }
        
        function showLanguageSelector() {
            console.log('🌐 Language selector clicked');
            // Toggle between Arabic and English
            const currentLang = LanguageManager.getLanguage() || 'ar';
            const newLang = currentLang === 'ar' ? 'en' : 'ar';
            console.log('🔄 Switching from', currentLang, 'to', newLang);
            
            // Change language
            LanguageManager.setLanguage(newLang);
            LanguageManager.applyLanguage(newLang);
            
            // Update dashboard translations (call after applyLanguage to ensure footer is properly updated)
            if (DashboardTranslations && DashboardTranslations.updateDoctorDashboard) {
                console.log('📊 Calling updateDoctorDashboard with:', newLang);
                DashboardTranslations.updateDoctorDashboard(newLang);
            } else {
                console.log('❌ DashboardTranslations not available');
            }
            
            // Update the language button text
            const langBtn = document.getElementById('current-lang');
            langBtn.textContent = newLang === 'ar' ? 'العربية' : 'English';
        }
        
        // logout function is now defined globally in main.js
        
        // File upload handler for profile documents
        function handleProfileFileUpload(event, statusId) {
            const file = event.target.files[0];
            const statusElement = document.getElementById(statusId);
            
            if (!file) {
                statusElement.innerHTML = '';
                return;
            }
            
            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                statusElement.innerHTML = '<small class="text-danger"><i class="bi bi-x-circle me-1"></i>File size must be less than 5MB</small>';
                event.target.value = '';
                return;
            }
            
            // Show success message
            statusElement.innerHTML = `<small class="text-success"><i class="bi bi-check-circle me-1"></i>${file.name} selected</small>`;
        }

        // Automatic video status monitoring for doctors
        let videoStatusMonitorInterval = null;
        
        function startVideoStatusMonitoring() {
            console.log('🎥 Starting video status monitoring for doctor...');
            
            // Clear any existing interval
            if (videoStatusMonitorInterval) {
                clearInterval(videoStatusMonitorInterval);
            }
            
            // Check every 8 seconds for video appointment status updates (slightly faster for doctor)
            videoStatusMonitorInterval = setInterval(async () => {
                try {
                    // Find any video appointments that might need status updates
                    const videoCards = document.querySelectorAll('.appointment-card[data-appointment-id]');
                    
                    for (const card of videoCards) {
                        const appointmentId = card.dataset.appointmentId;
                        const appointmentStatus = card.dataset.appointmentStatus;
                        
                        // Only check scheduled, confirmed, or in_progress video appointments
                        if (appointmentId && ['scheduled', 'confirmed', 'in_progress'].includes(appointmentStatus)) {
                            console.log(`🔄 Monitoring video appointment ${appointmentId} (status: ${appointmentStatus})`);
                            
                            if (typeof VideoConsultationDashboard !== 'undefined' && VideoConsultationDashboard.checkVideoSessionStatus) {
                                await VideoConsultationDashboard.checkVideoSessionStatus(appointmentId, true);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error in video status monitoring:', error);
                }
            }, 8000); // Check every 8 seconds
            
            console.log('✅ Video status monitoring started - checking every 8 seconds');
        }
        
        function stopVideoStatusMonitoring() {
            if (videoStatusMonitorInterval) {
                clearInterval(videoStatusMonitorInterval);
                videoStatusMonitorInterval = null;
                console.log('🛑 Video status monitoring stopped');
            }
        }

        // Pagination state
        let allAppointments = [];
        let allActivities = [];
        let currentAppointmentsPage = 1;
        let currentActivityPage = 1;
        const appointmentsPerPage = 3;
        const activitiesPerPage = 6;
        
        // Pagination utility function
        function createPaginationNumbers(totalPages, currentPage, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            // Show page numbers (max 5 visible)
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);
            
            // Adjust start if we're at the end
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline-secondary'}`;
                btn.textContent = i;
                btn.onclick = () => {
                    if (containerId === 'appointments-page-numbers') {
                        currentAppointmentsPage = i;
                        updateAppointmentsPagination();
                    } else {
                        currentActivityPage = i;
                        updateActivityPagination();
                    }
                };
                container.appendChild(btn);
            }
        }
        
        // Appointments pagination functions
        function changeAppointmentsPage(direction) {
            const totalPages = Math.ceil(allAppointments.length / appointmentsPerPage);
            
            if (direction === 'prev' && currentAppointmentsPage > 1) {
                currentAppointmentsPage--;
            } else if (direction === 'next' && currentAppointmentsPage < totalPages) {
                currentAppointmentsPage++;
            }
            
            updateAppointmentsPagination();
        }
        
        function updateAppointmentsPagination() {
            const totalPages = Math.ceil(allAppointments.length / appointmentsPerPage);
            const startIndex = (currentAppointmentsPage - 1) * appointmentsPerPage;
            const endIndex = startIndex + appointmentsPerPage;
            const currentPageAppointments = allAppointments.slice(startIndex, endIndex);
            
            // Update page info
            document.getElementById('appointments-page-info').textContent = 
                totalPages > 1 ? `Page ${currentAppointmentsPage} of ${totalPages}` : `${allAppointments.length} items`;
            
            // Update pagination controls visibility
            const paginationDiv = document.getElementById('appointments-pagination');
            if (totalPages > 1) {
                paginationDiv.style.display = 'flex';
                paginationDiv.style.setProperty('display', 'flex', 'important');
            } else {
                paginationDiv.style.display = 'none';
                paginationDiv.style.setProperty('display', 'none', 'important');
            }
            
            // Update buttons
            document.getElementById('appointments-prev-btn').disabled = currentAppointmentsPage <= 1;
            document.getElementById('appointments-next-btn').disabled = currentAppointmentsPage >= totalPages;
            
            // Create page numbers
            createPaginationNumbers(totalPages, currentAppointmentsPage, 'appointments-page-numbers');
            
            // Display appointments for current page
            displayAppointmentsPage(currentPageAppointments);
        }
        
        // Activity pagination functions  
        function changeActivityPage(direction) {
            const totalPages = Math.ceil(allActivities.length / activitiesPerPage);
            
            if (direction === 'prev' && currentActivityPage > 1) {
                currentActivityPage--;
            } else if (direction === 'next' && currentActivityPage < totalPages) {
                currentActivityPage++;
            }
            
            updateActivityPagination();
        }
        
        function updateActivityPagination() {
            const totalPages = Math.ceil(allActivities.length / activitiesPerPage);
            const startIndex = (currentActivityPage - 1) * activitiesPerPage;
            const endIndex = startIndex + activitiesPerPage;
            const currentPageActivities = allActivities.slice(startIndex, endIndex);
            
            // Update page info
            document.getElementById('activity-page-info').textContent = 
                totalPages > 1 ? `Page ${currentActivityPage} of ${totalPages}` : `${allActivities.length} items`;
            
            // Update pagination controls visibility
            const paginationDiv = document.getElementById('activity-pagination');
            if (totalPages > 1) {
                paginationDiv.style.display = 'flex';
                paginationDiv.style.setProperty('display', 'flex', 'important');
            } else {
                paginationDiv.style.display = 'none';
                paginationDiv.style.setProperty('display', 'none', 'important');
            }
            
            // Update buttons
            document.getElementById('activity-prev-btn').disabled = currentActivityPage <= 1;
            document.getElementById('activity-next-btn').disabled = currentActivityPage >= totalPages;
            
            // Create page numbers
            createPaginationNumbers(totalPages, currentActivityPage, 'activity-page-numbers');
            
            // Display activities for current page
            displayActivitiesPage(currentPageActivities);
        }
        
        function displayAppointmentsPage(appointments) {
            const appointmentsContainer = document.getElementById('appointments-container');
            if (!appointmentsContainer) return;
            
            if (appointments.length > 0) {
                const currentLang = LanguageManager.getLanguage() || 'en';
                const hasUpcoming = appointments.some(apt => ['scheduled', 'confirmed', 'in_progress'].includes(apt.status));
                const sectionTitle = hasUpcoming ? 
                    (currentLang === 'ar' ? 'المواعيد القادمة والحديثة' : 'Upcoming & Recent Appointments') :
                    (currentLang === 'ar' ? 'المواعيد الحديثة' : 'Recent Appointments');
                
                appointmentsContainer.innerHTML = `
                    <div class="appointments-content">
                        ${appointments.map(apt => {
                            const appointmentDate = new Date(apt.appointment_date);
                            const dateStr = appointmentDate.toLocaleDateString('en-US', { 
                                weekday: 'short', 
                                month: 'short', 
                                day: 'numeric' 
                            });
                            const timeStr = appointmentDate.toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit',
                                hour12: true 
                            });
                            
                            // Generate video consultation button if applicable
                            const videoButton = (typeof VideoConsultationDashboard !== 'undefined' && VideoConsultationDashboard.generateVideoConsultationButton) 
                                ? VideoConsultationDashboard.generateVideoConsultationButton(apt) 
                                : (apt.appointment_type === 'video' ? `<button class="btn btn-primary btn-sm" disabled>Loading...</button>` : '');
                            const isVideoAppointment = apt.appointment_type === 'video';
                            
                            // Determine badge color based on status
                            const getBadgeClass = (status) => {
                                switch(status) {
                                    case 'scheduled': return 'bg-primary';
                                    case 'confirmed': return 'bg-success';
                                    case 'in_progress': return 'bg-warning text-dark';
                                    case 'completed': return 'bg-secondary';
                                    case 'cancelled': return 'bg-danger';
                                    default: return 'bg-primary';
                                }
                            };
                            
                            return `
                                <div class="appointment-item appointment-card ${isVideoAppointment ? 'video-appointment' : ''} d-flex justify-content-between align-items-center p-3 mb-2 bg-light rounded" data-appointment-id="${apt.id}" data-appointment-status="${apt.status}">
                                    <div class="flex-grow-1">
                                        <div style="color: black;"><strong>${apt.patient_name || 'Unknown Patient'}</strong></div>
                                        ${apt.patient_age ? `<span class="text-muted ms-2">Age ${apt.patient_age}</span>` : ''}
                                        <div class="text-muted small">
                                            <i class="bi bi-${apt.appointment_type === 'video' ? 'camera-video' : apt.appointment_type === 'audio' ? 'telephone' : 'chat-dots'} me-1"></i>${apt.appointment_type}
                                        </div>
                                        ${apt.reason_for_visit ? `<div class="text-muted small">${apt.reason_for_visit}</div>` : ''}
                                        <div class="small" style="color: darkgreen;">
                                            <i class="bi bi-calendar me-1"></i>${dateStr} ${timeStr}
                                        </div>
                                        ${videoButton ? `
                                            <div class="video-consultation-actions mt-2">
                                                ${videoButton}
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="d-flex flex-column align-items-end gap-2">
                                        <span class="badge ${getBadgeClass(apt.status)}">${apt.status}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                const currentLang = LanguageManager.getLanguage() || 'en';
                appointmentsContainer.innerHTML = `
                    <p class="text-muted text-center py-3">${currentLang === 'ar' ? 'لا توجد مواعيد حديثة' : 'No recent appointments'}</p>
                `;
            }
        }
        
        function displayActivitiesPage(activities) {
            const activityContainer = document.getElementById('recent-activity-container');
            if (!activityContainer) return;
            
            if (activities.length > 0) {
                activityContainer.innerHTML = activities.map(activity => {
                    const timeAgo = getTimeAgo(activity.date);
                    const formattedDate = activity.date.toLocaleString(undefined, {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    return `
                        <div class="activity-item d-flex align-items-start p-2 mb-2 bg-light rounded">
                            <i class="bi ${activity.icon} text-primary me-3 mt-1"></i>
                            <div class="flex-grow-1">
                                <div style="color: black;">${activity.message}</div>
                                <small class="text-muted" title="${formattedDate}">${timeAgo}</small>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                activityContainer.innerHTML = '<p class="text-muted text-center py-3">No recent activity</p>';
            }
        }

        // Load dashboard statistics from API
        async function loadDoctorDashboardStats() {
            console.log('Loading doctor dashboard statistics...');
            
            try {
                // Load appointments to count scheduled ones
                const appointmentsResponse = await ApiHelper.makeRequest('/appointments/');
                
                if (appointmentsResponse.success) {
                    const appointments = appointmentsResponse.data.appointments;
                    
                    // Ensure appointments is an array
                    if (!Array.isArray(appointments)) {
                        console.error('Got non-array appointment data:', appointments);
                        console.error('Full response:', appointmentsResponse);
                        // Ensure title remains correct even with API errors
                        document.title = 'Doctor Dashboard - Sahatak';
                        return;
                    }
                    
                    // Count scheduled/confirmed appointments (upcoming)
                    const scheduledCount = appointments.filter(apt => 
                        ['scheduled', 'confirmed'].includes(apt.status) && 
                        new Date(apt.appointment_date) > new Date()
                    ).length;
                    
                    // Count total patients (unique patient IDs from appointments)
                    const uniquePatientIds = [...new Set(appointments.map(apt => apt.patient_id))];
                    const totalPatients = uniquePatientIds.length;
                    
                    // Debug: Get current doctor info
                    const currentUser = AuthGuard.getCurrentUser();
                    
                    // Get doctor profile ID from localStorage doctor data
                    const doctorData = JSON.parse(localStorage.getItem('sahatak_doctor_data') || '{}');
                    const currentDoctorId = doctorData.id || currentUser?.doctor_id || currentUser?.profile?.id;
                    
                    console.log(`👨‍⚕️ Current user ID: ${currentUser?.id}, Doctor profile ID: ${currentDoctorId}`);
                    
                    // Debug: log ALL appointment statuses first
                    console.log('📊 All appointment statuses breakdown:');
                    const statusCounts = {};
                    const doctorAppointments = [];
                    appointments.forEach(apt => {
                        const status = apt.status ? apt.status.toLowerCase() : 'no_status';
                        statusCounts[status] = (statusCounts[status] || 0) + 1;
                        console.log(`📄 Appointment ${apt.id}: status="${apt.status}" (${status}), patient=${apt.patient_name}, doctor_id=${apt.doctor_id}`);
                        
                        // Check if this appointment belongs to current doctor
                        if (apt.doctor_id == currentDoctorId) {
                            doctorAppointments.push(apt);
                        }
                    });
                    console.log('📊 All Status counts:', statusCounts);
                    console.log(`🩺 Doctor's appointments: ${doctorAppointments.length} out of ${appointments.length} total`);
                    
                    // Show doctor's appointment statuses
                    const doctorStatusCounts = {};
                    doctorAppointments.forEach(apt => {
                        const status = apt.status ? apt.status.toLowerCase() : 'no_status';
                        doctorStatusCounts[status] = (doctorStatusCounts[status] || 0) + 1;
                    });
                    console.log(`📊 Doctor's Status counts:`, doctorStatusCounts);
                    
                    // Count completed appointments for consultation count (case-insensitive)
                    const completedAppointments = appointments.filter(apt => 
                        apt.status && apt.status.toLowerCase() === 'completed'
                    );
                    const completedCount = completedAppointments.length;
                    
                    // Debug: Show completed appointments details
                    console.log(`🎯 Completed appointments found: ${completedCount}`);
                    if (completedCount > 0) {
                        console.log('📋 Completed appointments:', completedAppointments.map(apt => ({
                            id: apt.id,
                            patient: apt.patient_name,
                            date: apt.appointment_date,
                            status: apt.status
                        })));
                    } else {
                        console.log('❌ No completed appointments found. Looking for status variants...');
                        const possibleCompleted = appointments.filter(apt => 
                            apt.status && (
                                apt.status.toLowerCase().includes('complete') ||
                                apt.status.toLowerCase().includes('done') ||
                                apt.status.toLowerCase().includes('finished')
                            )
                        );
                        if (possibleCompleted.length > 0) {
                            console.log('🔍 Found possible completed appointments with different status:', possibleCompleted);
                        }
                    }
                    
                    // Get recent appointments for display (include all recent appointments within 7 days)
                    const now = new Date();
                    const sevenDaysAgo = new Date(now.getTime() - 7*24*60*60*1000);
                    
                    // First get upcoming appointments (scheduled/confirmed/in_progress)
                    const upcomingAppointments = appointments.filter(apt => 
                        ['scheduled', 'confirmed', 'in_progress'].includes(apt.status) && 
                        new Date(apt.appointment_date) > now
                    ).sort((a, b) => new Date(a.appointment_date) - new Date(b.appointment_date));
                    
                    // Then get recent appointments (any status within last 7 days)
                    const recentAppointments = appointments.filter(apt => 
                        new Date(apt.appointment_date) >= sevenDaysAgo
                    ).sort((a, b) => new Date(b.appointment_date) - new Date(a.appointment_date)); // Most recent first
                    
                    // Combine: prioritize upcoming, then fill with recent
                    const displayAppointments = [...upcomingAppointments];
                    recentAppointments.forEach(apt => {
                        if (displayAppointments.length < 5 && !displayAppointments.find(existing => existing.id === apt.id)) {
                            displayAppointments.push(apt);
                        }
                    });
                    
                    // Update appointments list with pagination
                    allAppointments = displayAppointments; // Store all appointments for pagination
                    currentAppointmentsPage = 1; // Reset to first page
                    updateAppointmentsPagination(); // Use pagination system
                    
                    // Update Recent Activity
                    const activityContainer = document.getElementById('recent-activity-container');
                    if (activityContainer) {
                        // Create activity entries from recent appointments
                        const recentActivities = [];
                        
                        // Add ALL recently scheduled appointments (not just 2)
                        const recentScheduled = appointments.filter(apt => 
                            apt.status === 'scheduled' && 
                            new Date() - new Date(apt.created_at || apt.appointment_date) < 7 * 24 * 60 * 60 * 1000 // Last 7 days
                        );
                        
                        recentScheduled.forEach(apt => {
                            const createdDate = new Date(apt.created_at || apt.appointment_date);
                            recentActivities.push({
                                id: `scheduled_${apt.id}_${createdDate.getTime()}`, // Unique ID for each activity
                                type: 'appointment_scheduled',
                                message: getActivityMessage('appointment_scheduled', apt.patient_name || 'Patient'),
                                date: createdDate,
                                icon: 'bi-calendar-plus',
                                appointmentId: apt.id
                            });
                        });
                        
                        // Add recently completed appointments (only if they were properly completed, not just video ended)
                        const recentCompleted = appointments.filter(apt => {
                            const isCompleted = apt.status === 'completed';
                            const isRecent = new Date() - new Date(apt.updated_at || apt.appointment_date) < 7 * 24 * 60 * 60 * 1000; // Last 7 days
                            // Only show as "completed" if it's actually marked as completed AND has a completion_reason or was completed through proper flow
                            const isProperlyCompleted = isCompleted && (
                                apt.completion_reason || // Has completion reason
                                apt.completion_method === 'manual' || // Was manually completed
                                (apt.session_status !== 'ended' && apt.session_status !== 'disconnected') // Not just a video disconnect
                            );
                            return isProperlyCompleted && isRecent;
                        });
                        
                        recentCompleted.forEach(apt => {
                            const completedDate = new Date(apt.updated_at || apt.appointment_date);
                            recentActivities.push({
                                id: `completed_${apt.id}_${completedDate.getTime()}`,
                                type: 'appointment_completed',
                                message: getActivityMessage('appointment_completed', apt.patient_name || 'Patient'),
                                date: completedDate,
                                icon: 'bi-check-circle',
                                appointmentId: apt.id
                            });
                        });
                        
                        // Add video session activities for sessions that ended but appointment is still active
                        const recentVideoSessions = appointments.filter(apt => {
                            const isActive = apt.status === 'in_progress' || apt.status === 'scheduled';
                            const sessionEnded = apt.session_status === 'ended' || apt.session_status === 'disconnected';
                            const isRecent = apt.session_updated_at && new Date() - new Date(apt.session_updated_at) < 2 * 60 * 60 * 1000; // Last 2 hours
                            return isActive && sessionEnded && isRecent;
                        });
                        
                        recentVideoSessions.forEach(apt => {
                            const sessionDate = new Date(apt.session_updated_at);
                            recentActivities.push({
                                id: `video_${apt.id}_${sessionDate.getTime()}`,
                                type: 'video_session_ended',
                                message: getActivityMessage('video_session_ended', apt.patient_name || 'Patient'),
                                date: sessionDate,
                                icon: 'bi-camera-video-off',
                                appointmentId: apt.id
                            });
                        });
                        
                        // Sort by date (most recent first)
                        recentActivities.sort((a, b) => b.date - a.date);
                        
                        // Remove duplicate activities (same appointment ID and type)
                        const uniqueActivities = [];
                        const seen = new Set();
                        recentActivities.forEach(activity => {
                            const key = `${activity.appointmentId}_${activity.type}`;
                            if (!seen.has(key)) {
                                seen.add(key);
                                uniqueActivities.push(activity);
                            }
                        });
                        
                        // Use pagination for activities
                        allActivities = uniqueActivities; // Store all activities for pagination
                        currentActivityPage = 1; // Reset to first page
                        updateActivityPagination(); // Use pagination system
                    }
                    
                    // Update statistics in the doctor-stats-container
                    const statsContainer = document.getElementById('doctor-stats-container');
                    if (statsContainer) {
                        const currentLang = LanguageManager.getLanguage() || 'en';
                        
                        statsContainer.innerHTML = `
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h3 class="stat-number text-primary">${scheduledCount}</h3>
                                        <p class="stat-label">${currentLang === 'ar' ? 'المواعيد القادمة' : 'Upcoming'}</p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h3 class="stat-number text-success">${totalPatients}</h3>
                                        <p class="stat-label">${currentLang === 'ar' ? 'المرضى' : 'Patients'}</p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h3 class="stat-number text-info">${completedCount}</h3>
                                        <p class="stat-label">${currentLang === 'ar' ? 'الاستشارات' : 'Consultations'}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    console.log(`Updated doctor stats - Upcoming: ${scheduledCount}, Patients: ${totalPatients}, Consultations: ${completedCount}`);
                } else {
                    console.warn('Failed to load appointments for stats:', appointmentsResponse.message);
                    // Set default values
                    const statsContainer = document.getElementById('doctor-stats-container');
                    if (statsContainer) {
                        const currentLang = LanguageManager.getLanguage() || 'en';
                        statsContainer.innerHTML = `
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h3 class="stat-number text-primary">0</h3>
                                        <p class="stat-label">${currentLang === 'ar' ? 'المواعيد القادمة' : 'Upcoming'}</p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h3 class="stat-number text-success">0</h3>
                                        <p class="stat-label">${currentLang === 'ar' ? 'المرضى' : 'Patients'}</p>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-item">
                                        <h3 class="stat-number text-info">0</h3>
                                        <p class="stat-label">${currentLang === 'ar' ? 'الاستشارات' : 'Consultations'}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading doctor dashboard stats:', error);
                // Set error state
                const statsContainer = document.getElementById('doctor-stats-container');
                if (statsContainer) {
                    const currentLang = LanguageManager.getLanguage() || 'en';
                    const errorMsg = currentLang === 'ar' ? 'خطأ في تحميل الإحصائيات' : 'Error loading statistics';
                    statsContainer.innerHTML = `
                        <div class="text-center">
                            <p class="text-muted">${errorMsg}</p>
                        </div>
                    `;
                }
            }
        }
        
        // Load waiting patients/pending messages
        async function loadWaitingPatients() {
            console.log('Loading waiting patients/pending messages...');
            
            const container = document.getElementById('waiting-patients-container');
            if (!container) return;
            
            const currentLang = LanguageManager.getLanguage() || 'en';
            
            // Show a helpful message directing to comm-hub since API has CORS issues
            const commHubMsg = currentLang === 'ar' ? 
                'يرجى التحقق من مركز الاتصالات لمراجعة الرسائل' : 
                'Please check the Communication Hub to view messages';
            
            container.innerHTML = `
                <p class="text-muted text-center py-3">
                    <i class="bi bi-chat-dots me-2"></i>${commHubMsg}
                </p>
                <div class="text-center">
                    <button class="btn btn-outline-primary btn-sm" onclick="openCommunicationHub()">
                        <i class="bi bi-chat-text me-1"></i>
                        ${currentLang === 'ar' ? 'فتح مركز الاتصالات' : 'Open Communication Hub'}
                    </button>
                </div>
            `;
        }
        
        // Helper function to get relative time
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return getTimeMessage('just_now');
            if (diffMins < 60) return getTimeMessage('minutes_ago', diffMins);
            if (diffHours < 24) return getTimeMessage('hours_ago', diffHours);
            if (diffDays < 7) return getTimeMessage('days_ago', diffDays);
            return date.toLocaleDateString();
        }
        
        // Refresh doctor dashboard statistics - can be called from other pages
        window.refreshDoctorDashboardStats = function() {
            console.log('Refreshing doctor dashboard statistics...');
            loadDoctorDashboardStats();
            loadWaitingPatients();
        };

        // Initialize doctor dashboard on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Doctor dashboard initializing...');
            // Ensure title is correct from the start
            document.title = 'Doctor Dashboard - Sahatak';
            await DashboardTranslations.initializeDashboard('doctor');
            
            // Initialize video consultation dashboard with retry and refresh
            let retryCount = 0;
            const initVideoConsultationDashboard = () => {
                if (typeof VideoConsultationDashboard !== 'undefined') {
                    VideoConsultationDashboard.init();
                    console.log('VideoConsultationDashboard initialized');
                    
                    // Start automatic status monitoring for video appointments
                    startVideoStatusMonitoring();
                    
                    // Refresh dashboard stats to update buttons
                    setTimeout(() => {
                        loadDoctorDashboardStats();
                    }, 500);
                } else {
                    retryCount++;
                    if (retryCount < 20) { // Max 2 seconds of retries
                        console.log(`VideoConsultationDashboard not yet available, retrying in 100ms... (attempt ${retryCount})`);
                        setTimeout(initVideoConsultationDashboard, 100);
                    } else {
                        console.error('VideoConsultationDashboard failed to load after 20 attempts');
                    }
                }
            };
            initVideoConsultationDashboard();
            
            // Load and update user data including verification status
            const user = AuthGuard.getCurrentUser();
            if (user && user.full_name) {
                // Update user name in header only if we have the actual name
                document.getElementById('user-name').textContent = user.full_name;
                
                // Update verification status from database
                updateVerificationStatus(user);
            } else {
                // Keep showing "Loading..." if user data is not available
                console.log('User data not available yet');
                // For unverified doctors or users without data, disable actions
                disableDashboardActions();
            }
            
            // Try to get fresh user data from API with cache-busting
            try {
                const response = await ApiHelper.makeRequest('/users/profile?t=' + Date.now());
                if (response.success && response.user) {
                    const apiUser = response.user;
                    
                    // Update display elements
                    if (apiUser.full_name) {
                        document.getElementById('user-name').textContent = apiUser.full_name;
                    }
                    
                    // Check doctor profile for verification status
                    let isVerified = false;
                    if (apiUser.profile && apiUser.profile.is_verified !== undefined) {
                        // Use profile verification status if available
                        isVerified = apiUser.profile.is_verified === true;
                        apiUser.is_verified = isVerified; // Set on user object for consistency
                    } else if (apiUser.is_verified !== undefined) {
                        // Fallback to user-level verification
                        isVerified = apiUser.is_verified === true;
                    }
                    
                    console.log('Fresh API data - is_verified:', isVerified, 'API User:', apiUser);
                    
                    // Update verification status with fresh data
                    updateVerificationStatus(apiUser);
                    
                    // Update localStorage for consistency
                    localStorage.setItem('currentUser', JSON.stringify(apiUser));
                    localStorage.setItem('sahatak_doctor_data', JSON.stringify(apiUser));
                }
            } catch (error) {
                console.log('Could not fetch fresh user data:', error);
                // If API call fails, still disable actions for safety
                if (!user || (!user.is_verified && user.verification_status !== 'verified')) {
                    disableDashboardActions();
                }
            }
            
            // Initialize dashboard data loading only if verified
            const finalUser = AuthGuard.getCurrentUser();
            const isVerified = finalUser && (finalUser.is_verified === true || finalUser.verification_status === 'verified');
            
            if (isVerified && window.Dashboard && Dashboard.initialize) {
                await Dashboard.initialize();
            }
            
            // Load dashboard statistics after translations are loaded
            setTimeout(() => {
                loadDoctorDashboardStats();
                loadWaitingPatients();
            }, 1000); // Small delay to ensure API is ready
        });
    </script>
</body>
</html>